<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéß –ó–≤–æ–Ω–∏–ª–∫–∞ (–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ)</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
        
        body {
            background: linear-gradient(135deg, #1a2980, #26d0ce);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 450px;
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 20px;
            font-size: 26px;
        }
        
        input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            margin-bottom: 15px;
        }
        
        .btn-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 15px 0;
        }
        
        button {
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
        }
        
        #createBtn { background: #00C853; color: white; }
        #joinBtn { background: #2979FF; color: white; }
        #callBtn { background: #FF6D00; color: white; grid-column: span 2; }
        #hangupBtn { background: #D50000; color: white; grid-column: span 2; }
        
        button:disabled {
            background: #bdbdbd !important;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .status {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: center;
            min-height: 60px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 5px;
        }
        
        .status.ready { background: #E8F5E9; color: #2E7D32; }
        .status.calling { background: #FFF3E0; color: #EF6C00; }
        .status.connected { background: #E3F2FD; color: #1565C0; }
        
        .connection-info {
            font-size: 12px;
            color: #666;
        }
        
        .log {
            background: #1a1a1a;
            color: #0f0;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            max-width: 400px;
            width: 90%;
        }
        
        .modal-buttons {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }
        
        .modal-buttons button {
            flex: 1;
        }
        
        .accept { background: #00C853; color: white; }
        .reject { background: #D50000; color: white; }
        
        .debug-info {
            font-size: 11px;
            color: #666;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìû –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –ó–≤–æ–Ω–∏–ª–∫–∞</h1>
        
        <input type="text" id="roomId" placeholder="ID –∫–æ–º–Ω–∞—Ç—ã" value="9999">
        
        <div class="btn-group">
            <button id="createBtn" onclick="createRoom()">–°–æ–∑–¥–∞—Ç—å</button>
            <button id="joinBtn" onclick="joinRoom()">–í–æ–π—Ç–∏</button>
        </div>
        
        <div class="status" id="statusBox">
            <div id="statusText">–ì–æ—Ç–æ–≤</div>
            <div id="connectionInfo" class="connection-info"></div>
            <div id="debugInfo" class="debug-info"></div>
        </div>
        
        <div class="btn-group">
            <button id="callBtn" onclick="startCall()" disabled>–ü–æ–∑–≤–æ–Ω–∏—Ç—å</button>
            <button id="hangupBtn" onclick="hangUp()" disabled>–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
        </div>
        
        <div class="log" id="logBox"></div>
    </div>
    
    <div class="modal" id="incomingModal">
        <div class="modal-content">
            <div style="font-size: 50px; margin-bottom: 20px;">üìû</div>
            <h3>–í—Ö–æ–¥—è—â–∏–π –≤—ã–∑–æ–≤!</h3>
            <p>–ö–æ–º–Ω–∞—Ç–∞: <strong id="callRoomId"></strong></p>
            <div class="modal-buttons">
                <button class="accept" onclick="acceptCall()">–ü—Ä–∏–Ω—è—Ç—å</button>
                <button class="reject" onclick="rejectCall()">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="waitingModal">
        <div class="modal-content">
            <div style="font-size: 50px; margin-bottom: 20px;">‚è≥</div>
            <h3>–û–∂–∏–¥–∞–Ω–∏–µ...</h3>
            <p>–ö–æ–º–Ω–∞—Ç–∞: <strong id="waitRoomId"></strong></p>
            <button class="reject" onclick="cancelCall()" style="margin-top: 20px;">–û—Ç–º–µ–Ω–∏—Ç—å</button>
        </div>
    </div>
    
    <div class="modal" id="activeModal">
        <div class="modal-content">
            <div style="font-size: 50px; margin-bottom: 20px;">üéß</div>
            <h3>–†–∞–∑–≥–æ–≤–æ—Ä –∞–∫—Ç–∏–≤–µ–Ω</h3>
            <p>–ö–æ–º–Ω–∞—Ç–∞: <strong id="activeRoomId"></strong></p>
            <div id="callStats" style="margin: 20px 0; font-size: 14px; color: #666;"></div>
            <button class="reject" onclick="hangUp()">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
        </div>
    </div>

    <script>
        // ========== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ==========
        const firebaseConfig = {
            apiKey: "AIzaSyDdlYdrHiGWd73F_pmwMKHrX92gK-G7kB8",
            databaseURL: "https://simple-audio-call-default-rtdb.europe-west1.firebasedatabase.app"
        };

        // ========== –ü–ï–†–ï–ú–ï–ù–ù–´–ï ==========
        let localStream = null;
        let peerConnection = null;
        let database = null;
        let roomRef = null;
        let currentRoomId = null;
        let isCaller = false;
        let callStatus = 'idle'; // idle, calling, ringing, in_call, hanging_up
        let isNegotiating = false;
        let pendingIceCandidates = [];
        let remoteAudio = null;

        // ========== –õ–û–ì–ò–†–û–í–ê–ù–ò–ï ==========
        function log(message, type = 'info') {
            const logBox = document.getElementById('logBox');
            const time = new Date().toLocaleTimeString();
            const colors = {
                'success': '#4CAF50',
                'error': '#f44336',
                'warning': '#FF9800',
                'info': '#2196F3'
            };
            
            const entry = document.createElement('div');
            entry.innerHTML = `<span style="color: #aaa">${time}</span> <span style="color: ${colors[type] || '#0f0'}">${message}</span>`;
            logBox.appendChild(entry);
            logBox.scrollTop = logBox.scrollHeight;
            console.log(`[${type}] ${message}`);
        }

        function updateStatus(text, statusClass = '', connectionInfo = '') {
            document.getElementById('statusText').textContent = text;
            const statusBox = document.getElementById('statusBox');
            statusBox.className = 'status ' + statusClass;
            
            if (connectionInfo) {
                document.getElementById('connectionInfo').textContent = connectionInfo;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏
            document.getElementById('callBtn').disabled = !(currentRoomId && callStatus === 'idle');
            document.getElementById('hangupBtn').disabled = callStatus !== 'in_call';
            
            // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
            document.getElementById('debugInfo').textContent = 
                `–°—Ç–∞—Ç—É—Å: ${callStatus} | –ü–ö: ${peerConnection ? peerConnection.signalingState : '–Ω–µ—Ç'}`;
        }

        // ========== –ö–û–ú–ù–ê–¢–´ ==========
        function createRoom() {
            currentRoomId = document.getElementById('roomId').value.trim();
            if (!currentRoomId) {
                currentRoomId = Math.floor(1000 + Math.random() * 9000).toString();
                document.getElementById('roomId').value = currentRoomId;
            }
            connectToRoom(true);
        }

        function joinRoom() {
            currentRoomId = document.getElementById('roomId').value.trim();
            if (!currentRoomId) {
                alert('–í–≤–µ–¥–∏—Ç–µ ID –∫–æ–º–Ω–∞—Ç—ã');
                return;
            }
            connectToRoom(false);
        }

        function connectToRoom(isCreator) {
            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                database = firebase.database();
                
                isCaller = isCreator;
                
                // –û—Ç–∫–ª—é—á–∞–µ–º —Å—Ç–∞—Ä—ã–π listener
                if (roomRef) {
                    roomRef.off();
                    roomRef = null;
                }
                
                // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ
                roomRef = database.ref(`rooms/${currentRoomId}`);
                
                // –û—á–∏—â–∞–µ–º –µ—Å–ª–∏ —Å–æ–∑–¥–∞–µ–º
                if (isCreator) {
                    roomRef.remove().catch(() => {});
                }
                
                // –°–ª—É—à–∞–µ–º –¢–û–õ–¨–ö–û –Ω—É–∂–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è
                roomRef.on('value', handleRoomUpdate);
                
                updateStatus(`–í –∫–æ–º–Ω–∞—Ç–µ: ${currentRoomId}`, 'ready');
                log(`${isCreator ? '–°–æ–∑–¥–∞–Ω–∞' : '–í—Ö–æ–¥ –≤'} –∫–æ–º–Ω–∞—Ç—É ${currentRoomId}`, 'success');
                
            } catch (error) {
                log(`–û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        }

        // ========== –û–ë–†–ê–ë–û–¢–ö–ê –°–û–ë–´–¢–ò–ô –ö–û–ú–ù–ê–¢–´ ==========
        function handleRoomUpdate(snapshot) {
            const data = snapshot.val();
            if (!data) return;
            
            // –í—Ö–æ–¥—è—â–∏–π –≤—ã–∑–æ–≤
            if (data.callRequest && !isCaller && callStatus === 'idle') {
                showIncomingCall();
            }
            
            // –û—Ç–≤–µ—Ç –Ω–∞ –≤—ã–∑–æ–≤
            if (data.callResponse && callStatus === 'calling') {
                handleCallResponse(data.callResponse);
            }
            
            // WebRTC —Å–∏–≥–Ω–∞–ª—ã - –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –º—ã –≤ –∑–≤–æ–Ω–∫–µ
            if (callStatus === 'in_call') {
                if (data.offer && !isCaller && peerConnection) {
                    handleOffer(data.offer);
                }
                
                if (data.answer && isCaller && peerConnection) {
                    handleAnswer(data.answer);
                }
                
                if (data.iceCandidate && peerConnection) {
                    handleIceCandidate(data.iceCandidate);
                }
            }
            
            // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –≤—ã–∑–æ–≤–∞
            if (data.hangup && callStatus === 'in_call') {
                handleRemoteHangup();
            }
        }

        function showIncomingCall() {
            if (callStatus !== 'idle') return;
            
            document.getElementById('callRoomId').textContent = currentRoomId;
            document.getElementById('incomingModal').style.display = 'flex';
            callStatus = 'ringing';
            updateStatus('–í—Ö–æ–¥—è—â–∏–π –≤—ã–∑–æ–≤!', 'calling');
            log('üìû –í—Ö–æ–¥—è—â–∏–π –≤—ã–∑–æ–≤', 'info');
        }

        // ========== –£–ü–†–ê–í–õ–ï–ù–ò–ï –ó–í–û–ù–ö–ê–ú–ò ==========
        function startCall() {
            if (!currentRoomId || callStatus !== 'idle') return;
            
            callStatus = 'calling';
            document.getElementById('waitRoomId').textContent = currentRoomId;
            document.getElementById('waitingModal').style.display = 'flex';
            
            // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ
            roomRef.update({ 
                callRequest: { time: Date.now() },
                offer: null,
                answer: null,
                iceCandidate: null,
                hangup: null
            });
            
            log('–í—ã–∑—ã–≤–∞—é...', 'info');
        }

        function acceptCall() {
            document.getElementById('incomingModal').style.display = 'none';
            callStatus = 'in_call';
            
            roomRef.update({
                callResponse: { accepted: true, time: Date.now() },
                offer: null,
                answer: null,
                iceCandidate: null
            });
            
            initializeWebRTC(false);
            log('‚úÖ –í—ã–∑–æ–≤ –ø—Ä–∏–Ω—è—Ç', 'success');
        }

        function rejectCall() {
            document.getElementById('incomingModal').style.display = 'none';
            callStatus = 'idle';
            
            roomRef.update({
                callResponse: { accepted: false, time: Date.now() }
            });
            
            updateStatus(`–í –∫–æ–º–Ω–∞—Ç–µ: ${currentRoomId}`, 'ready');
            log('–í—ã–∑–æ–≤ –æ—Ç–∫–ª–æ–Ω–µ–Ω', 'warning');
        }

        function handleCallResponse(response) {
            if (response.accepted) {
                callStatus = 'in_call';
                document.getElementById('waitingModal').style.display = 'none';
                initializeWebRTC(true);
                log('‚úÖ –í—ã–∑–æ–≤ –ø—Ä–∏–Ω—è—Ç –¥—Ä—É–≥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º', 'success');
            } else {
                callStatus = 'idle';
                document.getElementById('waitingModal').style.display = 'none';
                alert('–í—ã–∑–æ–≤ –æ—Ç–∫–ª–æ–Ω–µ–Ω');
                updateStatus(`–í –∫–æ–º–Ω–∞—Ç–µ: ${currentRoomId}`, 'ready');
                log('–í—ã–∑–æ–≤ –æ—Ç–∫–ª–æ–Ω–µ–Ω –¥—Ä—É–≥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º', 'warning');
            }
        }

        function cancelCall() {
            document.getElementById('waitingModal').style.display = 'none';
            callStatus = 'idle';
            roomRef.update({ callRequest: null });
            updateStatus(`–í –∫–æ–º–Ω–∞—Ç–µ: ${currentRoomId}`, 'ready');
            log('–í—ã–∑–æ–≤ –æ—Ç–º–µ–Ω–µ–Ω', 'warning');
        }

        // ========== WEBRTC (–ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô) ==========
        async function initializeWebRTC(isInitiator) {
            try {
                updateStatus('–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∑–≤–æ–Ω–∫–∞...', 'calling');
                
                // –ü–æ–ª—É—á–∞–µ–º –º–∏–∫—Ä–æ—Ñ–æ–Ω
                localStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true,
                        channelCount: 1
                    }
                });
                
                log('üé§ –ú–∏–∫—Ä–æ—Ñ–æ–Ω –ø–æ–¥–∫–ª—é—á–µ–Ω', 'success');
                
                // –°–æ–∑–¥–∞–µ–º PeerConnection
                const config = {
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' },
                        { urls: 'stun:stun2.l.google.com:19302' }
                    ]
                };
                
                peerConnection = new RTCPeerConnection(config);
                pendingIceCandidates = [];
                isNegotiating = false;
                
                // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–∫–∏
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
                
                // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
                setupPeerConnectionHandlers(isInitiator);
                
                // –ï—Å–ª–∏ –º—ã –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä - —Å–æ–∑–¥–∞–µ–º offer
                if (isInitiator) {
                    await createOffer();
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–∫–Ω–æ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∑–≤–æ–Ω–∫–∞
                document.getElementById('activeRoomId').textContent = currentRoomId;
                document.getElementById('activeModal').style.display = 'flex';
                updateStatus('–†–∞–∑–≥–æ–≤–æ—Ä –∞–∫—Ç–∏–≤–µ–Ω', 'connected', '–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ${error.message}`, 'error');
                hangUp();
            }
        }

        function setupPeerConnectionHandlers(isInitiator) {
            // ICE –∫–∞–Ω–¥–∏–¥–∞—Ç—ã
            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    log(`ICE –∫–∞–Ω–¥–∏–¥–∞—Ç: ${event.candidate.type}`, 'info');
                    roomRef.update({ iceCandidate: event.candidate });
                }
            };
            
            // –£–¥–∞–ª–µ–Ω–Ω—ã–π –ø–æ—Ç–æ–∫
            peerConnection.ontrack = (event) => {
                log('üîä –ü–æ–ª—É—á–µ–Ω —É–¥–∞–ª–µ–Ω–Ω—ã–π –∑–≤—É–∫', 'success');
                
                if (!remoteAudio) {
                    remoteAudio = new Audio();
                    remoteAudio.autoplay = true;
                    remoteAudio.volume = 1.0;
                }
                
                const remoteStream = new MediaStream();
                remoteStream.addTrack(event.track);
                remoteAudio.srcObject = remoteStream;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
                setTimeout(() => {
                    if (remoteAudio.duration > 0 && !remoteAudio.paused) {
                        log('‚úÖ –ó–≤—É–∫ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è!', 'success');
                        updateCallStats('–ê—É–¥–∏–æ –∞–∫—Ç–∏–≤–Ω–æ');
                    }
                }, 1000);
            };
            
            // –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
            peerConnection.onconnectionstatechange = () => {
                const state = peerConnection.connectionState;
                log(`–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ: ${state}`, 'info');
                
                if (state === 'connected') {
                    log('üéâ –°–û–ï–î–ò–ù–ï–ù–ò–ï –£–°–¢–ê–ù–û–í–õ–ï–ù–û!', 'success');
                    updateCallStats('–°–æ–µ–¥–∏–Ω–µ–Ω–æ —á–µ—Ä–µ–∑ P2P');
                }
                
                if (state === 'disconnected' || state === 'failed') {
                    log('‚ö†Ô∏è –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ', 'warning');
                }
            };
            
            // ICE —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            peerConnection.oniceconnectionstatechange = () => {
                const state = peerConnection.iceConnectionState;
                log(`ICE: ${state}`, 'info');
                
                if (state === 'connected' || state === 'completed') {
                    updateCallStats('ICE —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
                }
            };
            
            // –°–∏–≥–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (–í–ê–ñ–ù–û –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
            peerConnection.onsignalingstatechange = () => {
                log(`–°–∏–≥–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ: ${peerConnection.signalingState}`, 'info');
            };
        }

        async function createOffer() {
            if (isNegotiating) return;
            
            try {
                isNegotiating = true;
                log('–°–æ–∑–¥–∞—é –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ...', 'info');
                
                const offer = await peerConnection.createOffer({
                    offerToReceiveAudio: true,
                    voiceActivityDetection: true
                });
                
                log(`–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ: ${offer.type}`, 'info');
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
                await peerConnection.setLocalDescription(offer);
                log('–õ–æ–∫–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ', 'info');
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Firebase
                await roomRef.update({ offer: offer });
                log('–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ', 'success');
                
                isNegotiating = false;
                
            } catch (error) {
                isNegotiating = false;
                log(`‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è: ${error.message}`, 'error');
            }
        }

        async function handleOffer(offer) {
            if (!peerConnection || isNegotiating || peerConnection.signalingState !== 'stable') {
                log(`–ü—Ä–æ–ø—É—Å–∫–∞–µ–º offer: —Å–æ—Å—Ç–æ—è–Ω–∏–µ ${peerConnection?.signalingState}`, 'warning');
                return;
            }
            
            try {
                isNegotiating = true;
                log('–ü–æ–ª—É—á–µ–Ω–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ, —Å–æ–∑–¥–∞—é –æ—Ç–≤–µ—Ç...', 'info');
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —É–¥–∞–ª–µ–Ω–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
                await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
                log('–£–¥–∞–ª–µ–Ω–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ', 'info');
                
                // –°–æ–∑–¥–∞–µ–º –æ—Ç–≤–µ—Ç
                const answer = await peerConnection.createAnswer();
                log(`–û—Ç–≤–µ—Ç —Å–æ–∑–¥–∞–Ω: ${answer.type}`, 'info');
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
                await peerConnection.setLocalDescription(answer);
                log('–õ–æ–∫–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ', 'info');
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç
                await roomRef.update({ answer: answer });
                log('–û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω', 'success');
                
                isNegotiating = false;
                
                // –ü—Ä–∏–º–µ–Ω—è–µ–º –æ–∂–∏–¥–∞—é—â–∏–µ ICE –∫–∞–Ω–¥–∏–¥–∞—Ç—ã
                applyPendingIceCandidates();
                
            } catch (error) {
                isNegotiating = false;
                log(`‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è: ${error.message}`, 'error');
                
                // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è - –ø—Ä–æ–±—É–µ–º –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å
                if (error.name === 'InvalidStateError') {
                    log('–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—é —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∏–∑-–∑–∞ –æ—à–∏–±–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è...', 'warning');
                    setTimeout(() => {
                        if (callStatus === 'in_call') {
                            restartWebRTC();
                        }
                    }, 1000);
                }
            }
        }

        async function handleAnswer(answer) {
            if (!peerConnection || peerConnection.signalingState !== 'have-local-offer') {
                log(`–ü—Ä–æ–ø—É—Å–∫–∞–µ–º answer: —Å–æ—Å—Ç–æ—è–Ω–∏–µ ${peerConnection?.signalingState}`, 'warning');
                return;
            }
            
            try {
                log('–ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é...', 'info');
                await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
                log('–û—Ç–≤–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω', 'success');
                
                // –ü—Ä–∏–º–µ–Ω—è–µ–º –æ–∂–∏–¥–∞—é—â–∏–µ ICE –∫–∞–Ω–¥–∏–¥–∞—Ç—ã
                applyPendingIceCandidates();
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—Ç–≤–µ—Ç–∞: ${error.message}`, 'error');
            }
        }

        async function handleIceCandidate(candidate) {
            if (!peerConnection) {
                pendingIceCandidates.push(candidate);
                return;
            }
            
            try {
                await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
                log('ICE –∫–∞–Ω–¥–∏–¥–∞—Ç –¥–æ–±–∞–≤–ª–µ–Ω', 'info');
            } catch (error) {
                log(`–û—à–∏–±–∫–∞ ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–∞: ${error.message}`, 'warning');
            }
        }

        function applyPendingIceCandidates() {
            if (!peerConnection) return;
            
            while (pendingIceCandidates.length > 0) {
                const candidate = pendingIceCandidates.shift();
                peerConnection.addIceCandidate(new RTCIceCandidate(candidate))
                    .catch(err => log(`–û—à–∏–±–∫–∞ –æ—Ç–ª–æ–∂–µ–Ω–Ω–æ–≥–æ ICE: ${err.message}`, 'warning'));
            }
        }

        function restartWebRTC() {
            log('–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—é WebRTC —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ...', 'warning');
            
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            
            if (callStatus === 'in_call') {
                initializeWebRTC(isCaller);
            }
        }

        function updateCallStats(info) {
            document.getElementById('callStats').textContent = info || '–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ';
        }

        function handleRemoteHangup() {
            log('–°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –∑–∞–≤–µ—Ä—à–∏–ª –∑–≤–æ–Ω–æ–∫', 'warning');
            alert('–°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –∑–∞–≤–µ—Ä—à–∏–ª –∑–≤–æ–Ω–æ–∫');
            hangUp();
        }

        // ========== –ó–ê–í–ï–†–®–ï–ù–ò–ï (–ò–°–ü–†–ê–í–õ–ï–ù–ù–û–ï) ==========
        async function hangUp() {
            if (callStatus === 'hanging_up') return;
            
            const oldStatus = callStatus;
            callStatus = 'hanging_up';
            
            log('–ó–∞–≤–µ—Ä—à–∞—é –∑–≤–æ–Ω–æ–∫...', 'warning');
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–∏–≥–Ω–∞–ª –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏
            if (roomRef) {
                try {
                    await roomRef.update({ 
                        hangup: true,
                        callRequest: null,
                        callResponse: null,
                        offer: null,
                        answer: null,
                        iceCandidate: null
                    });
                } catch (error) {
                    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ Firebase –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏
                }
            }
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º PeerConnection
            if (peerConnection) {
                try {
                    peerConnection.close();
                } catch (error) {
                    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –∑–∞–∫—Ä—ã—Ç–∏—è
                }
                peerConnection = null;
            }
            
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —É–¥–∞–ª–µ–Ω–Ω—ã–π –∑–≤—É–∫
            if (remoteAudio) {
                remoteAudio.pause();
                remoteAudio.srcObject = null;
                remoteAudio = null;
            }
            
            // –û—á–∏—â–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
            pendingIceCandidates = [];
            isNegotiating = false;
            
            // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –º–æ–¥–∞–ª–∫–∏
            document.getElementById('incomingModal').style.display = 'none';
            document.getElementById('waitingModal').style.display = 'none';
            document.getElementById('activeModal').style.display = 'none';
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            if (oldStatus === 'idle' || oldStatus === 'ringing' || oldStatus === 'calling') {
                callStatus = 'idle';
                updateStatus(`–í –∫–æ–º–Ω–∞—Ç–µ: ${currentRoomId}`, 'ready');
            } else {
                callStatus = 'idle';
                updateStatus('–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ', '');
            }
            
            log('–ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω', 'info');
        }

        // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
        function init() {
            log('–ó–≤–æ–Ω–∏–ª–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞', 'success');
            updateStatus('–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ', '');
        }

        // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
        window.addEventListener('beforeunload', () => {
            if (callStatus === 'in_call') {
                hangUp();
            }
            
            if (roomRef) {
                roomRef.off();
            }
        });

        window.onload = init;
    </script>
</body>
</html>
