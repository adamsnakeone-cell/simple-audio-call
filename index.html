<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéß –ó–í–û–ù–ò–õ–ö–ê (–†–ê–ë–û–ß–ò–ô –ó–í–£–ö)</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
        body { background: linear-gradient(135deg, #1a2980, #26d0ce); min-height: 100vh; padding: 20px; }
        .container { background: white; border-radius: 15px; padding: 25px; max-width: 500px; margin: 0 auto; }
        h1 { text-align: center; color: #333; margin-bottom: 20px; }
        input { width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 8px; margin-bottom: 15px; font-size: 16px; }
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0; }
        button { padding: 15px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; }
        #createBtn { background: #00C853; color: white; }
        #joinBtn { background: #2979FF; color: white; }
        #callBtn { background: #FF6D00; color: white; grid-column: span 2; }
        #hangupBtn { background: #D50000; color: white; grid-column: span 2; }
        button:disabled { background: #ccc !important; cursor: not-allowed; }
        .status { background: #f5f5f5; padding: 15px; border-radius: 8px; margin: 15px 0; text-align: center; }
        .status.connected { background: #C8E6C9; color: #2E7D32; }
        .log { background: #000; color: #0f0; padding: 15px; border-radius: 8px; margin-top: 20px; font-family: monospace; font-size: 12px; height: 200px; overflow-y: auto; }
        .audio-test { margin: 15px 0; }
        .audio-test button { width: 100%; background: #9C27B0; color: white; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 30px; border-radius: 15px; text-align: center; max-width: 400px; width: 90%; }
        .modal-buttons { display: flex; gap: 15px; margin-top: 25px; }
        .accept { background: #00C853; color: white; }
        .reject { background: #D50000; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéß –ó–í–û–ù–ò–õ–ö–ê (100% –ó–í–£–ö)</h1>
        
        <input type="text" id="roomId" placeholder="ID –∫–æ–º–Ω–∞—Ç—ã" value="7777">
        
        <div class="btn-group">
            <button id="createBtn" onclick="createRoom()">–°–æ–∑–¥–∞—Ç—å</button>
            <button id="joinBtn" onclick="joinRoom()">–í–æ–π—Ç–∏</button>
        </div>
        
        <div class="status" id="statusBox">–ì–æ—Ç–æ–≤</div>
        
        <div class="btn-group">
            <button id="callBtn" onclick="startCall()" disabled>–ü–æ–∑–≤–æ–Ω–∏—Ç—å</button>
            <button id="hangupBtn" onclick="hangUp()" disabled>–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
        </div>
        
        <div class="audio-test">
            <button onclick="testAudio()">üîä –¢–ï–°–¢ –ú–ò–ö–†–û–§–û–ù–ê –ò –î–ò–ù–ê–ú–ò–ö–û–í</button>
        </div>
        
        <div class="log" id="logBox"></div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª–∫–∏ -->
    <div class="modal" id="incomingModal">
        <div class="modal-content">
            <div style="font-size: 50px;">üìû</div>
            <h2>–í–•–û–î–Ø–©–ò–ô –í–´–ó–û–í!</h2>
            <p>ID: <strong id="callRoomId"></strong></p>
            <div class="modal-buttons">
                <button class="accept" onclick="acceptCall()">‚úÖ –ü–†–ò–ù–Ø–¢–¨</button>
                <button class="reject" onclick="rejectCall()">‚ùå –û–¢–ö–õ–û–ù–ò–¢–¨</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="waitingModal">
        <div class="modal-content">
            <div style="font-size: 50px;">‚è≥</div>
            <h2>–û–ñ–ò–î–ê–ù–ò–ï...</h2>
            <p>ID: <strong id="waitRoomId"></strong></p>
            <button class="reject" onclick="cancelCall()">–û—Ç–º–µ–Ω–∏—Ç—å</button>
        </div>
    </div>
    
    <div class="modal" id="activeModal">
        <div class="modal-content">
            <div style="font-size: 50px;">üéß</div>
            <h2>–†–ê–ó–ì–û–í–û–† –ê–ö–¢–ò–í–ï–ù</h2>
            <p>ID: <strong id="activeRoomId"></strong></p>
            <div id="audioInfo" style="margin: 20px 0; color: #666; font-size: 14px;"></div>
            <button class="reject" onclick="hangUp()" style="padding: 15px 30px; font-size: 18px;">
                üìû –ó–ê–í–ï–†–®–ò–¢–¨ –ó–í–û–ù–û–ö
            </button>
            <div style="margin-top: 20px;">
                <button onclick="forcePlayAudio()" style="background: #FF9800; color: white; padding: 10px 20px;">
                    üîÑ –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û –í–ö–õ–Æ–ß–ò–¢–¨ –ó–í–£–ö
                </button>
            </div>
        </div>
    </div>

    <script>
        // ========== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ==========
        const firebaseConfig = {
            apiKey: "AIzaSyDdlYdrHiGWd73F_pmwMKHrX92gK-G7kB8",
            databaseURL: "https://simple-audio-call-default-rtdb.europe-west1.firebasedatabase.app"
        };

        // ========== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ==========
        let localStream = null;
        let peerConnection = null;
        let database = null;
        let roomRef = null;
        let currentRoomId = null;
        let isCaller = false;
        let callStatus = 'idle';
        let remoteAudio = null;
        let remoteStream = null;
        let audioContext = null;

        // ========== –õ–û–ì–ò–†–û–í–ê–ù–ò–ï ==========
        function log(message, type = 'info') {
            const logBox = document.getElementById('logBox');
            const time = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.innerHTML = `<span style="color: #aaa">${time}</span> ${message}`;
            logBox.appendChild(entry);
            logBox.scrollTop = logBox.scrollHeight;
            console.log(message);
        }

        function updateStatus(text) {
            document.getElementById('statusBox').textContent = text;
            document.getElementById('callBtn').disabled = !(currentRoomId && callStatus === 'idle');
            document.getElementById('hangupBtn').disabled = callStatus !== 'in_call';
        }

        // ========== –¢–ï–°–¢ –ê–£–î–ò–û ==========
        async function testAudio() {
            try {
                log('üîä –¢–ï–°–¢–ò–†–£–Æ –ú–ò–ö–†–û–§–û–ù –ò –î–ò–ù–ê–ú–ò–ö–ò...');
                
                // –¢–µ—Å—Ç –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: true 
                });
                
                log('‚úÖ –ú–∏–∫—Ä–æ—Ñ–æ–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç');
                
                // –¢–µ—Å—Ç –¥–∏–Ω–∞–º–∏–∫–æ–≤
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 440;
                gainNode.gain.value = 0.1;
                
                oscillator.start();
                log('üîä –¢–µ—Å—Ç–æ–≤—ã–π –∑–≤—É–∫ –∏–≥—Ä–∞–µ—Ç (–¥–æ–ª–∂–Ω—ã —Å–ª—ã—à–∞—Ç—å —Ç–æ–Ω 440–ì—Ü)');
                
                setTimeout(() => {
                    oscillator.stop();
                    stream.getTracks().forEach(track => track.stop());
                    audioContext.close();
                    log('‚úÖ –¢–ï–°–¢ –ü–†–û–ô–î–ï–ù! –í—Å–µ —Å–∏—Å—Ç–µ–º—ã —Ä–∞–±–æ—Ç–∞—é—Ç');
                    alert('‚úÖ –¢–ï–°–¢ –ü–†–û–ô–î–ï–ù! –ú–∏–∫—Ä–æ—Ñ–æ–Ω –∏ –¥–∏–Ω–∞–º–∏–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç.');
                }, 2000);
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∞: ${error.message}`);
                alert('‚ùå –ü—Ä–æ–±–ª–µ–º–∞ —Å –∞—É–¥–∏–æ! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è.');
            }
        }

        // ========== –ö–û–ú–ù–ê–¢–´ ==========
        function createRoom() {
            currentRoomId = document.getElementById('roomId').value.trim() || '7777';
            document.getElementById('roomId').value = currentRoomId;
            connectToRoom(true);
        }

        function joinRoom() {
            currentRoomId = document.getElementById('roomId').value.trim();
            if (!currentRoomId) {
                alert('–í–≤–µ–¥–∏—Ç–µ ID –∫–æ–º–Ω–∞—Ç—ã');
                return;
            }
            connectToRoom(false);
        }

        function connectToRoom(isCreator) {
            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                database = firebase.database();
                isCaller = isCreator;
                
                if (roomRef) roomRef.off();
                roomRef = database.ref(`rooms/${currentRoomId}`);
                
                if (isCreator) {
                    roomRef.remove().catch(() => {});
                }
                
                roomRef.on('value', handleRoomUpdate);
                updateStatus(`–í –∫–æ–º–Ω–∞—Ç–µ: ${currentRoomId}`);
                log(`‚úì ${isCreator ? '–°–æ–∑–¥–∞–ª' : '–í–æ—à–µ–ª –≤'} –∫–æ–º–Ω–∞—Ç—É ${currentRoomId}`);
                
            } catch (error) {
                log(`–û—à–∏–±–∫–∞: ${error.message}`);
            }
        }

        // ========== –û–ë–†–ê–ë–û–¢–ö–ê –°–û–ë–´–¢–ò–ô ==========
        function handleRoomUpdate(snapshot) {
            const data = snapshot.val();
            if (!data) return;
            
            // –í—Ö–æ–¥—è—â–∏–π –≤—ã–∑–æ–≤
            if (data.callRequest && !isCaller && callStatus === 'idle') {
                showIncomingCall();
            }
            
            // –û—Ç–≤–µ—Ç –Ω–∞ –≤—ã–∑–æ–≤
            if (data.callResponse && callStatus === 'calling') {
                if (data.callResponse.accepted) {
                    callStatus = 'in_call';
                    document.getElementById('waitingModal').style.display = 'none';
                    startWebRTC(true);
                    log('‚úì –í—ã–∑–æ–≤ –ø—Ä–∏–Ω—è—Ç –¥—Ä—É–≥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º');
                } else {
                    callStatus = 'idle';
                    document.getElementById('waitingModal').style.display = 'none';
                    alert('–í—ã–∑–æ–≤ –æ—Ç–∫–ª–æ–Ω–µ–Ω');
                    updateStatus(`–í –∫–æ–º–Ω–∞—Ç–µ: ${currentRoomId}`);
                    log('–í—ã–∑–æ–≤ –æ—Ç–∫–ª–æ–Ω–µ–Ω');
                }
            }
            
            // WebRTC —Å–∏–≥–Ω–∞–ª—ã
            if (callStatus === 'in_call' && peerConnection) {
                if (data.offer && !isCaller) {
                    handleOffer(data.offer);
                }
                
                if (data.answer && isCaller) {
                    handleAnswer(data.answer);
                }
                
                if (data.iceCandidate) {
                    handleIceCandidate(data.iceCandidate);
                }
            }
            
            if (data.hangup) {
                handleRemoteHangup();
            }
        }

        function showIncomingCall() {
            document.getElementById('callRoomId').textContent = currentRoomId;
            document.getElementById('incomingModal').style.display = 'flex';
            callStatus = 'ringing';
            updateStatus('–í–•–û–î–Ø–©–ò–ô –í–´–ó–û–í!');
            log('üìû –í—Ö–æ–¥—è—â–∏–π –≤—ã–∑–æ–≤');
        }

        // ========== –ó–í–û–ù–ö–ò ==========
        function startCall() {
            callStatus = 'calling';
            document.getElementById('waitRoomId').textContent = currentRoomId;
            document.getElementById('waitingModal').style.display = 'flex';
            
            roomRef.update({ 
                callRequest: { time: Date.now() }
            });
            
            log('–í—ã–∑—ã–≤–∞—é...');
        }

        function acceptCall() {
            document.getElementById('incomingModal').style.display = 'none';
            callStatus = 'in_call';
            
            roomRef.update({
                callResponse: { accepted: true, time: Date.now() }
            });
            
            startWebRTC(false);
            log('‚úì –í—ã–∑–æ–≤ –ø—Ä–∏–Ω—è—Ç');
        }

        function rejectCall() {
            document.getElementById('incomingModal').style.display = 'none';
            callStatus = 'idle';
            
            roomRef.update({
                callResponse: { accepted: false, time: Date.now() }
            });
            
            updateStatus(`–í –∫–æ–º–Ω–∞—Ç–µ: ${currentRoomId}`);
            log('–í—ã–∑–æ–≤ –æ—Ç–∫–ª–æ–Ω–µ–Ω');
        }

        function cancelCall() {
            document.getElementById('waitingModal').style.display = 'none';
            callStatus = 'idle';
            roomRef.update({ callRequest: null });
            updateStatus(`–í –∫–æ–º–Ω–∞—Ç–µ: ${currentRoomId}`);
            log('–í—ã–∑–æ–≤ –æ—Ç–º–µ–Ω–µ–Ω');
        }

        // ========== WEBRTC (–£–ü–†–û–©–ï–ù–ù–´–ô) ==========
        async function startWebRTC(isInitiator) {
            try {
                updateStatus('–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞...');
                
                // –ü–æ–ª—É—á–∞–µ–º –º–∏–∫—Ä–æ—Ñ–æ–Ω
                localStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        channelCount: 1,
                        sampleRate: 48000
                    }
                });
                
                log('üé§ –ú–∏–∫—Ä–æ—Ñ–æ–Ω –ø–æ–¥–∫–ª—é—á–µ–Ω');
                
                // –°–æ–∑–¥–∞–µ–º PeerConnection
                const config = {
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' },
                        { urls: 'stun:stun2.l.google.com:19302' }
                    ]
                };
                
                peerConnection = new RTCPeerConnection(config);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π —Ç—Ä–µ–∫
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
                
                // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
                setupPeerConnectionHandlers();
                
                // –ï—Å–ª–∏ –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä - —Å–æ–∑–¥–∞–µ–º offer
                if (isInitiator) {
                    await createOffer();
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∑–≤–æ–Ω–æ–∫
                document.getElementById('activeRoomId').textContent = currentRoomId;
                document.getElementById('activeModal').style.display = 'flex';
                updateStatus('–†–ê–ó–ì–û–í–û–† –ê–ö–¢–ò–í–ï–ù');
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`);
                hangUp();
            }
        }

        function setupPeerConnectionHandlers() {
            // ICE –∫–∞–Ω–¥–∏–¥–∞—Ç—ã
            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    roomRef.update({ iceCandidate: event.candidate });
                }
            };
            
            // –£–î–ê–õ–ï–ù–ù–´–ô –ü–û–¢–û–ö - –°–ê–ú–û–ï –í–ê–ñ–ù–û–ï!
            peerConnection.ontrack = (event) => {
                log('üîä –ü–û–õ–£–ß–ï–ù –£–î–ê–õ–ï–ù–ù–´–ô –ó–í–£–ö!');
                
                if (!remoteStream) {
                    remoteStream = new MediaStream();
                }
                
                remoteStream.addTrack(event.track);
                
                // –°–û–ó–î–ê–ï–ú –ê–£–î–ò–û –≠–õ–ï–ú–ï–ù–¢
                if (!remoteAudio) {
                    remoteAudio = document.createElement('audio');
                    remoteAudio.id = 'remoteAudio';
                    remoteAudio.hidden = true;
                    document.body.appendChild(remoteAudio);
                }
                
                // –ü–†–ò–°–í–ê–ò–í–ê–ï–ú –ü–û–¢–û–ö
                remoteAudio.srcObject = remoteStream;
                remoteAudio.autoplay = true;
                remoteAudio.muted = false;
                remoteAudio.volume = 1.0;
                
                // –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û –ó–ê–ü–£–°–ö–ê–ï–ú –í–û–°–ü–†–û–ò–ó–í–ï–î–ï–ù–ò–ï
                forcePlayAudio();
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á–µ—Ä–µ–∑ —Å–µ–∫—É–Ω–¥—É
                setTimeout(() => {
                    checkAudioPlayback();
                }, 1000);
            };
            
            // –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
            peerConnection.onconnectionstatechange = () => {
                const state = peerConnection.connectionState;
                log(`–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ: ${state}`);
                
                if (state === 'connected') {
                    log('üéâ –°–û–ï–î–ò–ù–ï–ù–ò–ï –£–°–¢–ê–ù–û–í–õ–ï–ù–û!');
                    document.getElementById('audioInfo').textContent = '–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ';
                }
            };
        }

        async function createOffer() {
            try {
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                await roomRef.update({ offer: offer });
                log('–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ');
            } catch (error) {
                log(`–û—à–∏–±–∫–∞: ${error.message}`);
            }
        }

        async function handleOffer(offer) {
            try {
                await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                await roomRef.update({ answer: answer });
                log('–û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω');
            } catch (error) {
                log(`–û—à–∏–±–∫–∞: ${error.message}`);
            }
        }

        async function handleAnswer(answer) {
            try {
                await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
                log('–û—Ç–≤–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
            } catch (error) {
                log(`–û—à–∏–±–∫–∞: ${error.message}`);
            }
        }

        async function handleIceCandidate(candidate) {
            try {
                if (peerConnection.remoteDescription) {
                    await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
                }
            } catch (error) {
                // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º
            }
        }

        // ========== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ó–í–£–ö–ê ==========
        function forcePlayAudio() {
            log('üîä –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û –ó–ê–ü–£–°–ö–ê–Æ –ó–í–£–ö...');
            
            const audio = document.getElementById('remoteAudio');
            if (!audio) return;
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ—Ç–æ–∫
            if (remoteStream) {
                audio.srcObject = remoteStream;
            }
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
            audio.autoplay = true;
            audio.muted = false;
            audio.volume = 1.0;
            
            // –ü—Ä–æ–±—É–µ–º –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏
            const playPromise = audio.play();
            
            if (playPromise !== undefined) {
                playPromise.catch(error => {
                    log(`‚ùå –ê–≤—Ç–æ–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ: ${error.message}`);
                    log('üëâ –ù–ê–ñ–ú–ò–¢–ï –ö–ù–û–ü–ö–£ "–ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û –í–ö–õ–Æ–ß–ò–¢–¨ –ó–í–£–ö"');
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    document.getElementById('audioInfo').innerHTML = 
                        '‚ùå –ê–≤—Ç–æ–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ –±—Ä–∞—É–∑–µ—Ä–æ–º.<br>' +
                        'üëâ –ù–ê–ñ–ú–ò–¢–ï –ö–ù–û–ü–ö–£ "–ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û –í–ö–õ–Æ–ß–ò–¢–¨ –ó–í–£–ö" –í–ù–ò–ó–£';
                });
            }
        }

        function checkAudioPlayback() {
            const audio = document.getElementById('remoteAudio');
            if (!audio) {
                log('‚ùå –ê—É–¥–∏–æ —ç–ª–µ–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return;
            }
            
            log(`üìä –ü—Ä–æ–≤–µ—Ä—è—é –∞—É–¥–∏–æ: duration=${audio.duration}, paused=${audio.paused}, volume=${audio.volume}`);
            
            if (audio.duration > 0 && !audio.paused) {
                log('‚úÖ –ó–í–£–ö –í–û–°–ü–†–û–ò–ó–í–û–î–ò–¢–°–Ø!');
                document.getElementById('audioInfo').textContent = '‚úÖ –ó–í–£–ö –†–ê–ë–û–¢–ê–ï–¢! –ì–æ–≤–æ—Ä–∏—Ç–µ!';
            } else {
                log('‚ö†Ô∏è –ó–≤—É–∫ –Ω–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è, –Ω—É–∂–Ω–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º');
                document.getElementById('audioInfo').innerHTML = 
                    '‚ö†Ô∏è –ë—Ä–∞—É–∑–µ—Ä –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –∞–≤—Ç–æ–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ.<br>' +
                    '–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è –∑–≤—É–∫–∞';
            }
        }

        function handleRemoteHangup() {
            alert('–°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –∑–∞–≤–µ—Ä—à–∏–ª –∑–≤–æ–Ω–æ–∫');
            hangUp();
        }

        // ========== –ó–ê–í–ï–†–®–ï–ù–ò–ï ==========
        function hangUp() {
            log('–ó–∞–≤–µ—Ä—à–∞—é –∑–≤–æ–Ω–æ–∫...');
            
            if (roomRef) {
                roomRef.update({ hangup: true }).catch(() => {});
            }
            
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            
            if (remoteStream) {
                remoteStream.getTracks().forEach(track => track.stop());
                remoteStream = null;
            }
            
            if (remoteAudio) {
                remoteAudio.pause();
                remoteAudio.srcObject = null;
                remoteAudio.remove();
                remoteAudio = null;
            }
            
            // –°–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫–∏
            document.getElementById('incomingModal').style.display = 'none';
            document.getElementById('waitingModal').style.display = 'none';
            document.getElementById('activeModal').style.display = 'none';
            
            if (currentRoomId) {
                updateStatus(`–í –∫–æ–º–Ω–∞—Ç–µ: ${currentRoomId}`);
            } else {
                updateStatus('–ì–æ—Ç–æ–≤');
            }
            
            callStatus = 'idle';
            log('–ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω');
        }

        // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
        function init() {
            log('‚úÖ –ó–≤–æ–Ω–∏–ª–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
            updateStatus('–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ');
        }

        window.addEventListener('beforeunload', () => {
            if (callStatus === 'in_call') hangUp();
            if (roomRef) roomRef.off();
        });

        window.onload = init;
    </script>
</body>
</html>
