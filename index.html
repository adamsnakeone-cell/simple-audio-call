<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéß –ó–≤–æ–Ω–∏–ª–∫–∞ (–†–ê–ë–û–¢–ê–ï–¢ –Ω–∞ —Ä–∞–∑–Ω—ã—Ö —Å–µ—Ç—è—Ö)</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
        body { background: #2c3e50; min-height: 100vh; padding: 20px; display: flex; justify-content: center; align-items: center; }
        .container { background: white; border-radius: 15px; padding: 25px; width: 100%; max-width: 500px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        h1 { text-align: center; margin-bottom: 20px; color: #2c3e50; }
        input { width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; margin-bottom: 15px; }
        .buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0; }
        button { padding: 15px; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; transition: 0.3s; font-weight: bold; }
        #createBtn { background: #27ae60; color: white; }
        #joinBtn { background: #3498db; color: white; }
        #callBtn { background: #e67e22; color: white; grid-column: span 2; }
        #hangupBtn { background: #e74c3c; color: white; grid-column: span 2; }
        button:disabled { background: #95a5a6 !important; cursor: not-allowed; }
        .status { background: #ecf0f1; padding: 15px; border-radius: 8px; margin: 15px 0; text-align: center; min-height: 60px; display: flex; flex-direction: column; justify-content: center; }
        .status.ready { background: #d5f4e6; color: #27ae60; }
        .status.calling { background: #ffeaa7; color: #e67e22; }
        .status.connected { background: #d6eaf8; color: #2980b9; }
        .log { background: #1a1a1a; color: #2ecc71; padding: 15px; border-radius: 8px; margin-top: 20px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 30px; border-radius: 15px; text-align: center; max-width: 400px; width: 90%; }
        .modal-buttons { display: flex; gap: 15px; margin-top: 25px; }
        .modal-buttons button { flex: 1; }
        .accept { background: #27ae60; color: white; }
        .reject { background: #e74c3c; color: white; }
        .ice-state { margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 8px; font-size: 12px; }
        .connection-info { font-size: 11px; color: #666; margin-top: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéß –ó–≤–æ–Ω–∏–ª–∫–∞ (–†–ê–ë–û–¢–ê–ï–¢ –Ω–∞ —Ä–∞–∑–Ω—ã—Ö —Å–µ—Ç—è—Ö)</h1>
        
        <input type="text" id="roomId" placeholder="ID –∫–æ–º–Ω–∞—Ç—ã" value="8888">
        
        <div class="buttons">
            <button id="createBtn" onclick="createRoom()">–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
            <button id="joinBtn" onclick="joinRoom()">–í–æ–π—Ç–∏ –≤ –∫–æ–º–Ω–∞—Ç—É</button>
        </div>
        
        <div class="status" id="statusBox">
            <div id="statusText">–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ</div>
            <div id="connectionInfo" class="connection-info"></div>
            <div id="iceInfo" class="connection-info"></div>
        </div>
        
        <div class="ice-state">
            <div>ICE —Å–æ—Å—Ç–æ—è–Ω–∏–µ: <span id="iceState">-</span></div>
            <div>–¢–∏–ø —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: <span id="connType">-</span></div>
            <div>–ö–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ ICE: <span id="iceCount">0</span></div>
        </div>
        
        <div class="buttons">
            <button id="callBtn" onclick="startCall()" disabled>üìû –ù–∞—á–∞—Ç—å –∑–≤–æ–Ω–æ–∫</button>
            <button id="hangupBtn" onclick="hangUp()" disabled>‚ùå –ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–≤–æ–Ω–æ–∫</button>
        </div>
        
        <div style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
            <label>
                <input type="checkbox" id="forceRelay" checked>
                –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å TURN-—Å–µ—Ä–≤–µ—Ä—ã (–¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Å–µ—Ç–µ–π)
            </label>
        </div>
        
        <div class="log" id="logBox"></div>
    </div>
    
    <div class="modal" id="incomingModal">
        <div class="modal-content">
            <div style="font-size: 50px; margin-bottom: 20px;">üìû</div>
            <h3>–í–•–û–î–Ø–©–ò–ô –í–´–ó–û–í!</h3>
            <p>–ö–æ–º–Ω–∞—Ç–∞: <strong id="callRoomId"></strong></p>
            <div class="modal-buttons">
                <button class="accept" onclick="acceptCall()">‚úÖ –ü–†–ò–ù–Ø–¢–¨</button>
                <button class="reject" onclick="rejectCall()">‚ùå –û–¢–ö–õ–û–ù–ò–¢–¨</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="waitingModal">
        <div class="modal-content">
            <div style="font-size: 50px; margin-bottom: 20px;">‚è≥</div>
            <h3>–û–∂–∏–¥–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞...</h3>
            <p>–ö–æ–º–Ω–∞—Ç–∞: <strong id="waitRoomId"></strong></p>
            <div id="candidateInfo" style="margin: 10px 0; font-size: 12px; color: #666;"></div>
            <button class="reject" onclick="cancelCall()" style="margin-top: 20px;">–û—Ç–º–µ–Ω–∏—Ç—å</button>
        </div>
    </div>
    
    <div class="modal" id="activeModal">
        <div class="modal-content">
            <div style="font-size: 50px; margin-bottom: 20px;">üéß</div>
            <h3>–†–ê–ó–ì–û–í–û–† –ê–ö–¢–ò–í–ï–ù</h3>
            <p>–ö–æ–º–Ω–∞—Ç–∞: <strong id="activeRoomId"></strong></p>
            <div id="callInfo" style="margin: 20px 0; color: #666;"></div>
            <div style="margin: 10px 0; padding: 10px; background: #f1f1f1; border-radius: 5px;">
                <div>–¢–∏–ø —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: <strong id="activeConnType">–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è...</strong></div>
                <div>–°–æ—Å—Ç–æ—è–Ω–∏–µ ICE: <strong id="activeIceState">—Å–æ–±–∏—Ä–∞–µ–º –∫–∞–Ω–¥–∏–¥–∞—Ç—ã...</strong></div>
            </div>
            <button onclick="toggleMute()" id="muteBtn" style="margin: 10px; padding: 10px; background: #34495e; color: white;">
                üîá –í—ã–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω
            </button>
            <button class="reject" onclick="hangUp()">üìû –ó–ê–í–ï–†–®–ò–¢–¨</button>
        </div>
    </div>

    <script>
        // ========== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ==========
        const firebaseConfig = {
            apiKey: "AIzaSyDdlYdrHiGWd73F_pmwMKHrX92gK-G7kB8",
            databaseURL: "https://simple-audio-call-default-rtdb.europe-west1.firebasedatabase.app"
        };

        // ========== –ü–ï–†–ï–ú–ï–ù–ù–´–ï ==========
        let localStream = null;
        let remoteStream = null;
        let peerConnection = null;
        let database = null;
        let roomRef = null;
        let currentRoomId = null;
        let isCaller = false;
        let callStatus = 'idle';
        let pendingIceCandidates = [];
        let remoteAudio = null;
        let microphoneMuted = false;
        let iceCandidatesCount = 0;
        let iceGatheringTimeout = null;
        let connectionAttempts = 0;
        const MAX_CONNECTION_ATTEMPTS = 3;

        // –ü—É–±–ª–∏—á–Ω—ã–µ STUN/TURN —Å–µ—Ä–≤–µ—Ä—ã
        const iceServers = {
            stun: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
                { urls: 'stun:stun2.l.google.com:19302' },
                { urls: 'stun:stun3.l.google.com:19302' },
                { urls: 'stun:stun4.l.google.com:19302' }
            ],
            turn: [
                {
                    urls: [
                        'turn:openrelay.metered.ca:80',
                        'turn:openrelay.metered.ca:443',
                        'turn:openrelay.metered.ca:443?transport=tcp'
                    ],
                    username: 'openrelayproject',
                    credential: 'openrelayproject'
                },
                {
                    urls: [
                        'turn:freeturn.net:3478',
                        'turn:freeturn.net:3478?transport=tcp'
                    ],
                    username: 'free',
                    credential: 'free'
                },
                {
                    urls: [
                        'turn:relay.metered.ca:80',
                        'turn:relay.metered.ca:443',
                        'turn:relay.metered.ca:443?transport=tcp'
                    ],
                    username: 'a6c98228ac6d633ec966c8ae',
                    credential: 'vDz54T0EmLplI5wM'
                }
            ]
        };

        // ========== –õ–û–ì–ò–†–û–í–ê–ù–ò–ï ==========
        function log(message, type = 'info') {
            const logBox = document.getElementById('logBox');
            const time = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.innerHTML = `<span style="color: #95a5a6">${time}</span> ${message}`;
            logBox.appendChild(entry);
            logBox.scrollTop = logBox.scrollHeight;
            console.log(`[${type}] ${message}`);
        }

        function updateStatus(text, statusClass = '', info = '') {
            document.getElementById('statusText').textContent = text;
            document.getElementById('statusBox').className = 'status ' + statusClass;
            if (info) document.getElementById('connectionInfo').textContent = info;
            
            document.getElementById('callBtn').disabled = !(currentRoomId && callStatus === 'idle');
            document.getElementById('hangupBtn').disabled = callStatus !== 'in_call';
        }

        function updateIceInfo(text) {
            document.getElementById('iceInfo').textContent = text;
        }

        // ========== –ö–û–ú–ù–ê–¢–´ ==========
        function createRoom() {
            currentRoomId = document.getElementById('roomId').value.trim() || '8888';
            document.getElementById('roomId').value = currentRoomId;
            connectToRoom(true);
        }

        function joinRoom() {
            currentRoomId = document.getElementById('roomId').value.trim();
            if (!currentRoomId) {
                alert('–í–≤–µ–¥–∏—Ç–µ ID –∫–æ–º–Ω–∞—Ç—ã');
                return;
            }
            connectToRoom(false);
        }

        function connectToRoom(isCreator) {
            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                database = firebase.database();
                
                isCaller = isCreator;
                
                if (roomRef) roomRef.off();
                roomRef = database.ref(`rooms/${currentRoomId}`);
                
                if (isCreator) {
                    roomRef.remove().catch(() => {});
                }
                
                roomRef.on('value', handleRoomUpdate);
                
                updateStatus(`–í –∫–æ–º–Ω–∞—Ç–µ: ${currentRoomId}`, 'ready');
                log(`${isCreator ? '–°–æ–∑–¥–∞–Ω–∞' : '–í–æ—à–ª–∏ –≤'} –∫–æ–º–Ω–∞—Ç—É ${currentRoomId}`);
                
            } catch (error) {
                log(`–û—à–∏–±–∫–∞: ${error.message}`);
            }
        }

        // ========== –û–ë–†–ê–ë–û–¢–ö–ê –°–û–ë–´–¢–ò–ô ==========
        function handleRoomUpdate(snapshot) {
            const data = snapshot.val();
            if (!data) return;
            
            if (data.callRequest && !isCaller && callStatus === 'idle') {
                showIncomingCall();
            }
            
            if (data.callResponse && callStatus === 'calling') {
                handleCallResponse(data.callResponse);
            }
            
            if (callStatus === 'in_call' && peerConnection) {
                if (data.offer && !peerConnection.remoteDescription) {
                    handleOffer(data.offer);
                }
                
                if (data.answer && !peerConnection.remoteDescription) {
                    handleAnswer(data.answer);
                }
                
                if (data.iceCandidate) {
                    handleIceCandidate(data.iceCandidate);
                }
            }
            
            if (data.hangup) {
                handleRemoteHangup();
            }
        }

        function showIncomingCall() {
            document.getElementById('callRoomId').textContent = currentRoomId;
            document.getElementById('incomingModal').style.display = 'flex';
            callStatus = 'ringing';
            updateStatus('–í—Ö–æ–¥—è—â–∏–π –≤—ã–∑–æ–≤!', 'calling');
            log('üìû –í—Ö–æ–¥—è—â–∏–π –≤—ã–∑–æ–≤');
        }

        // ========== –£–ü–†–ê–í–õ–ï–ù–ò–ï –ó–í–û–ù–ö–ê–ú–ò ==========
        function startCall() {
            callStatus = 'calling';
            connectionAttempts = 0;
            document.getElementById('waitRoomId').textContent = currentRoomId;
            document.getElementById('waitingModal').style.display = 'flex';
            
            roomRef.update({ 
                callRequest: { time: Date.now() },
                offer: null,
                answer: null,
                iceCandidate: null,
                hangup: null
            });
            
            log('–í—ã–∑—ã–≤–∞—é...');
        }

        function acceptCall() {
            document.getElementById('incomingModal').style.display = 'none';
            callStatus = 'in_call';
            
            roomRef.update({
                callResponse: { accepted: true, time: Date.now() }
            });
            
            startWebRTC(false);
            log('‚úÖ –í—ã–∑–æ–≤ –ø—Ä–∏–Ω—è—Ç');
        }

        function rejectCall() {
            document.getElementById('incomingModal').style.display = 'none';
            callStatus = 'idle';
            
            roomRef.update({
                callResponse: { accepted: false, time: Date.now() }
            });
            
            updateStatus(`–í –∫–æ–º–Ω–∞—Ç–µ: ${currentRoomId}`, 'ready');
            log('–í—ã–∑–æ–≤ –æ—Ç–∫–ª–æ–Ω–µ–Ω');
        }

        function handleCallResponse(response) {
            if (response.accepted) {
                callStatus = 'in_call';
                document.getElementById('waitingModal').style.display = 'none';
                startWebRTC(true);
                log('‚úÖ –í—ã–∑–æ–≤ –ø—Ä–∏–Ω—è—Ç –¥—Ä—É–≥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º');
            } else {
                callStatus = 'idle';
                document.getElementById('waitingModal').style.display = 'none';
                alert('–í—ã–∑–æ–≤ –æ—Ç–∫–ª–æ–Ω–µ–Ω');
                updateStatus(`–í –∫–æ–º–Ω–∞—Ç–µ: ${currentRoomId}`, 'ready');
                log('–í—ã–∑–æ–≤ –æ—Ç–∫–ª–æ–Ω–µ–Ω –¥—Ä—É–≥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º');
            }
        }

        function cancelCall() {
            document.getElementById('waitingModal').style.display = 'none';
            callStatus = 'idle';
            roomRef.update({ callRequest: null });
            updateStatus(`–í –∫–æ–º–Ω–∞—Ç–µ: ${currentRoomId}`, 'ready');
            log('–í—ã–∑–æ–≤ –æ—Ç–º–µ–Ω–µ–Ω');
        }

        // ========== WEBRTC –° TURN –°–ï–†–í–ï–†–ê–ú–ò ==========
        async function startWebRTC(isInitiator) {
            try {
                updateStatus('–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∑–≤–æ–Ω–∫–∞...', 'calling');
                
                // –ü–æ–ª—É—á–∞–µ–º –º–∏–∫—Ä–æ—Ñ–æ–Ω
                localStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true,
                        channelCount: 1,
                        sampleRate: 48000
                    }
                });
                
                log('üé§ –ú–∏–∫—Ä–æ—Ñ–æ–Ω –ø–æ–¥–∫–ª—é—á–µ–Ω');
                
                // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º ICE —Å–µ—Ä–≤–µ—Ä—ã
                const useTurn = document.getElementById('forceRelay').checked;
                const servers = [...iceServers.stun];
                if (useTurn) {
                    servers.push(...iceServers.turn);
                    log('üöÄ –ò—Å–ø–æ–ª—å–∑—É—é TURN —Å–µ—Ä–≤–µ—Ä—ã –¥–ª—è —Å–≤—è–∑–∏ —á–µ—Ä–µ–∑ NAT');
                } else {
                    log('‚ö° –ò—Å–ø–æ–ª—å–∑—É—é —Ç–æ–ª—å–∫–æ STUN (P2P)');
                }
                
                const config = {
                    iceServers: servers,
                    iceTransportPolicy: useTurn ? 'relay' : 'all',
                    iceCandidatePoolSize: 10,
                    bundlePolicy: 'max-bundle',
                    rtcpMuxPolicy: 'require'
                };
                
                log(`–ù–∞—Å—Ç—Ä–æ–π–∫–∏ ICE: ${useTurn ? 'TURN forced' : 'STUN only'}`);
                
                peerConnection = new RTCPeerConnection(config);
                pendingIceCandidates = [];
                iceCandidatesCount = 0;
                
                // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π —Ç—Ä–µ–∫
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
                
                // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
                setupPeerConnectionHandlers();
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä —Å–±–æ—Ä–∞ ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
                startIceGatheringTimer();
                
                // –ï—Å–ª–∏ –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä - —Å–æ–∑–¥–∞–µ–º offer
                if (isInitiator) {
                    setTimeout(() => createOffer(), 1000); // –î–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ —Å–±–æ—Ä –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∑–≤–æ–Ω–æ–∫
                document.getElementById('activeRoomId').textContent = currentRoomId;
                document.getElementById('activeModal').style.display = 'flex';
                updateStatus('–†–∞–∑–≥–æ–≤–æ—Ä –∞–∫—Ç–∏–≤–µ–Ω', 'connected', '–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ...');
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`);
                hangUp();
            }
        }

        function startIceGatheringTimer() {
            if (iceGatheringTimeout) clearTimeout(iceGatheringTimeout);
            
            iceGatheringTimeout = setTimeout(() => {
                if (peerConnection && peerConnection.iceGatheringState !== 'complete') {
                    log('‚ö†Ô∏è –°–±–æ—Ä ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –∑–∞–Ω–∏–º–∞–µ—Ç —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏');
                    log(`–°–æ–±—Ä–∞–Ω–æ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤: ${iceCandidatesCount}`);
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å
                    document.getElementById('candidateInfo').textContent = 
                        `–°–æ–±—Ä–∞–Ω–æ ${iceCandidatesCount} ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤...`;
                }
            }, 5000);
        }

        function setupPeerConnectionHandlers() {
            // ICE –∫–∞–Ω–¥–∏–¥–∞—Ç—ã
            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    iceCandidatesCount++;
                    document.getElementById('iceCount').textContent = iceCandidatesCount;
                    
                    const candidateType = getCandidateType(event.candidate);
                    const protocol = event.candidate.protocol || 'unknown';
                    
                    log(`‚ùÑÔ∏è ICE #${iceCandidatesCount}: ${candidateType} (${protocol})`);
                    
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–∞–Ω–¥–∏–¥–∞—Ç –≤ Firebase
                    roomRef.update({ iceCandidate: event.candidate }).catch(() => {});
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ UI
                    document.getElementById('iceState').textContent = peerConnection.iceConnectionState;
                    document.getElementById('connType').textContent = candidateType;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞—Ö –≤ –æ–∂–∏–¥–∞–Ω–∏–∏
                    if (document.getElementById('waitingModal').style.display !== 'none') {
                        document.getElementById('candidateInfo').textContent = 
                            `–ù–∞–π–¥–µ–Ω–æ ${iceCandidatesCount} –º–∞—Ä—à—Ä—É—Ç–æ–≤...`;
                    }
                } else {
                    log('‚úÖ –°–±–æ—Ä ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω');
                    if (iceGatheringTimeout) clearTimeout(iceGatheringTimeout);
                }
            };
            
            // –£–¥–∞–ª–µ–Ω–Ω—ã–π –ø–æ—Ç–æ–∫
            peerConnection.ontrack = (event) => {
                log('üîä –ü–æ–ª—É—á–µ–Ω —É–¥–∞–ª–µ–Ω–Ω—ã–π –∑–≤—É–∫–æ–≤–æ–π –ø–æ—Ç–æ–∫!');
                
                if (!remoteStream) {
                    remoteStream = new MediaStream();
                }
                
                if (event.streams && event.streams[0]) {
                    remoteStream = event.streams[0];
                } else {
                    remoteStream.addTrack(event.track);
                }
                
                // –°–æ–∑–¥–∞–µ–º –∞—É–¥–∏–æ —ç–ª–µ–º–µ–Ω—Ç
                if (!remoteAudio) {
                    remoteAudio = new Audio();
                    remoteAudio.autoplay = true;
                    remoteAudio.volume = 1.0;
                }
                
                remoteAudio.srcObject = remoteStream;
                
                // –ü—ã—Ç–∞–µ–º—Å—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏
                const playPromise = remoteAudio.play();
                if (playPromise !== undefined) {
                    playPromise.catch(error => {
                        log(`‚ö†Ô∏è –ê–≤—Ç–æ–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ: ${error.message}`);
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∑–≤—É–∫–∞
                        document.getElementById('callInfo').innerHTML = 
                            '<button onclick="unmuteAudio()" style="padding: 10px; background: #27ae60; color: white;">‚ñ∂Ô∏è –í–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫</button>';
                    });
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–≤—É–∫ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
                setTimeout(() => {
                    if (remoteAudio && remoteAudio.duration > 0 && !remoteAudio.paused) {
                        log('‚úÖ –ó–í–£–ö –†–ê–ë–û–¢–ê–ï–¢!');
                        updateConnectionInfo('connected');
                        document.getElementById('callInfo').textContent = '‚úÖ –ó–≤—É–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç! –ú–æ–∂–µ—Ç–µ –≥–æ–≤–æ—Ä–∏—Ç—å.';
                        
                        // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –≥—Ä–æ–º–∫–æ—Å—Ç—å
                        remoteAudio.volume = 1.0;
                    }
                }, 3000);
            };
            
            // –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è ICE
            peerConnection.oniceconnectionstatechange = () => {
                const state = peerConnection.iceConnectionState;
                log(`üßä ICE —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ: ${state}`);
                
                document.getElementById('iceState').textContent = state;
                document.getElementById('activeIceState').textContent = state;
                
                if (state === 'connected' || state === 'completed') {
                    log('üéâ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ —á–µ—Ä–µ–∑ ' + getCurrentConnectionType());
                    updateConnectionInfo('connected');
                }
                
                if (state === 'failed' || state === 'disconnected') {
                    log('‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º—ã —Å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ–º');
                    
                    if (state === 'failed' && connectionAttempts < MAX_CONNECTION_ATTEMPTS) {
                        connectionAttempts++;
                        log(`üîÑ –ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è ${connectionAttempts}/${MAX_CONNECTION_ATTEMPTS}`);
                        
                        setTimeout(() => {
                            if (callStatus === 'in_call') {
                                restartIce();
                            }
                        }, 1000);
                    }
                }
            };
            
            // –û–±—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
            peerConnection.onconnectionstatechange = () => {
                const state = peerConnection.connectionState;
                log(`üîó –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ${state}`);
                
                if (state === 'connected') {
                    log('üéä PeerConnection —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!');
                    updateConnectionInfo('fully_connected');
                }
            };
            
            // –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏–≥–Ω–∞–ª–∏–Ω–≥–∞
            peerConnection.onsignalingstatechange = () => {
                log(`üì° –°–∏–≥–Ω–∞–ª–∏–Ω–≥: ${peerConnection.signalingState}`);
            };
        }

        function getCandidateType(candidate) {
            const candidateStr = candidate.candidate.toLowerCase();
            
            if (candidateStr.includes('relay')) return 'TURN (—Ä–µ–ª–µ–π–Ω—ã–π)';
            if (candidateStr.includes('srflx')) return 'STUN (–æ—Ç—Ä–∞–∂–µ–Ω–Ω—ã–π)';
            if (candidateStr.includes('host')) return '–õ–æ–∫–∞–ª—å–Ω—ã–π (host)';
            if (candidateStr.includes('prflx')) return 'Peer reflexive';
            
            return '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π';
        }

        function getCurrentConnectionType() {
            if (!peerConnection) return '–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è';
            
            const stats = peerConnection.getStats();
            stats.then(report => {
                report.forEach(stat => {
                    if (stat.type === 'candidate-pair' && stat.nominated) {
                        const localCandidate = report.get(stat.localCandidateId);
                        const remoteCandidate = report.get(stat.remoteCandidateId);
                        
                        if (localCandidate && remoteCandidate) {
                            const type = getCandidateType({ candidate: localCandidate.candidate });
                            document.getElementById('activeConnType').textContent = type;
                            document.getElementById('connType').textContent = type;
                            return type;
                        }
                    }
                });
            });
            
            return '–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è...';
        }

        function updateConnectionInfo(state) {
            let info = '';
            let activeInfo = '';
            
            switch(state) {
                case 'connected':
                    info = 'P2P —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ';
                    activeInfo = '‚úÖ –ü—Ä—è–º–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ (P2P)';
                    break;
                case 'fully_connected':
                    info = '–ü–æ–ª–Ω–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ';
                    activeInfo = '‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ';
                    break;
                case 'relay':
                    info = '–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ä–µ–ª–µ–π–Ω—ã–π —Å–µ—Ä–≤–µ—Ä (TURN)';
                    activeInfo = 'üîÑ –ß–µ—Ä–µ–∑ TURN-—Å–µ—Ä–≤–µ—Ä';
                    break;
                default:
                    info = '–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ...';
                    activeInfo = '‚è≥ –°–æ–µ–¥–∏–Ω—è–µ–º—Å—è...';
            }
            
            document.getElementById('connectionInfo').textContent = info;
            document.getElementById('callInfo').innerHTML = activeInfo;
        }

        async function createOffer() {
            try {
                log('–°–æ–∑–¥–∞—é –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ (offer)...');
                
                // –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ –¥–ª—è —Å–±–æ—Ä–∞ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                const offerOptions = {
                    offerToReceiveAudio: true,
                    offerToReceiveVideo: false,
                    voiceActivityDetection: true
                };
                
                const offer = await peerConnection.createOffer(offerOptions);
                log(`‚úÖ –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ`);
                
                // –û–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ–º SDP –¥–ª—è –∞—É–¥–∏–æ
                const updatedOffer = optimizeSDP(offer.sdp);
                
                await peerConnection.setLocalDescription({
                    type: 'offer',
                    sdp: updatedOffer
                });
                
                log('–õ–æ–∫–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Firebase
                await roomRef.update({ 
                    offer: {
                        type: 'offer',
                        sdp: updatedOffer
                    }
                });
                
                log('–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Firebase');
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è: ${error.message}`);
            }
        }

        function optimizeSDP(sdp) {
            // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –¥–ª—è –∫–æ–¥–µ–∫–∞ Opus
            sdp = sdp.replace(/a=fmtp:111/, 'a=fmtp:111 minptime=10; useinbandfec=1; stereo=0');
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∞—Ç—Ä–∏–±—É—Ç—ã –¥–ª—è –ª—É—á—à–µ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
            sdp += '\r\na=rtcp-fb:* nack\r\n';
            sdp += 'a=rtcp-fb:* nack pli\r\n';
            sdp += 'a=rtcp-fb:* goog-remb\r\n';
            
            return sdp;
        }

        async function handleOffer(offer) {
            try {
                log('–ü–æ–ª—É—á–µ–Ω–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ, —Å–æ–∑–¥–∞—é –æ—Ç–≤–µ—Ç...');
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —É–¥–∞–ª–µ–Ω–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
                await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
                log('‚úÖ –£–¥–∞–ª–µ–Ω–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
                
                // –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –æ—Ç–≤–µ—Ç–∞
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // –°–æ–∑–¥–∞–µ–º –æ—Ç–≤–µ—Ç
                const answer = await peerConnection.createAnswer();
                log(`‚úÖ –û—Ç–≤–µ—Ç —Å–æ–∑–¥–∞–Ω`);
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
                await peerConnection.setLocalDescription(answer);
                log('–õ–æ–∫–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç
                await roomRef.update({ answer: answer });
                log('–û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ Firebase');
                
                // –ü—Ä–∏–º–µ–Ω—è–µ–º –æ–∂–∏–¥–∞—é—â–∏–µ –∫–∞–Ω–¥–∏–¥–∞—Ç—ã
                applyPendingCandidates();
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è: ${error.message}`);
            }
        }

        async function handleAnswer(answer) {
            try {
                log('–ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é...');
                
                await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
                log('‚úÖ –£–¥–∞–ª–µ–Ω–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
                
                applyPendingCandidates();
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—Ç–≤–µ—Ç–∞: ${error.message}`);
            }
        }

        async function handleIceCandidate(candidate) {
            try {
                // –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
                await new Promise(resolve => setTimeout(resolve, 100));
                
                if (peerConnection && peerConnection.remoteDescription) {
                    await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
                    log(`‚úÖ ICE –∫–∞–Ω–¥–∏–¥–∞—Ç –¥–æ–±–∞–≤–ª–µ–Ω`);
                } else {
                    pendingIceCandidates.push(candidate);
                    log(`üì• –ö–∞–Ω–¥–∏–¥–∞—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω (–æ–∂–∏–¥–∞–µ—Ç —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ –æ–ø–∏—Å–∞–Ω–∏—è): ${pendingIceCandidates.length}`);
                }
            } catch (error) {
                log(`‚ö†Ô∏è –û—à–∏–±–∫–∞ ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–∞: ${error.message}`);
            }
        }

        function applyPendingCandidates() {
            if (!peerConnection || !peerConnection.remoteDescription) return;
            
            log(`–ü—Ä–∏–º–µ–Ω—è—é ${pendingIceCandidates.length} –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã—Ö –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤...`);
            
            while (pendingIceCandidates.length > 0) {
                const candidate = pendingIceCandidates.shift();
                peerConnection.addIceCandidate(new RTCIceCandidate(candidate))
                    .then(() => log(`‚úÖ –ü—Ä–∏–º–µ–Ω–µ–Ω –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã–π –∫–∞–Ω–¥–∏–¥–∞—Ç`))
                    .catch(err => log(`‚ö†Ô∏è –û—à–∏–±–∫–∞ –æ—Ç–ª–æ–∂–µ–Ω–Ω–æ–≥–æ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞: ${err.message}`));
            }
        }

        function restartIce() {
            if (!peerConnection) return;
            
            log('üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—é ICE...');
            
            try {
                peerConnection.restartIce();
                log('‚úÖ ICE –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω');
            } catch (error) {
                log(`‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å ICE: ${error.message}`);
            }
        }

        // ========== –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ==========
        function toggleMute() {
            if (!localStream) return;
            
            const audioTrack = localStream.getAudioTracks()[0];
            if (audioTrack) {
                microphoneMuted = !microphoneMuted;
                audioTrack.enabled = !microphoneMuted;
                
                const muteBtn = document.getElementById('muteBtn');
                if (microphoneMuted) {
                    muteBtn.innerHTML = 'üé§ –í–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω';
                    muteBtn.style.background = '#e74c3c';
                    log('üîá –ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤—ã–∫–ª—é—á–µ–Ω');
                } else {
                    muteBtn.innerHTML = 'üîá –í—ã–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω';
                    muteBtn.style.background = '#34495e';
                    log('üé§ –ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤–∫–ª—é—á–µ–Ω');
                }
            }
        }

        function unmuteAudio() {
            if (remoteAudio) {
                remoteAudio.play()
                    .then(() => {
                        log('‚úÖ –ó–≤—É–∫ –≤–∫–ª—é—á–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º');
                        document.getElementById('callInfo').textContent = '‚úÖ –ó–≤—É–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç!';
                    })
                    .catch(err => {
                        log(`‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –≤–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫: ${err.message}`);
                    });
            }
        }

        function handleRemoteHangup() {
            log('–°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –∑–∞–≤–µ—Ä—à–∏–ª –∑–≤–æ–Ω–æ–∫');
            alert('–°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –∑–∞–≤–µ—Ä—à–∏–ª –∑–≤–æ–Ω–æ–∫');
            hangUp();
        }

        // ========== –ó–ê–í–ï–†–®–ï–ù–ò–ï ==========
        function hangUp() {
            log('–ó–∞–≤–µ—Ä—à–∞—é –∑–≤–æ–Ω–æ–∫...');
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–∏–≥–Ω–∞–ª –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏
            if (roomRef) {
                roomRef.update({ 
                    hangup: true,
                    callRequest: null,
                    callResponse: null,
                    offer: null,
                    answer: null,
                    iceCandidate: null
                }).catch(() => {});
            }
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ—Ç–æ–∫–∏
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            
            if (remoteStream) {
                remoteStream.getTracks().forEach(track => track.stop());
                remoteStream = null;
            }
            
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞—É–¥–∏–æ
            if (remoteAudio) {
                remoteAudio.pause();
                remoteAudio.srcObject = null;
                remoteAudio = null;
            }
            
            // –û—á–∏—â–∞–µ–º —Ç–∞–π–º–µ—Ä—ã
            if (iceGatheringTimeout) {
                clearTimeout(iceGatheringTimeout);
                iceGatheringTimeout = null;
            }
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫–∏
            pendingIceCandidates = [];
            iceCandidatesCount = 0;
            connectionAttempts = 0;
            microphoneMuted = false;
            
            // –°–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫–∏
            document.getElementById('incomingModal').style.display = 'none';
            document.getElementById('waitingModal').style.display = 'none';
            document.getElementById('activeModal').style.display = 'none';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
            if (currentRoomId) {
                updateStatus(`–í –∫–æ–º–Ω–∞—Ç–µ: ${currentRoomId}`, 'ready');
            } else {
                updateStatus('–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ', '');
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º UI
            document.getElementById('iceState').textContent = '-';
            document.getElementById('connType').textContent = '-';
            document.getElementById('iceCount').textContent = '0';
            document.getElementById('iceInfo').textContent = '';
            
            callStatus = 'idle';
            log('–ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω');
        }

        // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
        function init() {
            log('‚úÖ –ó–≤–æ–Ω–∏–ª–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
            updateStatus('–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ', '');
            
            if (!navigator.mediaDevices || !window.RTCPeerConnection) {
                alert('‚ùå –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç WebRTC! –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Chrome/Firefox/Edge.');
                return;
            }
            
            log('‚úÖ WebRTC –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
            log('‚ö†Ô∏è –î–ª—è —Ä–∞–±–æ—Ç—ã –Ω–∞ —Ä–∞–∑–Ω—ã—Ö —Å–µ—Ç—è—Ö –≤–∫–ª—é—á–∏—Ç–µ "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å TURN-—Å–µ—Ä–≤–µ—Ä—ã"');
        }

        window.addEventListener('beforeunload', () => {
            if (callStatus === 'in_call') hangUp();
            if (roomRef) roomRef.off();
        });

        window.onload = init;
    </script>
</body>
</html>
