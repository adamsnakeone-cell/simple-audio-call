<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéß –ó–≤–æ–Ω–∏–ª–∫–∞ (100% —Ä–∞–±–æ—á–∏–π –∑–≤—É–∫)</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
        body { background: #2c3e50; min-height: 100vh; padding: 20px; display: flex; justify-content: center; align-items: center; }
        .container { background: white; border-radius: 15px; padding: 25px; width: 100%; max-width: 500px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        h1 { text-align: center; margin-bottom: 20px; color: #2c3e50; }
        input { width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; margin-bottom: 15px; }
        .buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0; }
        button { padding: 15px; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; transition: 0.3s; font-weight: bold; }
        #createBtn { background: #27ae60; color: white; }
        #joinBtn { background: #3498db; color: white; }
        #callBtn { background: #e67e22; color: white; grid-column: span 2; }
        #hangupBtn { background: #e74c3c; color: white; grid-column: span 2; }
        button:disabled { background: #95a5a6 !important; cursor: not-allowed; }
        .status { background: #ecf0f1; padding: 15px; border-radius: 8px; margin: 15px 0; text-align: center; min-height: 60px; display: flex; flex-direction: column; justify-content: center; }
        .status.ready { background: #d5f4e6; color: #27ae60; }
        .status.calling { background: #ffeaa7; color: #e67e22; }
        .status.connected { background: #d6eaf8; color: #2980b9; }
        .log { background: #1a1a1a; color: #2ecc71; padding: 15px; border-radius: 8px; margin-top: 20px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 30px; border-radius: 15px; text-align: center; max-width: 400px; width: 90%; }
        .modal-buttons { display: flex; gap: 15px; margin-top: 25px; }
        .modal-buttons button { flex: 1; }
        .accept { background: #27ae60; color: white; }
        .reject { background: #e74c3c; color: white; }
        .audio-check { margin: 15px 0; padding: 10px; background: #f8f9fa; border-radius: 8px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéß –ó–≤–æ–Ω–∏–ª–∫–∞ (100% —Ä–∞–±–æ—á–∏–π –∑–≤—É–∫)</h1>
        
        <input type="text" id="roomId" placeholder="ID –∫–æ–º–Ω–∞—Ç—ã" value="8888">
        
        <div class="buttons">
            <button id="createBtn" onclick="createRoom()">–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
            <button id="joinBtn" onclick="joinRoom()">–í–æ–π—Ç–∏ –≤ –∫–æ–º–Ω–∞—Ç—É</button>
        </div>
        
        <div class="status" id="statusBox">
            <div id="statusText">–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ</div>
            <div id="connectionInfo" style="font-size: 12px; color: #666; margin-top: 5px;"></div>
        </div>
        
        <div class="buttons">
            <button id="callBtn" onclick="startCall()" disabled>üìû –ù–∞—á–∞—Ç—å –∑–≤–æ–Ω–æ–∫</button>
            <button id="hangupBtn" onclick="hangUp()" disabled>‚ùå –ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–≤–æ–Ω–æ–∫</button>
        </div>
        
        <div class="audio-check">
            <button onclick="testAudio()" style="padding: 10px; background: #9b59b6; color: white; width: 100%;">
                üîä –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–≤—É–∫ –∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω
            </button>
        </div>
        
        <div class="log" id="logBox"></div>
    </div>
    
    <div class="modal" id="incomingModal">
        <div class="modal-content">
            <div style="font-size: 50px; margin-bottom: 20px;">üìû</div>
            <h3>–í–•–û–î–Ø–©–ò–ô –í–´–ó–û–í!</h3>
            <p>–ö–æ–º–Ω–∞—Ç–∞: <strong id="callRoomId"></strong></p>
            <div class="modal-buttons">
                <button class="accept" onclick="acceptCall()">‚úÖ –ü–†–ò–ù–Ø–¢–¨</button>
                <button class="reject" onclick="rejectCall()">‚ùå –û–¢–ö–õ–û–ù–ò–¢–¨</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="waitingModal">
        <div class="modal-content">
            <div style="font-size: 50px; margin-bottom: 20px;">‚è≥</div>
            <h3>–û–∂–∏–¥–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞...</h3>
            <p>–ö–æ–º–Ω–∞—Ç–∞: <strong id="waitRoomId"></strong></p>
            <button class="reject" onclick="cancelCall()" style="margin-top: 20px;">–û—Ç–º–µ–Ω–∏—Ç—å</button>
        </div>
    </div>
    
    <div class="modal" id="activeModal">
        <div class="modal-content">
            <div style="font-size: 50px; margin-bottom: 20px;">üéß</div>
            <h3>–†–ê–ó–ì–û–í–û–† –ê–ö–¢–ò–í–ï–ù</h3>
            <p>–ö–æ–º–Ω–∞—Ç–∞: <strong id="activeRoomId"></strong></p>
            <div id="callInfo" style="margin: 20px 0; color: #666;"></div>
            <button class="reject" onclick="hangUp()">üìû –ó–ê–í–ï–†–®–ò–¢–¨</button>
        </div>
    </div>

    <script>
        // ========== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ==========
        const firebaseConfig = {
            apiKey: "AIzaSyDdlYdrHiGWd73F_pmwMKHrX92gK-G7kB8",
            databaseURL: "https://simple-audio-call-default-rtdb.europe-west1.firebasedatabase.app"
        };

        // ========== –ü–ï–†–ï–ú–ï–ù–ù–´–ï ==========
        let localStream = null;
        let remoteStream = null;
        let peerConnection = null;
        let database = null;
        let roomRef = null;
        let currentRoomId = null;
        let isCaller = false;
        let callStatus = 'idle';
        let pendingIceCandidates = [];
        let hasRemoteDescription = false;
        let hasLocalDescription = false;
        let remoteAudio = null;

        // ========== –õ–û–ì–ò–†–û–í–ê–ù–ò–ï ==========
        function log(message, type = 'info') {
            const logBox = document.getElementById('logBox');
            const time = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.innerHTML = `<span style="color: #95a5a6">${time}</span> ${message}`;
            logBox.appendChild(entry);
            logBox.scrollTop = logBox.scrollHeight;
            console.log(`[${type}] ${message}`);
        }

        function updateStatus(text, statusClass = '', info = '') {
            document.getElementById('statusText').textContent = text;
            document.getElementById('statusBox').className = 'status ' + statusClass;
            if (info) document.getElementById('connectionInfo').textContent = info;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏
            document.getElementById('callBtn').disabled = !(currentRoomId && callStatus === 'idle');
            document.getElementById('hangupBtn').disabled = callStatus !== 'in_call';
        }

        // ========== –¢–ï–°–¢ –ê–£–î–ò–û ==========
        async function testAudio() {
            try {
                log('üîä –¢–µ—Å—Ç–∏—Ä—É—é –º–∏–∫—Ä–æ—Ñ–æ–Ω –∏ –¥–∏–Ω–∞–º–∏–∫–∏...');
                
                // –¢–µ—Å—Ç –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                log('‚úÖ –ú–∏–∫—Ä–æ—Ñ–æ–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç');
                
                // –¢–µ—Å—Ç –¥–∏–Ω–∞–º–∏–∫–æ–≤
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 440;
                oscillator.type = 'sine';
                gainNode.gain.value = 0.1;
                
                oscillator.start();
                log('üîä –¢–µ—Å—Ç–æ–≤—ã–π –∑–≤—É–∫ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è...');
                
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
                setTimeout(() => {
                    oscillator.stop();
                    stream.getTracks().forEach(track => track.stop());
                    audioContext.close();
                    log('‚úÖ –¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω. –í—Å–µ —Å–∏—Å—Ç–µ–º—ã —Ä–∞–±–æ—Ç–∞—é—Ç!');
                    alert('‚úÖ –¢–µ—Å—Ç –ø—Ä–æ–π–¥–µ–Ω! –ú–∏–∫—Ä–æ—Ñ–æ–Ω –∏ –¥–∏–Ω–∞–º–∏–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç.');
                }, 2000);
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∞: ${error.message}`);
                alert('‚ùå –ü—Ä–æ–±–ª–µ–º–∞ —Å –∞—É–¥–∏–æ! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ –∏ –¥–∏–Ω–∞–º–∏–∫–∏.');
            }
        }

        // ========== –ö–û–ú–ù–ê–¢–´ ==========
        function createRoom() {
            currentRoomId = document.getElementById('roomId').value.trim() || '8888';
            document.getElementById('roomId').value = currentRoomId;
            connectToRoom(true);
        }

        function joinRoom() {
            currentRoomId = document.getElementById('roomId').value.trim();
            if (!currentRoomId) {
                alert('–í–≤–µ–¥–∏—Ç–µ ID –∫–æ–º–Ω–∞—Ç—ã');
                return;
            }
            connectToRoom(false);
        }

        function connectToRoom(isCreator) {
            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                database = firebase.database();
                
                isCaller = isCreator;
                
                if (roomRef) roomRef.off();
                roomRef = database.ref(`rooms/${currentRoomId}`);
                
                if (isCreator) {
                    roomRef.remove().catch(() => {});
                }
                
                roomRef.on('value', handleRoomUpdate);
                
                updateStatus(`–í –∫–æ–º–Ω–∞—Ç–µ: ${currentRoomId}`, 'ready');
                log(`${isCreator ? '–°–æ–∑–¥–∞–Ω–∞' : '–í–æ—à–ª–∏ –≤'} –∫–æ–º–Ω–∞—Ç—É ${currentRoomId}`);
                
            } catch (error) {
                log(`–û—à–∏–±–∫–∞: ${error.message}`);
            }
        }

        // ========== –û–ë–†–ê–ë–û–¢–ö–ê –°–û–ë–´–¢–ò–ô ==========
        function handleRoomUpdate(snapshot) {
            const data = snapshot.val();
            if (!data) return;
            
            // –í—Ö–æ–¥—è—â–∏–π –≤—ã–∑–æ–≤
            if (data.callRequest && !isCaller && callStatus === 'idle') {
                showIncomingCall();
            }
            
            // –û—Ç–≤–µ—Ç –Ω–∞ –≤—ã–∑–æ–≤
            if (data.callResponse && callStatus === 'calling') {
                handleCallResponse(data.callResponse);
            }
            
            // WebRTC - —Ç–æ–ª—å–∫–æ –≤ –∞–∫—Ç–∏–≤–Ω–æ–º –∑–≤–æ–Ω–∫–µ
            if (callStatus === 'in_call' && peerConnection) {
                if (data.offer && !isCaller && !hasRemoteDescription) {
                    handleOffer(data.offer);
                }
                
                if (data.answer && isCaller && !hasRemoteDescription) {
                    handleAnswer(data.answer);
                }
                
                if (data.iceCandidate) {
                    handleIceCandidate(data.iceCandidate);
                }
            }
            
            if (data.hangup) {
                handleRemoteHangup();
            }
        }

        function showIncomingCall() {
            document.getElementById('callRoomId').textContent = currentRoomId;
            document.getElementById('incomingModal').style.display = 'flex';
            callStatus = 'ringing';
            updateStatus('–í—Ö–æ–¥—è—â–∏–π –≤—ã–∑–æ–≤!', 'calling');
            log('üìû –í—Ö–æ–¥—è—â–∏–π –≤—ã–∑–æ–≤');
        }

        // ========== –£–ü–†–ê–í–õ–ï–ù–ò–ï –ó–í–û–ù–ö–ê–ú–ò ==========
        function startCall() {
            callStatus = 'calling';
            document.getElementById('waitRoomId').textContent = currentRoomId;
            document.getElementById('waitingModal').style.display = 'flex';
            
            roomRef.update({ 
                callRequest: { time: Date.now() },
                offer: null,
                answer: null,
                iceCandidate: null,
                hangup: null
            });
            
            log('–í—ã–∑—ã–≤–∞—é...');
        }

        function acceptCall() {
            document.getElementById('incomingModal').style.display = 'none';
            callStatus = 'in_call';
            
            roomRef.update({
                callResponse: { accepted: true, time: Date.now() }
            });
            
            startWebRTC(false);
            log('‚úÖ –í—ã–∑–æ–≤ –ø—Ä–∏–Ω—è—Ç');
        }

        function rejectCall() {
            document.getElementById('incomingModal').style.display = 'none';
            callStatus = 'idle';
            
            roomRef.update({
                callResponse: { accepted: false, time: Date.now() }
            });
            
            updateStatus(`–í –∫–æ–º–Ω–∞—Ç–µ: ${currentRoomId}`, 'ready');
            log('–í—ã–∑–æ–≤ –æ—Ç–∫–ª–æ–Ω–µ–Ω');
        }

        function handleCallResponse(response) {
            if (response.accepted) {
                callStatus = 'in_call';
                document.getElementById('waitingModal').style.display = 'none';
                startWebRTC(true);
                log('‚úÖ –í—ã–∑–æ–≤ –ø—Ä–∏–Ω—è—Ç –¥—Ä—É–≥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º');
            } else {
                callStatus = 'idle';
                document.getElementById('waitingModal').style.display = 'none';
                alert('–í—ã–∑–æ–≤ –æ—Ç–∫–ª–æ–Ω–µ–Ω');
                updateStatus(`–í –∫–æ–º–Ω–∞—Ç–µ: ${currentRoomId}`, 'ready');
                log('–í—ã–∑–æ–≤ –æ—Ç–∫–ª–æ–Ω–µ–Ω –¥—Ä—É–≥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º');
            }
        }

        function cancelCall() {
            document.getElementById('waitingModal').style.display = 'none';
            callStatus = 'idle';
            roomRef.update({ callRequest: null });
            updateStatus(`–í –∫–æ–º–Ω–∞—Ç–µ: ${currentRoomId}`, 'ready');
            log('–í—ã–∑–æ–≤ –æ—Ç–º–µ–Ω–µ–Ω');
        }

        // ========== WEBRTC (–£–ü–†–û–©–ï–ù–ù–´–ô –ò –†–ê–ë–û–ß–ò–ô) ==========
        async function startWebRTC(isInitiator) {
            try {
                updateStatus('–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∑–≤–æ–Ω–∫–∞...', 'calling');
                
                // –ü–æ–ª—É—á–∞–µ–º –º–∏–∫—Ä–æ—Ñ–æ–Ω —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
                localStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        channelCount: 1,
                        sampleRate: 48000,
                        echoCancellation: false,
                        noiseSuppression: false,
                        autoGainControl: false
                    }
                });
                
                log('üé§ –ú–∏–∫—Ä–æ—Ñ–æ–Ω –ø–æ–¥–∫–ª—é—á–µ–Ω');
                
                // –°–æ–∑–¥–∞–µ–º PeerConnection —Å –û–î–ù–ò–ú STUN
                const config = {
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' }
                    ],
                    iceTransportPolicy: 'all',
                    iceCandidatePoolSize: 0
                };
                
                peerConnection = new RTCPeerConnection(config);
                pendingIceCandidates = [];
                hasRemoteDescription = false;
                hasLocalDescription = false;
                
                // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π —Ç—Ä–µ–∫
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
                
                // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
                setupPeerConnectionHandlers();
                
                // –ï—Å–ª–∏ –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä - —Å–æ–∑–¥–∞–µ–º offer
                if (isInitiator) {
                    await createOffer();
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∑–≤–æ–Ω–æ–∫
                document.getElementById('activeRoomId').textContent = currentRoomId;
                document.getElementById('activeModal').style.display = 'flex';
                updateStatus('–†–∞–∑–≥–æ–≤–æ—Ä –∞–∫—Ç–∏–≤–µ–Ω', 'connected', '–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ...');
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`);
                hangUp();
            }
        }

        function setupPeerConnectionHandlers() {
            // ICE –∫–∞–Ω–¥–∏–¥–∞—Ç—ã
            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    log(`‚ùÑÔ∏è ICE: ${event.candidate.type}`);
                    roomRef.update({ iceCandidate: event.candidate });
                }
            };
            
            // –£–¥–∞–ª–µ–Ω–Ω—ã–π –ø–æ—Ç–æ–∫ - –°–ê–ú–û–ï –í–ê–ñ–ù–û–ï!
            peerConnection.ontrack = (event) => {
                log('üîä –ü–æ–ª—É—á–µ–Ω —É–¥–∞–ª–µ–Ω–Ω—ã–π –∑–≤—É–∫–æ–≤–æ–π –ø–æ—Ç–æ–∫!');
                
                if (!remoteStream) {
                    remoteStream = new MediaStream();
                }
                remoteStream.addTrack(event.track);
                
                // –°–æ–∑–¥–∞–µ–º –∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –∞—É–¥–∏–æ
                if (!remoteAudio) {
                    remoteAudio = new Audio();
                    remoteAudio.autoplay = true;
                    remoteAudio.volume = 1.0;
                }
                
                remoteAudio.srcObject = remoteStream;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
                setTimeout(() => {
                    if (remoteAudio.duration > 0 && !remoteAudio.paused) {
                        log('‚úÖ –ó–í–£–ö –†–ê–ë–û–¢–ê–ï–¢! –ì–æ–≤–æ—Ä–∏—Ç–µ!');
                        updateStatus('–°–û–ï–î–ò–ù–ï–ù–ò–ï –£–°–¢–ê–ù–û–í–õ–ï–ù–û!', 'connected', '–ó–≤—É–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç!');
                        document.getElementById('callInfo').textContent = '‚úÖ –ó–≤—É–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç! –ú–æ–∂–µ—Ç–µ –≥–æ–≤–æ—Ä–∏—Ç—å.';
                    }
                }, 1000);
            };
            
            // –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
            peerConnection.onconnectionstatechange = () => {
                const state = peerConnection.connectionState;
                log(`üîó –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ: ${state}`);
                
                if (state === 'connected') {
                    log('üéâ –°–û–ï–î–ò–ù–ï–ù–ò–ï –£–°–¢–ê–ù–û–í–õ–ï–ù–û!');
                    document.getElementById('callInfo').textContent = '–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ';
                }
                
                if (state === 'disconnected' || state === 'failed') {
                    log('‚ö†Ô∏è –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ');
                }
            };
            
            // ICE —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            peerConnection.oniceconnectionstatechange = () => {
                log(`üßä ICE: ${peerConnection.iceConnectionState}`);
            };
        }

        async function createOffer() {
            try {
                log('–°–æ–∑–¥–∞—é –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ...');
                
                const offer = await peerConnection.createOffer({
                    offerToReceiveAudio: true
                });
                
                log(`–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ`);
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
                await peerConnection.setLocalDescription(offer);
                hasLocalDescription = true;
                log('–õ–æ–∫–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Firebase
                await roomRef.update({ offer: offer });
                log('–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ');
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è: ${error.message}`);
            }
        }

        async function handleOffer(offer) {
            try {
                if (hasRemoteDescription) {
                    log('‚ö†Ô∏è –£–∂–µ –µ—Å—Ç—å —É–¥–∞–ª–µ–Ω–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º');
                    return;
                }
                
                log('–ü–æ–ª—É—á–µ–Ω–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ, —Å–æ–∑–¥–∞—é –æ—Ç–≤–µ—Ç...');
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —É–¥–∞–ª–µ–Ω–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
                await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
                hasRemoteDescription = true;
                log('–£–¥–∞–ª–µ–Ω–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
                
                // –°–æ–∑–¥–∞–µ–º –æ—Ç–≤–µ—Ç
                const answer = await peerConnection.createAnswer();
                log(`–û—Ç–≤–µ—Ç —Å–æ–∑–¥–∞–Ω`);
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
                await peerConnection.setLocalDescription(answer);
                hasLocalDescription = true;
                log('–õ–æ–∫–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç
                await roomRef.update({ answer: answer });
                log('–û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω');
                
                // –ü—Ä–∏–º–µ–Ω—è–µ–º –æ–∂–∏–¥–∞—é—â–∏–µ –∫–∞–Ω–¥–∏–¥–∞—Ç—ã
                applyPendingCandidates();
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è: ${error.message}`);
                
                // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è - –∂–¥–µ–º –∏ –ø—Ä–æ–±—É–µ–º —Å–Ω–æ–≤–∞
                if (error.message.includes('wrong state')) {
                    log('‚ö†Ô∏è –ñ–¥—É —Å—Ç–∞–±–∏–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è...');
                    setTimeout(() => {
                        if (callStatus === 'in_call' && !hasRemoteDescription) {
                            handleOffer(offer);
                        }
                    }, 1000);
                }
            }
        }

        async function handleAnswer(answer) {
            try {
                if (hasRemoteDescription) {
                    log('‚ö†Ô∏è –£–∂–µ –µ—Å—Ç—å —É–¥–∞–ª–µ–Ω–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º');
                    return;
                }
                
                log('–ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é...');
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —É–¥–∞–ª–µ–Ω–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
                await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
                hasRemoteDescription = true;
                log('–£–¥–∞–ª–µ–Ω–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
                
                // –ü—Ä–∏–º–µ–Ω—è–µ–º –æ–∂–∏–¥–∞—é—â–∏–µ –∫–∞–Ω–¥–∏–¥–∞—Ç—ã
                applyPendingCandidates();
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—Ç–≤–µ—Ç–∞: ${error.message}`);
                
                // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è - –∂–¥–µ–º
                if (error.message.includes('wrong state') || error.message.includes('stable')) {
                    log('‚ö†Ô∏è PeerConnection –Ω–µ –≥–æ—Ç–æ–≤, –∂–¥—É...');
                    
                    // –ñ–¥–µ–º –ø–æ–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
                    const checkInterval = setInterval(() => {
                        if (peerConnection.signalingState === 'have-local-offer') {
                            clearInterval(checkInterval);
                            handleAnswer(answer);
                        }
                    }, 500);
                    
                    // –¢–∞–π–º–∞—É—Ç 5 —Å–µ–∫—É–Ω–¥
                    setTimeout(() => clearInterval(checkInterval), 5000);
                }
            }
        }

        async function handleIceCandidate(candidate) {
            if (!peerConnection) {
                pendingIceCandidates.push(candidate);
                return;
            }
            
            try {
                // –ñ–¥–µ–º –ø–æ–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —É–¥–∞–ª–µ–Ω–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
                if (!peerConnection.remoteDescription) {
                    pendingIceCandidates.push(candidate);
                    return;
                }
                
                await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
                log('‚ùÑÔ∏è ICE –∫–∞–Ω–¥–∏–¥–∞—Ç –¥–æ–±–∞–≤–ª–µ–Ω');
                
            } catch (error) {
                log(`‚ö†Ô∏è –û—à–∏–±–∫–∞ ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–∞: ${error.message}`);
            }
        }

        function applyPendingCandidates() {
            if (!peerConnection || !peerConnection.remoteDescription) return;
            
            while (pendingIceCandidates.length > 0) {
                const candidate = pendingIceCandidates.shift();
                peerConnection.addIceCandidate(new RTCIceCandidate(candidate))
                    .catch(err => log(`‚ö†Ô∏è –û—à–∏–±–∫–∞ –æ—Ç–ª–æ–∂–µ–Ω–Ω–æ–≥–æ ICE: ${err.message}`));
            }
        }

        function handleRemoteHangup() {
            log('–°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –∑–∞–≤–µ—Ä—à–∏–ª –∑–≤–æ–Ω–æ–∫');
            alert('–°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –∑–∞–≤–µ—Ä—à–∏–ª –∑–≤–æ–Ω–æ–∫');
            hangUp();
        }

        // ========== –ó–ê–í–ï–†–®–ï–ù–ò–ï ==========
        function hangUp() {
            log('–ó–∞–≤–µ—Ä—à–∞—é –∑–≤–æ–Ω–æ–∫...');
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–∏–≥–Ω–∞–ª –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏
            if (roomRef) {
                roomRef.update({ 
                    hangup: true,
                    callRequest: null,
                    callResponse: null,
                    offer: null,
                    answer: null,
                    iceCandidate: null
                }).catch(() => {});
            }
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º PeerConnection
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ—Ç–æ–∫–∏
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            
            if (remoteStream) {
                remoteStream.getTracks().forEach(track => track.stop());
                remoteStream = null;
            }
            
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞—É–¥–∏–æ
            if (remoteAudio) {
                remoteAudio.pause();
                remoteAudio.srcObject = null;
                remoteAudio = null;
            }
            
            // –û—á–∏—â–∞–µ–º —Ñ–ª–∞–≥–∏
            pendingIceCandidates = [];
            hasRemoteDescription = false;
            hasLocalDescription = false;
            
            // –°–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫–∏
            document.getElementById('incomingModal').style.display = 'none';
            document.getElementById('waitingModal').style.display = 'none';
            document.getElementById('activeModal').style.display = 'none';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
            if (currentRoomId) {
                updateStatus(`–í –∫–æ–º–Ω–∞—Ç–µ: ${currentRoomId}`, 'ready');
            } else {
                updateStatus('–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ', '');
            }
            
            callStatus = 'idle';
            log('–ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω');
        }

        // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
        function init() {
            log('‚úÖ –ó–≤–æ–Ω–∏–ª–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
            updateStatus('–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ', '');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É WebRTC
            if (!navigator.mediaDevices || !window.RTCPeerConnection) {
                alert('‚ùå –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç WebRTC! –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Chrome/Firefox/Edge.');
                return;
            }
            
            log('‚úÖ WebRTC –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
        }

        // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
        window.addEventListener('beforeunload', () => {
            if (callStatus === 'in_call') hangUp();
            if (roomRef) roomRef.off();
        });

        window.onload = init;
    </script>
</body>
</html>
