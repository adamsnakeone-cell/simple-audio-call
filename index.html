<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéß –ó–≤–æ–Ω–∏–ª–∫–∞ (–ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –∑–≤—É–∫)</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
        body { background: #2c3e50; min-height: 100vh; padding: 20px; display: flex; justify-content: center; align-items: center; }
        .container { background: white; border-radius: 15px; padding: 25px; width: 100%; max-width: 500px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        h1 { text-align: center; margin-bottom: 20px; color: #2c3e50; }
        input { width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; margin-bottom: 15px; }
        .buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0; }
        button { padding: 15px; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; transition: 0.3s; font-weight: bold; }
        #createBtn { background: #27ae60; color: white; }
        #joinBtn { background: #3498db; color: white; }
        #callBtn { background: #e67e22; color: white; grid-column: span 2; }
        #hangupBtn { background: #e74c3c; color: white; grid-column: span 2; }
        button:disabled { background: #95a5a6 !important; cursor: not-allowed; }
        .status { background: #ecf0f1; padding: 15px; border-radius: 8px; margin: 15px 0; text-align: center; min-height: 60px; display: flex; flex-direction: column; justify-content: center; }
        .status.ready { background: #d5f4e6; color: #27ae60; }
        .status.calling { background: #ffeaa7; color: #e67e22; }
        .status.connected { background: #d6eaf8; color: #2980b9; }
        .log { background: #1a1a1a; color: #2ecc71; padding: 15px; border-radius: 8px; margin-top: 20px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 30px; border-radius: 15px; text-align: center; max-width: 400px; width: 90%; }
        .modal-buttons { display: flex; gap: 15px; margin-top: 25px; }
        .modal-buttons button { flex: 1; }
        .accept { background: #27ae60; color: white; }
        .reject { background: #e74c3c; color: white; }
        .audio-check { margin: 15px 0; padding: 10px; background: #f8f9fa; border-radius: 8px; }
        .volume-control { margin: 10px 0; padding: 10px; background: #f1f1f1; border-radius: 8px; }
        .volume-slider { width: 100%; margin: 5px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéß –ó–≤–æ–Ω–∏–ª–∫–∞ (–ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –∑–≤—É–∫)</h1>
        
        <input type="text" id="roomId" placeholder="ID –∫–æ–º–Ω–∞—Ç—ã" value="8888">
        
        <div class="buttons">
            <button id="createBtn" onclick="createRoom()">–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
            <button id="joinBtn" onclick="joinRoom()">–í–æ–π—Ç–∏ –≤ –∫–æ–º–Ω–∞—Ç—É</button>
        </div>
        
        <div class="status" id="statusBox">
            <div id="statusText">–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ</div>
            <div id="connectionInfo" style="font-size: 12px; color: #666; margin-top: 5px;"></div>
        </div>
        
        <div class="buttons">
            <button id="callBtn" onclick="startCall()" disabled>üìû –ù–∞—á–∞—Ç—å –∑–≤–æ–Ω–æ–∫</button>
            <button id="hangupBtn" onclick="hangUp()" disabled>‚ùå –ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–≤–æ–Ω–æ–∫</button>
        </div>
        
        <div class="audio-check">
            <button onclick="testAudio()" style="padding: 10px; background: #9b59b6; color: white; width: 100%;">
                üîä –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–≤—É–∫ –∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω
            </button>
        </div>
        
        <div class="volume-control" style="display: none;" id="volumeControls">
            <label>–ì—Ä–æ–º–∫–æ—Å—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞:</label>
            <input type="range" min="0" max="100" value="100" class="volume-slider" id="micVolume">
            <label>–ì—Ä–æ–º–∫–æ—Å—Ç—å –¥–∏–Ω–∞–º–∏–∫–æ–≤:</label>
            <input type="range" min="0" max="100" value="100" class="volume-slider" id="speakerVolume">
        </div>
        
        <div class="log" id="logBox"></div>
    </div>
    
    <div class="modal" id="incomingModal">
        <div class="modal-content">
            <div style="font-size: 50px; margin-bottom: 20px;">üìû</div>
            <h3>–í–•–û–î–Ø–©–ò–ô –í–´–ó–û–í!</h3>
            <p>–ö–æ–º–Ω–∞—Ç–∞: <strong id="callRoomId"></strong></p>
            <div class="modal-buttons">
                <button class="accept" onclick="acceptCall()">‚úÖ –ü–†–ò–ù–Ø–¢–¨</button>
                <button class="reject" onclick="rejectCall()">‚ùå –û–¢–ö–õ–û–ù–ò–¢–¨</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="waitingModal">
        <div class="modal-content">
            <div style="font-size: 50px; margin-bottom: 20px;">‚è≥</div>
            <h3>–û–∂–∏–¥–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞...</h3>
            <p>–ö–æ–º–Ω–∞—Ç–∞: <strong id="waitRoomId"></strong></p>
            <button class="reject" onclick="cancelCall()" style="margin-top: 20px;">–û—Ç–º–µ–Ω–∏—Ç—å</button>
        </div>
    </div>
    
    <div class="modal" id="activeModal">
        <div class="modal-content">
            <div style="font-size: 50px; margin-bottom: 20px;">üéß</div>
            <h3>–†–ê–ó–ì–û–í–û–† –ê–ö–¢–ò–í–ï–ù</h3>
            <p>–ö–æ–º–Ω–∞—Ç–∞: <strong id="activeRoomId"></strong></p>
            <div id="callInfo" style="margin: 20px 0; color: #666;"></div>
            <div style="margin: 15px 0;">
                <button onclick="toggleMute()" id="muteBtn" style="padding: 10px; background: #34495e; color: white; margin: 5px;">
                    üîá –í—ã–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω
                </button>
            </div>
            <button class="reject" onclick="hangUp()">üìû –ó–ê–í–ï–†–®–ò–¢–¨</button>
        </div>
    </div>

    <script>
        // ========== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ==========
        const firebaseConfig = {
            apiKey: "AIzaSyDdlYdrHiGWd73F_pmwMKHrX92gK-G7kB8",
            databaseURL: "https://simple-audio-call-default-rtdb.europe-west1.firebasedatabase.app"
        };

        // ========== –ü–ï–†–ï–ú–ï–ù–ù–´–ï ==========
        let localStream = null;
        let remoteStream = null;
        let peerConnection = null;
        let database = null;
        let roomRef = null;
        let currentRoomId = null;
        let isCaller = false;
        let callStatus = 'idle';
        let pendingIceCandidates = [];
        let hasRemoteDescription = false;
        let hasLocalDescription = false;
        let remoteAudio = null;
        let audioContext = null;
        let gainNode = null;
        let microphoneMuted = false;

        // ========== –õ–û–ì–ò–†–û–í–ê–ù–ò–ï ==========
        function log(message, type = 'info') {
            const logBox = document.getElementById('logBox');
            const time = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.innerHTML = `<span style="color: #95a5a6">${time}</span> ${message}`;
            logBox.appendChild(entry);
            logBox.scrollTop = logBox.scrollHeight;
            console.log(`[${type}] ${message}`);
        }

        function updateStatus(text, statusClass = '', info = '') {
            document.getElementById('statusText').textContent = text;
            document.getElementById('statusBox').className = 'status ' + statusClass;
            if (info) document.getElementById('connectionInfo').textContent = info;
            
            document.getElementById('callBtn').disabled = !(currentRoomId && callStatus === 'idle');
            document.getElementById('hangupBtn').disabled = callStatus !== 'in_call';
        }

        // ========== –¢–ï–°–¢ –ê–£–î–ò–û ==========
        async function testAudio() {
            try {
                log('üîä –¢–µ—Å—Ç–∏—Ä—É—é –º–∏–∫—Ä–æ—Ñ–æ–Ω –∏ –¥–∏–Ω–∞–º–∏–∫–∏...');
                
                // –¢–µ—Å—Ç –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: false,
                        channelCount: 1,
                        sampleRate: 48000
                    }
                });
                
                // –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const analyser = audioContext.createAnalyser();
                const source = audioContext.createMediaStreamSource(stream);
                source.connect(analyser);
                
                log('üé§ –ú–∏–∫—Ä–æ—Ñ–æ–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç (–≥–æ–≤–æ—Ä–∏—Ç–µ, –ø—Ä–æ–≤–µ—Ä—è—é —É—Ä–æ–≤–µ–Ω—å...)');
                
                // –¢–µ—Å—Ç –¥–∏–Ω–∞–º–∏–∫–æ–≤
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 440;
                oscillator.type = 'sine';
                gainNode.gain.value = 0.2; // –¢–∏—à–µ, —á—Ç–æ–±—ã –Ω–µ –ø–æ–≤—Ä–µ–¥–∏—Ç—å —Å–ª—É—Ö
                
                oscillator.start();
                log('üîä –¢–µ—Å—Ç–æ–≤—ã–π –∑–≤—É–∫ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è...');
                
                setTimeout(() => {
                    oscillator.stop();
                    stream.getTracks().forEach(track => track.stop());
                    audioContext.close();
                    log('‚úÖ –¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω. –í—Å–µ —Å–∏—Å—Ç–µ–º—ã —Ä–∞–±–æ—Ç–∞—é—Ç!');
                    alert('‚úÖ –¢–µ—Å—Ç –ø—Ä–æ–π–¥–µ–Ω! –ú–∏–∫—Ä–æ—Ñ–æ–Ω –∏ –¥–∏–Ω–∞–º–∏–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç.');
                }, 2000);
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∞: ${error.message}`);
                alert('‚ùå –ü—Ä–æ–±–ª–µ–º–∞ —Å –∞—É–¥–∏–æ! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ –∏ –¥–∏–Ω–∞–º–∏–∫–∏.');
            }
        }

        // ========== –£–ü–†–ê–í–õ–ï–ù–ò–ï –ì–†–û–ú–ö–û–°–¢–¨–Æ ==========
        function setupVolumeControls() {
            const micSlider = document.getElementById('micVolume');
            const speakerSlider = document.getElementById('speakerVolume');
            
            micSlider.oninput = function() {
                if (localStream) {
                    const audioTrack = localStream.getAudioTracks()[0];
                    if (audioTrack) {
                        const settings = audioTrack.getSettings();
                        console.log('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞:', settings);
                    }
                }
            };
            
            speakerSlider.oninput = function() {
                if (remoteAudio) {
                    remoteAudio.volume = this.value / 100;
                    log(`üîä –ì—Ä–æ–º–∫–æ—Å—Ç—å –¥–∏–Ω–∞–º–∏–∫–æ–≤: ${this.value}%`);
                }
            };
        }

        // ========== –ö–û–ú–ù–ê–¢–´ ==========
        function createRoom() {
            currentRoomId = document.getElementById('roomId').value.trim() || '8888';
            document.getElementById('roomId').value = currentRoomId;
            connectToRoom(true);
        }

        function joinRoom() {
            currentRoomId = document.getElementById('roomId').value.trim();
            if (!currentRoomId) {
                alert('–í–≤–µ–¥–∏—Ç–µ ID –∫–æ–º–Ω–∞—Ç—ã');
                return;
            }
            connectToRoom(false);
        }

        function connectToRoom(isCreator) {
            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                database = firebase.database();
                
                isCaller = isCreator;
                
                if (roomRef) roomRef.off();
                roomRef = database.ref(`rooms/${currentRoomId}`);
                
                if (isCreator) {
                    roomRef.remove().catch(() => {});
                }
                
                roomRef.on('value', handleRoomUpdate);
                
                updateStatus(`–í –∫–æ–º–Ω–∞—Ç–µ: ${currentRoomId}`, 'ready');
                log(`${isCreator ? '–°–æ–∑–¥–∞–Ω–∞' : '–í–æ—à–ª–∏ –≤'} –∫–æ–º–Ω–∞—Ç—É ${currentRoomId}`);
                
            } catch (error) {
                log(`–û—à–∏–±–∫–∞: ${error.message}`);
            }
        }

        // ========== –û–ë–†–ê–ë–û–¢–ö–ê –°–û–ë–´–¢–ò–ô ==========
        function handleRoomUpdate(snapshot) {
            const data = snapshot.val();
            if (!data) return;
            
            if (data.callRequest && !isCaller && callStatus === 'idle') {
                showIncomingCall();
            }
            
            if (data.callResponse && callStatus === 'calling') {
                handleCallResponse(data.callResponse);
            }
            
            if (callStatus === 'in_call' && peerConnection) {
                if (data.offer && !isCaller && !hasRemoteDescription) {
                    handleOffer(data.offer);
                }
                
                if (data.answer && isCaller && !hasRemoteDescription) {
                    handleAnswer(data.answer);
                }
                
                if (data.iceCandidate) {
                    handleIceCandidate(data.iceCandidate);
                }
            }
            
            if (data.hangup) {
                handleRemoteHangup();
            }
        }

        function showIncomingCall() {
            document.getElementById('callRoomId').textContent = currentRoomId;
            document.getElementById('incomingModal').style.display = 'flex';
            callStatus = 'ringing';
            updateStatus('–í—Ö–æ–¥—è—â–∏–π –≤—ã–∑–æ–≤!', 'calling');
            log('üìû –í—Ö–æ–¥—è—â–∏–π –≤—ã–∑–æ–≤');
        }

        // ========== –£–ü–†–ê–í–õ–ï–ù–ò–ï –ó–í–û–ù–ö–ê–ú–ò ==========
        function startCall() {
            callStatus = 'calling';
            document.getElementById('waitRoomId').textContent = currentRoomId;
            document.getElementById('waitingModal').style.display = 'flex';
            
            roomRef.update({ 
                callRequest: { time: Date.now() },
                offer: null,
                answer: null,
                iceCandidate: null,
                hangup: null
            });
            
            log('–í—ã–∑—ã–≤–∞—é...');
        }

        function acceptCall() {
            document.getElementById('incomingModal').style.display = 'none';
            callStatus = 'in_call';
            
            roomRef.update({
                callResponse: { accepted: true, time: Date.now() }
            });
            
            startWebRTC(false);
            log('‚úÖ –í—ã–∑–æ–≤ –ø—Ä–∏–Ω—è—Ç');
        }

        function rejectCall() {
            document.getElementById('incomingModal').style.display = 'none';
            callStatus = 'idle';
            
            roomRef.update({
                callResponse: { accepted: false, time: Date.now() }
            });
            
            updateStatus(`–í –∫–æ–º–Ω–∞—Ç–µ: ${currentRoomId}`, 'ready');
            log('–í—ã–∑–æ–≤ –æ—Ç–∫–ª–æ–Ω–µ–Ω');
        }

        function handleCallResponse(response) {
            if (response.accepted) {
                callStatus = 'in_call';
                document.getElementById('waitingModal').style.display = 'none';
                startWebRTC(true);
                log('‚úÖ –í—ã–∑–æ–≤ –ø—Ä–∏–Ω—è—Ç –¥—Ä—É–≥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º');
            } else {
                callStatus = 'idle';
                document.getElementById('waitingModal').style.display = 'none';
                alert('–í—ã–∑–æ–≤ –æ—Ç–∫–ª–æ–Ω–µ–Ω');
                updateStatus(`–í –∫–æ–º–Ω–∞—Ç–µ: ${currentRoomId}`, 'ready');
                log('–í—ã–∑–æ–≤ –æ—Ç–∫–ª–æ–Ω–µ–Ω –¥—Ä—É–≥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º');
            }
        }

        function cancelCall() {
            document.getElementById('waitingModal').style.display = 'none';
            callStatus = 'idle';
            roomRef.update({ callRequest: null });
            updateStatus(`–í –∫–æ–º–Ω–∞—Ç–µ: ${currentRoomId}`, 'ready');
            log('–í—ã–∑–æ–≤ –æ—Ç–º–µ–Ω–µ–Ω');
        }

        // ========== WEBRTC –° –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ú –ó–í–£–ö–û–ú ==========
        async function startWebRTC(isInitiator) {
            try {
                updateStatus('–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∑–≤–æ–Ω–∫–∞...', 'calling');
                
                // –ü–æ–ª—É—á–∞–µ–º –º–∏–∫—Ä–æ—Ñ–æ–Ω —Å –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
                localStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true,
                        channelCount: 1,
                        sampleRate: 48000,
                        latency: 0.01,
                        sampleSize: 16
                    }
                });
                
                log('üé§ –ú–∏–∫—Ä–æ—Ñ–æ–Ω –ø–æ–¥–∫–ª—é—á–µ–Ω');
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Ä–æ–≤–µ–Ω—å –≥—Ä–æ–º–∫–æ—Å—Ç–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
                setupMicrophoneMonitor(localStream);
                
                // –°–æ–∑–¥–∞–µ–º PeerConnection —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º–∏ STUN —Å–µ—Ä–≤–µ—Ä–∞–º–∏
                const config = {
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' },
                        { urls: 'stun:stun2.l.google.com:19302' },
                        { urls: 'stun:stun3.l.google.com:19302' },
                        { urls: 'stun:stun4.l.google.com:19302' }
                    ],
                    iceTransportPolicy: 'all',
                    iceCandidatePoolSize: 10,
                    bundlePolicy: 'max-bundle',
                    rtcpMuxPolicy: 'require'
                };
                
                peerConnection = new RTCPeerConnection(config);
                pendingIceCandidates = [];
                hasRemoteDescription = false;
                hasLocalDescription = false;
                
                // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π —Ç—Ä–µ–∫
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
                
                // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
                setupPeerConnectionHandlers();
                
                // –ï—Å–ª–∏ –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä - —Å–æ–∑–¥–∞–µ–º offer
                if (isInitiator) {
                    await createOffer();
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∑–≤–æ–Ω–æ–∫
                document.getElementById('activeRoomId').textContent = currentRoomId;
                document.getElementById('activeModal').style.display = 'flex';
                updateStatus('–†–∞–∑–≥–æ–≤–æ—Ä –∞–∫—Ç–∏–≤–µ–Ω', 'connected', '–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ...');
                document.getElementById('volumeControls').style.display = 'block';
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`);
                hangUp();
            }
        }

        function setupMicrophoneMonitor(stream) {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            
            const source = audioContext.createMediaStreamSource(stream);
            const analyser = audioContext.createAnalyser();
            source.connect(analyser);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Ä–æ–≤–µ–Ω—å –∑–≤—É–∫–∞
            setTimeout(() => {
                const dataArray = new Uint8Array(analyser.frequencyBinCount);
                analyser.getByteFrequencyData(dataArray);
                const average = dataArray.reduce((a, b) => a + b) / dataArray.length;
                
                if (average < 10) {
                    log('‚ö†Ô∏è –ú–∏–∫—Ä–æ—Ñ–æ–Ω –æ—á–µ–Ω—å —Ç–∏—Ö–∏–π! –ì–æ–≤–æ—Ä–∏—Ç–µ –≥—Ä–æ–º—á–µ –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏');
                } else {
                    log(`‚úÖ –£—Ä–æ–≤–µ–Ω—å –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞: ${average.toFixed(1)}`);
                }
            }, 1000);
        }

        function setupPeerConnectionHandlers() {
            // ICE –∫–∞–Ω–¥–∏–¥–∞—Ç—ã
            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    log(`‚ùÑÔ∏è ICE: ${event.candidate.type} ${event.candidate.protocol}`);
                    roomRef.update({ iceCandidate: event.candidate });
                }
            };
            
            // –£–¥–∞–ª–µ–Ω–Ω—ã–π –ø–æ—Ç–æ–∫ - –ö–õ–Æ–ß–ï–í–û–ô –ú–û–ú–ï–ù–¢!
            peerConnection.ontrack = (event) => {
                log('üîä –ü–æ–ª—É—á–µ–Ω —É–¥–∞–ª–µ–Ω–Ω—ã–π –∑–≤—É–∫–æ–≤–æ–π –ø–æ—Ç–æ–∫!');
                
                if (!remoteStream) {
                    remoteStream = new MediaStream();
                }
                
                if (event.streams && event.streams[0]) {
                    remoteStream = event.streams[0];
                } else {
                    remoteStream.addTrack(event.track);
                }
                
                // –°–æ–∑–¥–∞–µ–º –∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –∞—É–¥–∏–æ
                if (!remoteAudio) {
                    remoteAudio = new Audio();
                    remoteAudio.autoplay = true;
                    remoteAudio.volume = 1.0;
                    remoteAudio.muted = false;
                    
                    // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –≥—Ä–æ–º–∫–æ—Å—Ç—å —á–µ—Ä–µ–∑ Web Audio API –¥–ª—è –±–æ–ª—å—à–µ–π –≥—Ä–æ–º–∫–æ—Å—Ç–∏
                    if (!audioContext) {
                        audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    }
                    
                    const source = audioContext.createMediaStreamSource(remoteStream);
                    gainNode = audioContext.createGain();
                    gainNode.gain.value = 2.0; // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –≥—Ä–æ–º–∫–æ—Å—Ç—å –≤ 2 —Ä–∞–∑–∞
                    
                    source.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    // –¢–∞–∫–∂–µ –ø–æ–¥–∫–ª—é—á–∞–µ–º –∫ –æ–±—ã—á–Ω–æ–º—É Audio –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
                    remoteAudio.srcObject = remoteStream;
                } else {
                    remoteAudio.srcObject = remoteStream;
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
                setTimeout(() => {
                    if (remoteAudio && remoteAudio.duration > 0 && !remoteAudio.paused) {
                        log('‚úÖ –ó–í–£–ö –†–ê–ë–û–¢–ê–ï–¢! –ì–æ–≤–æ—Ä–∏—Ç–µ!');
                        updateStatus('–°–û–ï–î–ò–ù–ï–ù–ò–ï –£–°–¢–ê–ù–û–í–õ–ï–ù–û!', 'connected', '–ó–≤—É–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç!');
                        document.getElementById('callInfo').textContent = '‚úÖ –ó–≤—É–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç! –ú–æ–∂–µ—Ç–µ –≥–æ–≤–æ—Ä–∏—Ç—å.';
                        
                        // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –≥—Ä–æ–º–∫–æ—Å—Ç—å
                        remoteAudio.volume = 1.0;
                        if (gainNode) {
                            gainNode.gain.value = 3.0; // –ï—â–µ –±–æ–ª—å—à–µ —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –≥—Ä–æ–º–∫–æ—Å—Ç—å
                        }
                    } else {
                        log('‚ö†Ô∏è –ê—É–¥–∏–æ –Ω–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏');
                        remoteAudio.play().catch(e => {
                            log(`‚ùå –û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è: ${e.message}`);
                            // –ü—Ä–æ–±—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –º–µ—Ç–æ–¥
                            const tempAudio = new Audio();
                            tempAudio.srcObject = remoteStream;
                            tempAudio.play();
                        });
                    }
                }, 2000);
            };
            
            // –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
            peerConnection.onconnectionstatechange = () => {
                const state = peerConnection.connectionState;
                log(`üîó –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ: ${state}`);
                
                if (state === 'connected') {
                    log('üéâ –°–û–ï–î–ò–ù–ï–ù–ò–ï –£–°–¢–ê–ù–û–í–õ–ï–ù–û!');
                    document.getElementById('callInfo').textContent = '–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ';
                }
            };
            
            // –°–æ–±—ã—Ç–∏–µ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
            peerConnection.ondatachannel = (event) => {
                log('üìä Data channel –ø–æ–ª—É—á–µ–Ω');
            };
        }

        async function createOffer() {
            try {
                log('–°–æ–∑–¥–∞—é –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ...');
                
                const offer = await peerConnection.createOffer({
                    offerToReceiveAudio: true,
                    offerToReceiveVideo: false,
                    voiceActivityDetection: false
                });
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–¥–µ–∫ –ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω–æ Opus
                const updatedOffer = {
                    ...offer,
                    sdp: offer.sdp.replace(/a=fmtp:111/, 'a=fmtp:111 minptime=10; useinbandfec=1')
                };
                
                log(`–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ`);
                
                await peerConnection.setLocalDescription(updatedOffer);
                hasLocalDescription = true;
                log('–õ–æ–∫–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
                
                await roomRef.update({ offer: updatedOffer });
                log('–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ');
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è: ${error.message}`);
            }
        }

        async function handleOffer(offer) {
            try {
                if (hasRemoteDescription) return;
                
                log('–ü–æ–ª—É—á–µ–Ω–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ, —Å–æ–∑–¥–∞—é –æ—Ç–≤–µ—Ç...');
                
                await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
                hasRemoteDescription = true;
                log('–£–¥–∞–ª–µ–Ω–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
                
                const answer = await peerConnection.createAnswer({
                    offerToReceiveAudio: true,
                    offerToReceiveVideo: false
                });
                
                log(`–û—Ç–≤–µ—Ç —Å–æ–∑–¥–∞–Ω`);
                
                await peerConnection.setLocalDescription(answer);
                hasLocalDescription = true;
                log('–õ–æ–∫–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
                
                await roomRef.update({ answer: answer });
                log('–û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω');
                
                applyPendingCandidates();
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è: ${error.message}`);
            }
        }

        async function handleAnswer(answer) {
            try {
                if (hasRemoteDescription) return;
                
                log('–ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é...');
                
                await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
                hasRemoteDescription = true;
                log('–£–¥–∞–ª–µ–Ω–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
                
                applyPendingCandidates();
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—Ç–≤–µ—Ç–∞: ${error.message}`);
            }
        }

        async function handleIceCandidate(candidate) {
            if (!peerConnection || !peerConnection.remoteDescription) {
                pendingIceCandidates.push(candidate);
                return;
            }
            
            try {
                await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
                log('‚ùÑÔ∏è ICE –∫–∞–Ω–¥–∏–¥–∞—Ç –¥–æ–±–∞–≤–ª–µ–Ω');
                
            } catch (error) {
                log(`‚ö†Ô∏è –û—à–∏–±–∫–∞ ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–∞: ${error.message}`);
            }
        }

        function applyPendingCandidates() {
            if (!peerConnection || !peerConnection.remoteDescription) return;
            
            while (pendingIceCandidates.length > 0) {
                const candidate = pendingIceCandidates.shift();
                peerConnection.addIceCandidate(new RTCIceCandidate(candidate))
                    .catch(err => log(`‚ö†Ô∏è –û—à–∏–±–∫–∞ –æ—Ç–ª–æ–∂–µ–Ω–Ω–æ–≥–æ ICE: ${err.message}`));
            }
        }

        // ========== –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ==========
        function toggleMute() {
            if (!localStream) return;
            
            const audioTrack = localStream.getAudioTracks()[0];
            if (audioTrack) {
                microphoneMuted = !microphoneMuted;
                audioTrack.enabled = !microphoneMuted;
                
                const muteBtn = document.getElementById('muteBtn');
                if (microphoneMuted) {
                    muteBtn.innerHTML = 'üé§ –í–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω';
                    muteBtn.style.background = '#e74c3c';
                    log('üîá –ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤—ã–∫–ª—é—á–µ–Ω');
                } else {
                    muteBtn.innerHTML = 'üîá –í—ã–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω';
                    muteBtn.style.background = '#34495e';
                    log('üé§ –ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤–∫–ª—é—á–µ–Ω');
                }
            }
        }

        function handleRemoteHangup() {
            log('–°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –∑–∞–≤–µ—Ä—à–∏–ª –∑–≤–æ–Ω–æ–∫');
            alert('–°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –∑–∞–≤–µ—Ä—à–∏–ª –∑–≤–æ–Ω–æ–∫');
            hangUp();
        }

        // ========== –ó–ê–í–ï–†–®–ï–ù–ò–ï ==========
        function hangUp() {
            log('–ó–∞–≤–µ—Ä—à–∞—é –∑–≤–æ–Ω–æ–∫...');
            
            if (roomRef) {
                roomRef.update({ 
                    hangup: true,
                    callRequest: null,
                    callResponse: null,
                    offer: null,
                    answer: null,
                    iceCandidate: null
                }).catch(() => {});
            }
            
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            
            if (remoteStream) {
                remoteStream.getTracks().forEach(track => track.stop());
                remoteStream = null;
            }
            
            if (remoteAudio) {
                remoteAudio.pause();
                remoteAudio.srcObject = null;
                remoteAudio = null;
            }
            
            if (audioContext && audioContext.state !== 'closed') {
                audioContext.close();
                audioContext = null;
            }
            
            pendingIceCandidates = [];
            hasRemoteDescription = false;
            hasLocalDescription = false;
            microphoneMuted = false;
            
            document.getElementById('incomingModal').style.display = 'none';
            document.getElementById('waitingModal').style.display = 'none';
            document.getElementById('activeModal').style.display = 'none';
            document.getElementById('volumeControls').style.display = 'none';
            
            if (currentRoomId) {
                updateStatus(`–í –∫–æ–º–Ω–∞—Ç–µ: ${currentRoomId}`, 'ready');
            } else {
                updateStatus('–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ', '');
            }
            
            callStatus = 'idle';
            log('–ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω');
        }

        // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
        function init() {
            log('‚úÖ –ó–≤–æ–Ω–∏–ª–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
            updateStatus('–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ', '');
            
            if (!navigator.mediaDevices || !window.RTCPeerConnection) {
                alert('‚ùå –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç WebRTC! –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Chrome/Firefox/Edge.');
                return;
            }
            
            log('‚úÖ WebRTC –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
            setupVolumeControls();
            
            // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω –∑–∞—Ä–∞–Ω–µ–µ
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    stream.getTracks().forEach(track => track.stop());
                    log('‚úÖ –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω –ø–æ–ª—É—á–µ–Ω–æ');
                })
                .catch(err => {
                    log('‚ö†Ô∏è –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –ø–æ–ª—É—á–µ–Ω–æ');
                });
        }

        window.addEventListener('beforeunload', () => {
            if (callStatus === 'in_call') hangUp();
            if (roomRef) roomRef.off();
        });

        window.onload = init;
    </script>
</body>
</html>
