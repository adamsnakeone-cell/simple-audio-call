<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéß –ó–í–û–ù–ò–õ–ö–ê (–§–ò–ù–ê–õ–¨–ù–´–ô –†–ê–ë–û–ß–ò–ô –í–ê–†–ò–ê–ù–¢)</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
        body { background: #000; color: #0f0; font-family: 'Courier New', monospace; }
        .container { max-width: 600px; margin: 0 auto; padding: 20px; }
        h1 { text-align: center; color: #0f0; margin-bottom: 30px; text-shadow: 0 0 10px #0f0; }
        .panel { background: #111; border: 1px solid #0f0; border-radius: 5px; padding: 20px; margin-bottom: 20px; }
        input { width: 100%; padding: 10px; background: #000; border: 1px solid #0f0; color: #0f0; border-radius: 3px; margin-bottom: 10px; }
        .buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0; }
        button { padding: 12px; background: #222; border: 1px solid #0f0; color: #0f0; border-radius: 3px; cursor: pointer; font-weight: bold; }
        button:hover { background: #333; }
        button:active { background: #444; }
        button:disabled { background: #111; border-color: #333; color: #333; cursor: not-allowed; }
        #createBtn { background: #003300; }
        #joinBtn { background: #000033; }
        #callBtn { background: #330000; grid-column: span 2; }
        #hangupBtn { background: #330000; grid-column: span 2; }
        .status { margin: 15px 0; padding: 10px; background: #111; border: 1px solid #0f0; border-radius: 3px; min-height: 60px; }
        .log { height: 300px; overflow-y: auto; background: #000; border: 1px solid #0f0; padding: 10px; margin-top: 20px; font-size: 12px; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; }
        .modal-content { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #111; border: 2px solid #0f0; padding: 30px; border-radius: 5px; text-align: center; }
        .modal-buttons { display: flex; gap: 15px; margin-top: 20px; }
        .modal-buttons button { flex: 1; }
        .accept-btn { background: #003300; }
        .reject-btn { background: #330000; }
        .debug { font-size: 11px; color: #666; margin-top: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéß –ó–í–û–ù–ò–õ–ö–ê v3.0</h1>
        
        <div class="panel">
            <input type="text" id="roomId" placeholder="ID –∫–æ–º–Ω–∞—Ç—ã" value="1234">
            
            <div class="buttons">
                <button id="createBtn" onclick="createRoom()">–°–û–ó–î–ê–¢–¨ –ö–û–ú–ù–ê–¢–£</button>
                <button id="joinBtn" onclick="joinRoom()">–í–û–ô–¢–ò –í –ö–û–ú–ù–ê–¢–£</button>
            </div>
            
            <div class="status" id="statusBox">
                <div id="statusText">–°—Ç–∞—Ç—É—Å: –û–∂–∏–¥–∞–Ω–∏–µ</div>
                <div id="debugInfo" class="debug"></div>
            </div>
            
            <div class="buttons">
                <button id="callBtn" onclick="startCall()" disabled>üìû –ù–ê–ß–ê–¢–¨ –ó–í–û–ù–û–ö</button>
                <button id="hangupBtn" onclick="hangUp()" disabled>‚ùå –ó–ê–í–ï–†–®–ò–¢–¨ –ó–í–û–ù–û–ö</button>
            </div>
            
            <div style="margin-top: 15px; text-align: center;">
                <button onclick="resetConnection()" style="background: #333300; width: 100%;">
                    üîÑ –°–ë–†–û–°–ò–¢–¨ –°–û–ï–î–ò–ù–ï–ù–ò–ï
                </button>
            </div>
        </div>
        
        <div class="panel">
            <h3 style="margin-bottom: 10px;">–õ–û–ì –°–û–ë–´–¢–ò–ô:</h3>
            <div class="log" id="logBox"></div>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª–∫–∏ -->
    <div class="modal" id="incomingModal">
        <div class="modal-content">
            <div style="font-size: 40px; margin-bottom: 20px;">üìû</div>
            <h2>–í–•–û–î–Ø–©–ò–ô –í–´–ó–û–í</h2>
            <p>–ö–æ–º–Ω–∞—Ç–∞: <strong id="callRoomId"></strong></p>
            <div class="modal-buttons">
                <button class="accept-btn" onclick="acceptCall()">‚úÖ –ü–†–ò–ù–Ø–¢–¨</button>
                <button class="reject-btn" onclick="rejectCall()">‚ùå –û–¢–ö–õ–û–ù–ò–¢–¨</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="waitingModal">
        <div class="modal-content">
            <div style="font-size: 40px; margin-bottom: 20px;">‚è≥</div>
            <h2>–û–ñ–ò–î–ê–ù–ò–ï –û–¢–í–ï–¢–ê</h2>
            <p>–ö–æ–º–Ω–∞—Ç–∞: <strong id="waitRoomId"></strong></p>
            <button class="reject-btn" onclick="cancelCall()">–û–¢–ú–ï–ù–ò–¢–¨</button>
        </div>
    </div>
    
    <div class="modal" id="activeModal">
        <div class="modal-content">
            <div style="font-size: 40px; margin-bottom: 20px;">üéß</div>
            <h2>–†–ê–ó–ì–û–í–û–† –ê–ö–¢–ò–í–ï–ù</h2>
            <p>–ö–æ–º–Ω–∞—Ç–∞: <strong id="activeRoomId"></strong></p>
            <div id="connectionStats" style="margin: 20px 0; color: #0f0;"></div>
            <button class="reject-btn" onclick="hangUp()">–ó–ê–í–ï–†–®–ò–¢–¨ –ó–í–û–ù–û–ö</button>
        </div>
    </div>

    <script>
        // ========== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ==========
        const firebaseConfig = {
            apiKey: "AIzaSyDdlYdrHiGWd73F_pmwMKHrX92gK-G7kB8",
            databaseURL: "https://simple-audio-call-default-rtdb.europe-west1.firebasedatabase.app"
        };

        // ========== –ü–ï–†–ï–ú–ï–ù–ù–´–ï –ò –°–û–°–¢–û–Ø–ù–ò–Ø ==========
        let localStream = null;
        let peerConnection = null;
        let database = null;
        let roomRef = null;
        let currentRoomId = null;
        let isCaller = false;
        let callState = {
            status: 'idle', // idle, calling, ringing, in_call, error
            lastAction: null,
            peerState: null,
            connectionType: null
        };
        let lastOfferTime = 0;
        let lastAnswerTime = 0;
        let retryCount = 0;
        const MAX_RETRIES = 3;

        // ========== –õ–û–ì–ò–†–û–í–ê–ù–ò–ï ==========
        function log(message, type = 'info') {
            const logBox = document.getElementById('logBox');
            const time = new Date().toLocaleTimeString();
            const colors = {
                'success': '#00ff00',
                'error': '#ff0000',
                'warning': '#ffff00',
                'info': '#00ffff'
            };
            
            const entry = document.createElement('div');
            entry.innerHTML = `<span style="color: #888">[${time}]</span> <span style="color: ${colors[type] || '#ffffff'}">${message}</span>`;
            logBox.appendChild(entry);
            logBox.scrollTop = logBox.scrollHeight;
            console.log(`[${type}] ${message}`);
        }

        function updateDebugInfo() {
            const info = `–°—Ç–∞—Ç—É—Å: ${callState.status} | Peer: ${callState.peerState || '–Ω–µ—Ç'} | –ü–æ–ø—ã—Ç–∫–∞: ${retryCount}`;
            document.getElementById('debugInfo').textContent = info;
        }

        function updateStatus(text) {
            document.getElementById('statusText').textContent = text;
            updateDebugInfo();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏
            const canCall = currentRoomId && callState.status === 'idle';
            document.getElementById('callBtn').disabled = !canCall;
            document.getElementById('hangupBtn').disabled = callState.status !== 'in_call';
        }

        // ========== –°–ë–†–û–° –°–û–ï–î–ò–ù–ï–ù–ò–Ø ==========
        function resetConnection() {
            log('üîÑ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π —Å–±—Ä–æ—Å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è...', 'warning');
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å—ë
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            callState = {
                status: 'idle',
                lastAction: null,
                peerState: null,
                connectionType: null
            };
            
            retryCount = 0;
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –º–æ–¥–∞–ª–∫–∏
            document.getElementById('incomingModal').style.display = 'none';
            document.getElementById('waitingModal').style.display = 'none';
            document.getElementById('activeModal').style.display = 'none';
            
            updateStatus('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å–±—Ä–æ—à–µ–Ω–æ');
            log('‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–±—Ä–æ—à–µ–Ω–æ', 'success');
        }

        // ========== –ö–û–ú–ù–ê–¢–´ ==========
        function createRoom() {
            currentRoomId = document.getElementById('roomId').value.trim() || '1234';
            document.getElementById('roomId').value = currentRoomId;
            connectToRoom(true);
        }

        function joinRoom() {
            currentRoomId = document.getElementById('roomId').value.trim();
            if (!currentRoomId) {
                alert('–í–≤–µ–¥–∏—Ç–µ ID –∫–æ–º–Ω–∞—Ç—ã');
                return;
            }
            connectToRoom(false);
        }

        function connectToRoom(isCreator) {
            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                database = firebase.database();
                
                isCaller = isCreator;
                callState.status = 'idle';
                retryCount = 0;
                
                if (roomRef) {
                    roomRef.off();
                    roomRef = null;
                }
                
                roomRef = database.ref(`rooms/${currentRoomId}`);
                
                if (isCreator) {
                    // –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –∫–æ–º–Ω–∞—Ç—ã
                    roomRef.set({
                        _created: Date.now(),
                        _creator: 'user'
                    }).catch(() => {});
                }
                
                // –°–ª—É—à–∞–µ–º —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è
                roomRef.on('child_changed', handleRoomUpdate);
                roomRef.on('child_added', handleRoomUpdate);
                
                updateStatus(`–í –∫–æ–º–Ω–∞—Ç–µ: ${currentRoomId}`);
                log(`${isCreator ? '–°–æ–∑–¥–∞–Ω–∞' : '–í–æ—à–ª–∏ –≤'} –∫–æ–º–Ω–∞—Ç—É ${currentRoomId}`, 'success');
                
            } catch (error) {
                log(`–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${error.message}`, 'error');
            }
        }

        // ========== –û–ë–†–ê–ë–û–¢–ö–ê –°–û–ë–´–¢–ò–ô –ö–û–ú–ù–ê–¢–´ ==========
        function handleRoomUpdate(snapshot) {
            const key = snapshot.key;
            const value = snapshot.val();
            
            if (!value) return;
            
            log(`–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ: ${key} = ${JSON.stringify(value).substring(0, 100)}`, 'info');
            
            switch(key) {
                case 'callRequest':
                    if (!isCaller && callState.status === 'idle') {
                        showIncomingCall();
                    }
                    break;
                    
                case 'callResponse':
                    if (callState.status === 'calling' && value.accepted !== undefined) {
                        handleCallResponse(value);
                    }
                    break;
                    
                case 'offer':
                    if (!isCaller && callState.status === 'in_call' && peerConnection) {
                        // –ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
                        if (Date.now() - lastOfferTime > 1000) {
                            lastOfferTime = Date.now();
                            handleOffer(value);
                        }
                    }
                    break;
                    
                case 'answer':
                    if (isCaller && callState.status === 'in_call' && peerConnection) {
                        // –ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
                        if (Date.now() - lastAnswerTime > 1000) {
                            lastAnswerTime = Date.now();
                            handleAnswer(value);
                        }
                    }
                    break;
                    
                case 'iceCandidate':
                    if (callState.status === 'in_call' && peerConnection) {
                        handleIceCandidate(value);
                    }
                    break;
                    
                case 'hangup':
                    if (value && callState.status === 'in_call') {
                        handleRemoteHangup();
                    }
                    break;
            }
        }

        function showIncomingCall() {
            if (callState.status !== 'idle') return;
            
            document.getElementById('callRoomId').textContent = currentRoomId;
            document.getElementById('incomingModal').style.display = 'flex';
            callState.status = 'ringing';
            updateStatus('–í–•–û–î–Ø–©–ò–ô –í–´–ó–û–í');
            log('üìû –í—Ö–æ–¥—è—â–∏–π –≤—ã–∑–æ–≤', 'info');
        }

        // ========== –£–ü–†–ê–í–õ–ï–ù–ò–ï –ó–í–û–ù–ö–ê–ú–ò ==========
        function startCall() {
            if (callState.status !== 'idle') return;
            
            callState.status = 'calling';
            document.getElementById('waitRoomId').textContent = currentRoomId;
            document.getElementById('waitingModal').style.display = 'flex';
            
            // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ
            roomRef.update({
                callRequest: { time: Date.now(), attempt: ++retryCount },
                offer: null,
                answer: null,
                iceCandidate: null,
                hangup: null
            }).catch(() => {});
            
            updateStatus('–í—ã–∑—ã–≤–∞—é...');
            log('–ù–∞—á–∏–Ω–∞—é –≤—ã–∑–æ–≤...', 'info');
        }

        function acceptCall() {
            document.getElementById('incomingModal').style.display = 'none';
            callState.status = 'in_call';
            
            roomRef.update({
                callResponse: { accepted: true, time: Date.now() },
                offer: null,
                answer: null,
                iceCandidate: null,
                hangup: null
            });
            
            initializePeerConnection(false);
            log('‚úÖ –í—ã–∑–æ–≤ –ø—Ä–∏–Ω—è—Ç', 'success');
        }

        function rejectCall() {
            document.getElementById('incomingModal').style.display = 'none';
            callState.status = 'idle';
            
            roomRef.update({
                callResponse: { accepted: false, time: Date.now() }
            });
            
            updateStatus(`–í –∫–æ–º–Ω–∞—Ç–µ: ${currentRoomId}`);
            log('–í—ã–∑–æ–≤ –æ—Ç–∫–ª–æ–Ω–µ–Ω', 'warning');
        }

        function handleCallResponse(response) {
            if (response.accepted) {
                callState.status = 'in_call';
                document.getElementById('waitingModal').style.display = 'none';
                initializePeerConnection(true);
                log('‚úÖ –í—ã–∑–æ–≤ –ø—Ä–∏–Ω—è—Ç –¥—Ä—É–≥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º', 'success');
            } else {
                callState.status = 'idle';
                document.getElementById('waitingModal').style.display = 'none';
                alert('–í—ã–∑–æ–≤ –æ—Ç–∫–ª–æ–Ω–µ–Ω');
                updateStatus(`–í –∫–æ–º–Ω–∞—Ç–µ: ${currentRoomId}`);
                log('–í—ã–∑–æ–≤ –æ—Ç–∫–ª–æ–Ω–µ–Ω –¥—Ä—É–≥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º', 'warning');
            }
        }

        function cancelCall() {
            document.getElementById('waitingModal').style.display = 'none';
            callState.status = 'idle';
            roomRef.update({ callRequest: null });
            updateStatus(`–í –∫–æ–º–Ω–∞—Ç–µ: ${currentRoomId}`);
            log('–í—ã–∑–æ–≤ –æ—Ç–º–µ–Ω–µ–Ω', 'warning');
        }

        // ========== PEER CONNECTION (–ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô) ==========
        async function initializePeerConnection(isInitiator) {
            try {
                updateStatus('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è...');
                
                // –°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∞–µ–º –º–∏–∫—Ä–æ—Ñ–æ–Ω
                localStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        channelCount: 1,
                        sampleRate: 16000,
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }
                });
                
                log('üé§ –ú–∏–∫—Ä–æ—Ñ–æ–Ω –ø–æ–¥–∫–ª—é—á–µ–Ω', 'success');
                
                // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π PeerConnection
                if (peerConnection) {
                    peerConnection.close();
                }
                
                peerConnection = new RTCPeerConnection({
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' },
                        { urls: 'stun:stun2.l.google.com:19302' }
                    ],
                    iceTransportPolicy: 'all'
                });
                
                callState.peerState = 'new';
                
                // –î–æ–±–∞–≤–ª—è–µ–º —Ç—Ä–µ–∫–∏
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
                
                // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
                setupPeerConnectionHandlers(isInitiator);
                
                // –ï—Å–ª–∏ –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä - —Å–æ–∑–¥–∞–µ–º offer
                if (isInitiator) {
                    await createAndSendOffer();
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∑–≤–æ–Ω–æ–∫
                document.getElementById('activeRoomId').textContent = currentRoomId;
                document.getElementById('activeModal').style.display = 'flex';
                updateStatus('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è...');
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ${error.message}`, 'error');
                hangUp();
            }
        }

        function setupPeerConnectionHandlers(isInitiator) {
            // ICE –∫–∞–Ω–¥–∏–¥–∞—Ç—ã
            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    const candidate = event.candidate;
                    log(`‚ùÑÔ∏è ICE: ${candidate.type} ${candidate.protocol}`, 'info');
                    
                    roomRef.update({
                        iceCandidate: candidate,
                        candidateTime: Date.now()
                    }).catch(() => {});
                }
            };
            
            // –£–¥–∞–ª–µ–Ω–Ω—ã–π –ø–æ—Ç–æ–∫
            peerConnection.ontrack = (event) => {
                log('üîä –ü–æ–ª—É—á–µ–Ω —É–¥–∞–ª–µ–Ω–Ω—ã–π –∞—É–¥–∏–æ–ø–æ—Ç–æ–∫', 'success');
                
                // –°–æ–∑–¥–∞–µ–º –∞—É–¥–∏–æ —ç–ª–µ–º–µ–Ω—Ç
                const audio = new Audio();
                audio.srcObject = event.streams[0];
                audio.autoplay = true;
                audio.volume = 1.0;
                audio.muted = false;
                
                // –ü—ã—Ç–∞–µ–º—Å—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏
                audio.play().then(() => {
                    log('‚úÖ –ó–≤—É–∫ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è!', 'success');
                    document.getElementById('connectionStats').textContent = '‚úÖ –ó–í–£–ö –†–ê–ë–û–¢–ê–ï–¢';
                    updateStatus('–†–ê–ó–ì–û–í–û–† –ê–ö–¢–ò–í–ï–ù');
                }).catch(error => {
                    log(`‚ö†Ô∏è –ê–≤—Ç–æ–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ: ${error.message}`, 'warning');
                    document.getElementById('connectionStats').textContent = '–ù–∞–∂–º–∏—Ç–µ —Ä–∞–∑—Ä–µ—à–∏—Ç—å –∞–≤—Ç–æ–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ';
                });
            };
            
            // ICE —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            peerConnection.oniceconnectionstatechange = () => {
                const state = peerConnection.iceConnectionState;
                callState.peerState = state;
                log(`üßä ICE —Å–æ—Å—Ç–æ—è–Ω–∏–µ: ${state}`, 'info');
                
                if (state === 'connected' || state === 'completed') {
                    log('‚úÖ ICE —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!', 'success');
                    callState.connectionType = 'P2P';
                }
                
                if (state === 'failed') {
                    log('‚ùå ICE —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å', 'error');
                    if (retryCount < MAX_RETRIES) {
                        setTimeout(() => retryConnection(), 2000);
                    }
                }
            };
            
            // –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
            peerConnection.onconnectionstatechange = () => {
                const state = peerConnection.connectionState;
                log(`üîó –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ${state}`, 'info');
                
                if (state === 'connected') {
                    log('üéâ –°–û–ï–î–ò–ù–ï–ù–ò–ï –£–°–¢–ê–ù–û–í–õ–ï–ù–û!', 'success');
                    callState.status = 'in_call';
                }
            };
            
            // –°–∏–≥–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ - –í–ê–ñ–ù–û –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
            peerConnection.onsignalingstatechange = () => {
                const state = peerConnection.signalingState;
                log(`üì∂ –°–∏–≥–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ: ${state}`, 'info');
                callState.lastAction = state;
            };
        }

        async function createAndSendOffer() {
            try {
                log('–°–æ–∑–¥–∞—é –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ...', 'info');
                
                const offer = await peerConnection.createOffer({
                    offerToReceiveAudio: true
                });
                
                log(`–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ: ${offer.type}`, 'info');
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
                await peerConnection.setLocalDescription(offer);
                log('–õ–æ–∫–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ', 'success');
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Firebase
                await roomRef.update({
                    offer: offer,
                    offerTime: Date.now()
                });
                log('–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ', 'success');
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è: ${error.message}`, 'error');
            }
        }

        async function handleOffer(offer) {
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                if (peerConnection.signalingState !== 'stable') {
                    log(`‚ö†Ô∏è –û—Ç–∫–ª–æ–Ω—è—é offer: —Å–æ—Å—Ç–æ—è–Ω–∏–µ ${peerConnection.signalingState}`, 'warning');
                    return;
                }
                
                log('–ü–æ–ª—É—á–∞—é –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ...', 'info');
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —É–¥–∞–ª–µ–Ω–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
                await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
                log('–£–¥–∞–ª–µ–Ω–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ', 'success');
                
                // –°–æ–∑–¥–∞–µ–º –æ—Ç–≤–µ—Ç
                const answer = await peerConnection.createAnswer();
                log(`–û—Ç–≤–µ—Ç —Å–æ–∑–¥–∞–Ω: ${answer.type}`, 'info');
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
                await peerConnection.setLocalDescription(answer);
                log('–õ–æ–∫–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ', 'success');
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç
                await roomRef.update({
                    answer: answer,
                    answerTime: Date.now()
                });
                log('–û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω', 'success');
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è: ${error.message}`, 'error');
                
                // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è - –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º
                if (error.name === 'InvalidStateError') {
                    log('üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—é –∏–∑-–∑–∞ –æ—à–∏–±–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è...', 'warning');
                    setTimeout(() => {
                        if (callState.status === 'in_call') {
                            renegotiateConnection();
                        }
                    }, 1000);
                }
            }
        }

        async function handleAnswer(answer) {
            try {
                // –í–ê–ñ–ù–û: –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –º—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏
                const expectedState = isCaller ? 'have-local-offer' : 'stable';
                if (peerConnection.signalingState !== expectedState) {
                    log(`‚ö†Ô∏è –û—Ç–∫–ª–æ–Ω—è—é answer: –æ–∂–∏–¥–∞–ª ${expectedState}, –ø–æ–ª—É—á–∏–ª ${peerConnection.signalingState}`, 'warning');
                    return;
                }
                
                log('–ü–æ–ª—É—á–∞—é –æ—Ç–≤–µ—Ç...', 'info');
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —É–¥–∞–ª–µ–Ω–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
                await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
                log('–û—Ç–≤–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω', 'success');
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—Ç–≤–µ—Ç–∞: ${error.message}`, 'error');
                
                // –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è
                if (error.message.includes('wrong state') || error.message.includes('stable')) {
                    log('‚ö†Ô∏è –ü–æ–ø—ã—Ç–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è...', 'warning');
                    
                    // –ñ–¥–µ–º –ø–æ–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å—Ç–∞–±–∏–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è
                    setTimeout(() => {
                        if (peerConnection && peerConnection.signalingState === 'have-local-offer') {
                            handleAnswer(answer); // –ü—Ä–æ–±—É–µ–º —Å–Ω–æ–≤–∞
                        } else {
                            log('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ', 'error');
                            renegotiateConnection();
                        }
                    }, 500);
                }
            }
        }

        async function handleIceCandidate(candidate) {
            try {
                if (peerConnection && peerConnection.remoteDescription) {
                    await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
                }
            } catch (error) {
                // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
            }
        }

        function renegotiateConnection() {
            if (retryCount >= MAX_RETRIES) {
                log('‚ùå –î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç –ø–æ–ø—ã—Ç–æ–∫ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è', 'error');
                hangUp();
                return;
            }
            
            retryCount++;
            log(`üîÑ –ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è #${retryCount}`, 'warning');
            
            // –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
            initializePeerConnection(isCaller);
        }

        function retryConnection() {
            if (callState.status === 'in_call' && retryCount < MAX_RETRIES) {
                renegotiateConnection();
            }
        }

        function handleRemoteHangup() {
            log('–°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –∑–∞–≤–µ—Ä—à–∏–ª –∑–≤–æ–Ω–æ–∫', 'warning');
            alert('–°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –∑–∞–≤–µ—Ä—à–∏–ª –∑–≤–æ–Ω–æ–∫');
            hangUp();
        }

        // ========== –ó–ê–í–ï–†–®–ï–ù–ò–ï ==========
        function hangUp() {
            log('–ó–∞–≤–µ—Ä—à–∞—é –∑–≤–æ–Ω–æ–∫...', 'warning');
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–∏–≥–Ω–∞–ª –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏
            if (roomRef) {
                roomRef.update({
                    hangup: true,
                    hangupTime: Date.now()
                }).catch(() => {});
                
                // –û—Ç–ø–∏—Å—ã–≤–∞–µ–º—Å—è –æ—Ç —Å–æ–±—ã—Ç–∏–π
                setTimeout(() => roomRef.off(), 1000);
            }
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º PeerConnection
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            callState = {
                status: 'idle',
                lastAction: null,
                peerState: null,
                connectionType: null
            };
            
            retryCount = 0;
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫–∏
            document.getElementById('incomingModal').style.display = 'none';
            document.getElementById('waitingModal').style.display = 'none';
            document.getElementById('activeModal').style.display = 'none';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
            if (currentRoomId) {
                updateStatus(`–í –∫–æ–º–Ω–∞—Ç–µ: ${currentRoomId}`);
            } else {
                updateStatus('–û–∂–∏–¥–∞–Ω–∏–µ');
            }
            
            log('–ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω', 'info');
        }

        // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
        function init() {
            log('‚úÖ –°–∏—Å—Ç–µ–º–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞', 'success');
            updateStatus('–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ');
        }

        // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
        window.addEventListener('beforeunload', () => {
            if (callState.status === 'in_call') hangUp();
            if (roomRef) roomRef.off();
        });

        window.onload = init;
    </script>
</body>
</html>
