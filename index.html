<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>üéß –ó–≤–æ–Ω–∏–ª–∫–∞ (–≤–µ—Ä—Å–∏—è –¥–ª—è –†–§)</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body>
    <div style="max-width: 600px; margin: 0 auto; padding: 20px;">
        <h1>üéß –ó–≤–æ–Ω–∏–ª–∫–∞ (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –¥–ª—è –†–§)</h1>
        <input id="roomId" value="8888" placeholder="ID –∫–æ–º–Ω–∞—Ç—ã">
        <button onclick="createRoom()">–°–æ–∑–¥–∞—Ç—å</button>
        <button onclick="joinRoom()">–í–æ–π—Ç–∏</button>
        <div id="status">–ì–æ—Ç–æ–≤</div>
        <button id="callBtn" onclick="startCall()" disabled>–ó–≤–æ–Ω–∏—Ç—å</button>
        <button id="hangupBtn" onclick="hangUp()" disabled>–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
        <div id="log" style="height: 200px; overflow: auto; background: #000; color: #0f0; padding: 10px; margin-top: 10px;"></div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDdlYdrHiGWd73F_pmwMKHrX92gK-G7kB8",
            databaseURL: "https://simple-audio-call-default-rtdb.europe-west1.firebasedatabase.app"
        };

        // –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–´–ï –°–ï–†–í–ï–†–ê –î–õ–Ø –†–û–°–°–ò–ò
        const iceServers = [
            // –û—Å–Ω–æ–≤–Ω—ã–µ STUN (—Ä–∞–±–æ—Ç–∞—é—Ç –≤ –†–§)
            { urls: 'stun:stun.l.google.com:19302' },
            { urls: 'stun:stun1.l.google.com:19302' },
            { urls: 'stun:stun2.l.google.com:19302' },
            { urls: 'stun:stun3.l.google.com:19302' },
            { urls: 'stun:stun4.l.google.com:19302' },
            
            // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ STUN
            { urls: 'stun:stun.voip.blackberry.com:3478' },
            { urls: 'stun:stun.voipbuster.com:3478' },
            
            // TURN —Å TCP (–ª—É—á—à–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏)
            { 
                urls: [
                    'turn:turn.anyfirewall.com:443?transport=tcp',
                    'turn:turn.anyfirewall.com:3478?transport=tcp'
                ],
                username: 'webrtc',
                credential: 'webrtc'
            },
            
            // Fallback TURN
            {
                urls: [
                    'turn:numb.viagenie.ca:3478',
                    'turn:numb.viagenie.ca:3478?transport=tcp'
                ],
                username: 'muazkh@gmail.com',
                credential: 'muazkh'
            }
        ];

        let localStream, remoteStream, peerConnection, database, roomRef;
        let currentRoomId = null;
        let isCaller = false;
        let callStatus = 'idle';

        function log(msg) {
            const div = document.getElementById('log');
            div.innerHTML += new Date().toLocaleTimeString() + ' ' + msg + '<br>';
            div.scrollTop = div.scrollHeight;
            console.log(msg);
        }

        function updateStatus(text) {
            document.getElementById('status').textContent = text;
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        database = firebase.database();

        function createRoom() {
            currentRoomId = document.getElementById('roomId').value.trim() || '8888';
            isCaller = true;
            roomRef = database.ref('rooms/' + currentRoomId);
            roomRef.remove().catch(() => {});
            roomRef.on('value', handleRoomUpdate);
            updateStatus('–ö–æ–º–Ω–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞: ' + currentRoomId);
            document.getElementById('callBtn').disabled = false;
            log('–ö–æ–º–Ω–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞: ' + currentRoomId);
        }

        function joinRoom() {
            currentRoomId = document.getElementById('roomId').value.trim();
            if (!currentRoomId) return alert('–í–≤–µ–¥–∏—Ç–µ ID –∫–æ–º–Ω–∞—Ç—ã');
            
            isCaller = false;
            roomRef = database.ref('rooms/' + currentRoomId);
            roomRef.on('value', handleRoomUpdate);
            updateStatus('–í –∫–æ–º–Ω–∞—Ç–µ: ' + currentRoomId);
            document.getElementById('callBtn').disabled = false;
            log('–í–æ—à–µ–ª –≤ –∫–æ–º–Ω–∞—Ç—É: ' + currentRoomId);
        }

        function handleRoomUpdate(snapshot) {
            const data = snapshot.val();
            if (!data) return;

            // –í—Ö–æ–¥—è—â–∏–π –≤—ã–∑–æ–≤
            if (data.offer && !isCaller && !peerConnection) {
                log('–í—Ö–æ–¥—è—â–∏–π –≤—ã–∑–æ–≤');
                if (confirm('–í—Ö–æ–¥—è—â–∏–π –≤—ã–∑–æ–≤. –ü—Ä–∏–Ω—è—Ç—å?')) {
                    acceptCall(data.offer);
                }
            }

            // –û—Ç–≤–µ—Ç –Ω–∞ –≤—ã–∑–æ–≤
            if (data.answer && isCaller && peerConnection) {
                handleAnswer(data.answer);
            }

            // ICE –∫–∞–Ω–¥–∏–¥–∞—Ç—ã
            if (data.iceCandidate && peerConnection && peerConnection.remoteDescription) {
                handleIceCandidate(data.iceCandidate);
            }
        }

        async function startCall() {
            try {
                callStatus = 'calling';
                updateStatus('–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ...');
                
                // –ü–æ–ª—É—á–∞–µ–º –º–∏–∫—Ä–æ—Ñ–æ–Ω
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: true 
                });
                
                log('–ú–∏–∫—Ä–æ—Ñ–æ–Ω –ø–æ–¥–∫–ª—é—á–µ–Ω');
                
                // –°–æ–∑–¥–∞–µ–º PeerConnection —Å –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –¥–ª—è –†–§
                const config = {
                    iceServers: iceServers,
                    iceTransportPolicy: 'all',
                    iceCandidatePoolSize: 10,
                    bundlePolicy: 'max-bundle',
                    rtcpMuxPolicy: 'require'
                };
                
                peerConnection = new RTCPeerConnection(config);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
                peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        roomRef.update({ iceCandidate: event.candidate });
                        log('ICE –∫–∞–Ω–¥–∏–¥–∞—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω: ' + event.candidate.type);
                    }
                };
                
                peerConnection.ontrack = (event) => {
                    log('–ü–æ–ª—É—á–µ–Ω —É–¥–∞–ª–µ–Ω–Ω—ã–π –ø–æ—Ç–æ–∫');
                    remoteStream = event.streams[0];
                    
                    // –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –∑–≤—É–∫
                    const audio = new Audio();
                    audio.srcObject = remoteStream;
                    audio.autoplay = true;
                    
                    audio.play().catch(e => {
                        log('–ù–∞–∂–º–∏—Ç–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —á—Ç–æ–±—ã –≤–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫');
                        document.body.onclick = () => audio.play();
                    });
                    
                    updateStatus('–†–∞–∑–≥–æ–≤–æ—Ä –∞–∫—Ç–∏–≤–µ–Ω');
                    document.getElementById('hangupBtn').disabled = false;
                };
                
                peerConnection.oniceconnectionstatechange = () => {
                    const state = peerConnection.iceConnectionState;
                    log('ICE —Å–æ—Å—Ç–æ—è–Ω–∏–µ: ' + state);
                    
                    if (state === 'connected') {
                        log('‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!');
                    }
                    if (state === 'failed') {
                        log('‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º—ã —Å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ–º');
                    }
                };
                
                // –°–æ–∑–¥–∞–µ–º offer
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                await roomRef.update({ offer: offer });
                
                log('–í—ã–∑–æ–≤ –Ω–∞—á–∞—Ç');
                
            } catch (error) {
                log('–û—à–∏–±–∫–∞: ' + error.message);
                hangUp();
            }
        }

        async function acceptCall(offer) {
            try {
                callStatus = 'in_call';
                updateStatus('–ü—Ä–∏–Ω–∏–º–∞—é –≤—ã–∑–æ–≤...');
                
                // –ü–æ–ª—É—á–∞–µ–º –º–∏–∫—Ä–æ—Ñ–æ–Ω
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: true 
                });
                
                log('–ú–∏–∫—Ä–æ—Ñ–æ–Ω –ø–æ–¥–∫–ª—é—á–µ–Ω');
                
                // –°–æ–∑–¥–∞–µ–º PeerConnection
                const config = {
                    iceServers: iceServers,
                    iceTransportPolicy: 'all'
                };
                
                peerConnection = new RTCPeerConnection(config);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
                peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        roomRef.update({ iceCandidate: event.candidate });
                        log('ICE –∫–∞–Ω–¥–∏–¥–∞—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω');
                    }
                };
                
                peerConnection.ontrack = (event) => {
                    log('–ü–æ–ª—É—á–µ–Ω —É–¥–∞–ª–µ–Ω–Ω—ã–π –ø–æ—Ç–æ–∫');
                    remoteStream = event.streams[0];
                    
                    const audio = new Audio();
                    audio.srcObject = remoteStream;
                    audio.autoplay = true;
                    
                    audio.play().catch(e => {
                        log('–ù–∞–∂–º–∏—Ç–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —á—Ç–æ–±—ã –≤–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫');
                        document.body.onclick = () => audio.play();
                    });
                    
                    updateStatus('–†–∞–∑–≥–æ–≤–æ—Ä –∞–∫—Ç–∏–≤–µ–Ω');
                    document.getElementById('hangupBtn').disabled = false;
                };
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —É–¥–∞–ª–µ–Ω–Ω—ã–π offer
                await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
                
                // –°–æ–∑–¥–∞–µ–º answer
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                await roomRef.update({ answer: answer });
                
                log('–í—ã–∑–æ–≤ –ø—Ä–∏–Ω—è—Ç');
                
            } catch (error) {
                log('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–Ω—è—Ç–∏–∏ –≤—ã–∑–æ–≤–∞: ' + error.message);
                hangUp();
            }
        }

        async function handleAnswer(answer) {
            try {
                await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
                log('Answer —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
            } catch (error) {
                log('–û—à–∏–±–∫–∞ answer: ' + error.message);
            }
        }

        async function handleIceCandidate(candidate) {
            try {
                await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
                log('ICE –∫–∞–Ω–¥–∏–¥–∞—Ç –¥–æ–±–∞–≤–ª–µ–Ω');
            } catch (error) {
                // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ —Å ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–∞–º–∏
            }
        }

        function hangUp() {
            log('–ó–∞–≤–µ—Ä—à–∞—é –∑–≤–æ–Ω–æ–∫...');
            
            if (roomRef) {
                roomRef.update({ 
                    hangup: true,
                    offer: null,
                    answer: null,
                    iceCandidate: null 
                }).catch(() => {});
                roomRef.off();
            }
            
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            
            callStatus = 'idle';
            updateStatus('–ì–æ—Ç–æ–≤');
            document.getElementById('callBtn').disabled = false;
            document.getElementById('hangupBtn').disabled = true;
        }

        // –¢–µ—Å—Ç ICE —Å–µ—Ä–≤–µ—Ä–æ–≤
        async function testIceServers() {
            log('=== –¢–µ—Å—Ç–∏—Ä—É—é ICE —Å–µ—Ä–≤–µ—Ä—ã –¥–ª—è –†–§ ===');
            
            for (let i = 0; i < iceServers.length; i++) {
                const server = iceServers[i];
                log(`–¢–µ—Å—Ç ${i+1}: ${JSON.stringify(server.urls || server)}`);
                
                try {
                    const pc = new RTCPeerConnection({ iceServers: [server] });
                    
                    const timeout = setTimeout(() => {
                        pc.close();
                        log(`‚ùå ${i+1}: –¢–∞–π–º–∞—É—Ç`);
                    }, 5000);
                    
                    pc.onicecandidate = (e) => {
                        if (e.candidate) {
                            clearTimeout(timeout);
                            pc.close();
                            log(`‚úÖ ${i+1}: –†–∞–±–æ—Ç–∞–µ—Ç (${e.candidate.type})`);
                        }
                    };
                    
                    pc.createDataChannel('test');
                    const offer = await pc.createOffer();
                    await pc.setLocalDescription(offer);
                    
                } catch (error) {
                    log(`‚ùå ${i+1}: –û—à–∏–±–∫–∞ - ${error.message}`);
                }
                
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
            
            log('=== –¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω ===');
        }

        // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', () => {
            log('–ó–≤–æ–Ω–∏–ª–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
            // testIceServers(); // –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –¥–ª—è —Ç–µ—Å—Ç–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤
        });
    </script>
</body>
</html>
