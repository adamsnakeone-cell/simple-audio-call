<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéß –ó–í–û–ù–ò–õ–ö–ê (–ê–õ–¨–¢–ï–†–ù–ê–¢–ò–í–ù–´–ô –í–ê–†–ò–ê–ù–¢)</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
        body { background: #0a192f; color: #ccd6f6; min-height: 100vh; padding: 20px; }
        .container { background: #112240; border-radius: 15px; padding: 25px; max-width: 500px; margin: 0 auto; border: 1px solid #233554; }
        h1 { text-align: center; color: #64ffda; margin-bottom: 20px; font-size: 28px; }
        .input-group { margin: 15px 0; }
        input { width: 100%; padding: 15px; background: #233554; border: 2px solid #112240; border-radius: 10px; color: #ccd6f6; font-size: 16px; }
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 20px 0; }
        button { padding: 15px; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        #createBtn { background: #1d4ed8; }
        #joinBtn { background: #7c3aed; }
        #callBtn { background: #059669; grid-column: span 2; }
        #hangupBtn { background: #dc2626; grid-column: span 2; }
        #dataChannelBtn { background: #ea580c; grid-column: span 2; }
        button:disabled { background: #475569 !important; cursor: not-allowed; opacity: 0.5; }
        .status-box { background: #1e293b; padding: 15px; border-radius: 10px; margin: 20px 0; text-align: center; }
        .status-box.connected { background: #065f46; }
        .status-box.warning { background: #92400e; }
        .status-box.error { background: #7f1d1d; }
        .log-box { background: #000; color: #64ffda; padding: 15px; border-radius: 10px; margin-top: 20px; font-family: monospace; font-size: 12px; height: 200px; overflow-y: auto; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 1000; }
        .modal-content { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #112240; padding: 30px; border-radius: 15px; border: 2px solid #64ffda; width: 90%; max-width: 400px; text-align: center; }
        .modal-buttons { display: flex; gap: 15px; margin-top: 25px; }
        .modal-buttons button { flex: 1; }
        .accept-btn { background: #059669; }
        .reject-btn { background: #dc2626; }
        .connection-type { font-size: 14px; color: #fbbf24; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéß –ó–í–û–ù–ò–õ–ö–ê (DataChannel Fallback)</h1>
        
        <div class="input-group">
            <input type="text" id="roomId" placeholder="ID –∫–æ–º–Ω–∞—Ç—ã" value="3333">
        </div>
        
        <div class="btn-grid">
            <button id="createBtn" onclick="createRoom()">–°–û–ó–î–ê–¢–¨</button>
            <button id="joinBtn" onclick="joinRoom()">–í–û–ô–¢–ò</button>
        </div>
        
        <div class="status-box" id="statusBox">
            <div id="statusText">–ì–û–¢–û–í</div>
            <div id="statusInfo" class="connection-type"></div>
        </div>
        
        <div class="btn-grid">
            <button id="callBtn" onclick="startCall()" disabled>üìû –ü–û–ó–í–û–ù–ò–¢–¨</button>
            <button id="hangupBtn" onclick="hangUp()" disabled>‚ùå –ó–ê–í–ï–†–®–ò–¢–¨</button>
            <button id="dataChannelBtn" onclick="startDataChannelTest()" disabled>üîä –ü–†–û–í–ï–†–ò–¢–¨ –°–û–ï–î–ò–ù–ï–ù–ò–ï</button>
        </div>
        
        <div class="log-box" id="logBox"></div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª–∫–∏ -->
    <div class="modal" id="incomingModal">
        <div class="modal-content">
            <div style="font-size: 50px; color: #64ffda;">üìû</div>
            <h2>–í–•–û–î–Ø–©–ò–ô –í–´–ó–û–í</h2>
            <p>–ö–æ–º–Ω–∞—Ç–∞: <strong id="callRoomId"></strong></p>
            <div class="modal-buttons">
                <button class="accept-btn" onclick="acceptCall()">‚úÖ –ü–†–ò–ù–Ø–¢–¨</button>
                <button class="reject-btn" onclick="rejectCall()">‚ùå –û–¢–ö–õ–û–ù–ò–¢–¨</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="waitingModal">
        <div class="modal-content">
            <div style="font-size: 50px; color: #fbbf24;">‚è≥</div>
            <h2>–û–ñ–ò–î–ê–ù–ò–ï...</h2>
            <p>–ö–æ–º–Ω–∞—Ç–∞: <strong id="waitRoomId"></strong></p>
            <div id="connectionProgress"></div>
            <button class="reject-btn" onclick="cancelCall()">–û–¢–ú–ï–ù–ò–¢–¨</button>
        </div>
    </div>
    
    <div class="modal" id="activeModal">
        <div class="modal-content">
            <div style="font-size: 50px; color: #059669;">üéß</div>
            <h2>–†–ê–ó–ì–û–í–û–† –ê–ö–¢–ò–í–ï–ù</h2>
            <p>–ö–æ–º–Ω–∞—Ç–∞: <strong id="activeRoomId"></strong></p>
            <div id="callStats" style="margin: 20px 0; color: #fbbf24;"></div>
            <button class="reject-btn" onclick="hangUp()">–ó–ê–í–ï–†–®–ò–¢–¨</button>
        </div>
    </div>

    <script>
        // ========== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ==========
        const firebaseConfig = {
            apiKey: "AIzaSyDdlYdrHiGWd73F_pmwMKHrX92gK-G7kB8",
            databaseURL: "https://simple-audio-call-default-rtdb.europe-west1.firebasedatabase.app"
        };

        // ========== –ü–ï–†–ï–ú–ï–ù–ù–´–ï ==========
        let localStream = null;
        let peerConnection = null;
        let dataChannel = null;
        let database = null;
        let roomRef = null;
        let currentRoomId = null;
        let isCaller = false;
        let callStatus = 'idle';
        let connectionType = 'none';
        let audioContext = null;
        let audioWorkletNode = null;

        // ========== –õ–û–ì–ò–†–û–í–ê–ù–ò–ï ==========
        function log(message, type = 'info') {
            const logBox = document.getElementById('logBox');
            const time = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.innerHTML = `<span style="color: #94a3b8">[${time}]</span> ${message}`;
            logBox.appendChild(entry);
            logBox.scrollTop = logBox.scrollHeight;
            console.log(`[${type}] ${message}`);
        }

        function updateStatus(text, statusClass = '', info = '') {
            document.getElementById('statusText').textContent = text;
            document.getElementById('statusBox').className = 'status-box ' + statusClass;
            if (info) document.getElementById('statusInfo').textContent = info;
            
            document.getElementById('callBtn').disabled = !(currentRoomId && callStatus === 'idle');
            document.getElementById('hangupBtn').disabled = callStatus !== 'in_call';
            document.getElementById('dataChannelBtn').disabled = callStatus !== 'in_call';
        }

        // ========== –ö–û–ú–ù–ê–¢–´ ==========
        function createRoom() {
            currentRoomId = document.getElementById('roomId').value.trim() || '3333';
            document.getElementById('roomId').value = currentRoomId;
            connectToRoom(true);
        }

        function joinRoom() {
            currentRoomId = document.getElementById('roomId').value.trim();
            if (!currentRoomId) {
                alert('–í–≤–µ–¥–∏—Ç–µ ID –∫–æ–º–Ω–∞—Ç—ã');
                return;
            }
            connectToRoom(false);
        }

        function connectToRoom(isCreator) {
            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                database = firebase.database();
                
                isCaller = isCreator;
                
                if (roomRef) roomRef.off();
                roomRef = database.ref(`rooms/${currentRoomId}`);
                
                if (isCreator) {
                    roomRef.remove().catch(() => {});
                }
                
                roomRef.on('value', handleRoomUpdate);
                
                updateStatus(`–ö–û–ú–ù–ê–¢–ê: ${currentRoomId}`, 'connected');
                log(`–ü–æ–¥–∫–ª—é—á–µ–Ω –∫ –∫–æ–º–Ω–∞—Ç–µ ${currentRoomId}`);
                
            } catch (error) {
                log(`–û—à–∏–±–∫–∞: ${error.message}`);
            }
        }

        // ========== –û–ë–†–ê–ë–û–¢–ö–ê –°–û–ë–´–¢–ò–ô ==========
        function handleRoomUpdate(snapshot) {
            const data = snapshot.val();
            if (!data) return;
            
            // –í—Ö–æ–¥—è—â–∏–π –≤—ã–∑–æ–≤
            if (data.callRequest && !isCaller && callStatus === 'idle') {
                showIncomingCall();
            }
            
            // –û—Ç–≤–µ—Ç –Ω–∞ –≤—ã–∑–æ–≤
            if (data.callResponse && callStatus === 'calling') {
                if (data.callResponse.accepted) {
                    callStatus = 'in_call';
                    document.getElementById('waitingModal').style.display = 'none';
                    setupDataChannelConnection(true);
                    log('‚úÖ –í—ã–∑–æ–≤ –ø—Ä–∏–Ω—è—Ç');
                } else {
                    callStatus = 'idle';
                    document.getElementById('waitingModal').style.display = 'none';
                    alert('–í—ã–∑–æ–≤ –æ—Ç–∫–ª–æ–Ω–µ–Ω');
                    updateStatus(`–ö–û–ú–ù–ê–¢–ê: ${currentRoomId}`, 'connected');
                    log('–í—ã–∑–æ–≤ –æ—Ç–∫–ª–æ–Ω–µ–Ω');
                }
            }
            
            // WebRTC —Å–∏–≥–Ω–∞–ª—ã –¥–ª—è DataChannel
            if (callStatus === 'in_call') {
                if (data.offer && !isCaller && peerConnection) {
                    handleOffer(data.offer);
                }
                
                if (data.answer && isCaller && peerConnection) {
                    handleAnswer(data.answer);
                }
                
                if (data.iceCandidate && peerConnection) {
                    handleIceCandidate(data.iceCandidate);
                }
            }
            
            if (data.hangup) {
                handleRemoteHangup();
            }
        }

        function showIncomingCall() {
            document.getElementById('callRoomId').textContent = currentRoomId;
            document.getElementById('incomingModal').style.display = 'flex';
            callStatus = 'ringing';
            updateStatus('–í–•–û–î–Ø–©–ò–ô –í–´–ó–û–í', 'warning');
            log('üìû –í—Ö–æ–¥—è—â–∏–π –≤—ã–∑–æ–≤');
        }

        // ========== –ó–í–û–ù–ö–ò ==========
        function startCall() {
            callStatus = 'calling';
            document.getElementById('waitRoomId').textContent = currentRoomId;
            document.getElementById('waitingModal').style.display = 'flex';
            
            roomRef.update({ 
                callRequest: { time: Date.now() }
            });
            
            log('–í—ã–∑—ã–≤–∞—é...');
        }

        function acceptCall() {
            document.getElementById('incomingModal').style.display = 'none';
            callStatus = 'in_call';
            
            roomRef.update({
                callResponse: { accepted: true, time: Date.now() }
            });
            
            setupDataChannelConnection(false);
            log('‚úÖ –í—ã–∑–æ–≤ –ø—Ä–∏–Ω—è—Ç');
        }

        function rejectCall() {
            document.getElementById('incomingModal').style.display = 'none';
            callStatus = 'idle';
            
            roomRef.update({
                callResponse: { accepted: false, time: Date.now() }
            });
            
            updateStatus(`–ö–û–ú–ù–ê–¢–ê: ${currentRoomId}`, 'connected');
            log('–í—ã–∑–æ–≤ –æ—Ç–∫–ª–æ–Ω–µ–Ω');
        }

        function cancelCall() {
            document.getElementById('waitingModal').style.display = 'none';
            callStatus = 'idle';
            roomRef.update({ callRequest: null });
            updateStatus(`–ö–û–ú–ù–ê–¢–ê: ${currentRoomId}`, 'connected');
            log('–í—ã–∑–æ–≤ –æ—Ç–º–µ–Ω–µ–Ω');
        }

        // ========== DataChannel Connection ==========
        async function setupDataChannelConnection(isInitiator) {
            try {
                updateStatus('–£–°–¢–ê–ù–û–í–ö–ê –°–û–ï–î–ò–ù–ï–ù–ò–Ø...', 'warning');
                
                // –ü–æ–ª—É—á–∞–µ–º –º–∏–∫—Ä–æ—Ñ–æ–Ω –¥–ª—è –∑–∞—Ö–≤–∞—Ç–∞ –∑–≤—É–∫–∞
                localStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        channelCount: 1,
                        sampleRate: 8000, // –ù–∏–∑–∫–∞—è —á–∞—Å—Ç–æ—Ç–∞ –¥–ª—è DataChannel
                        echoCancellation: false
                    }
                });
                
                log('üé§ –ú–∏–∫—Ä–æ—Ñ–æ–Ω –≥–æ—Ç–æ–≤ –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏');
                
                // –°–æ–∑–¥–∞–µ–º PeerConnection –¥–ª—è DataChannel
                const config = {
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' }
                    ]
                };
                
                peerConnection = new RTCPeerConnection(config);
                
                // –°–æ–∑–¥–∞–µ–º DataChannel
                if (isInitiator) {
                    dataChannel = peerConnection.createDataChannel('audioData', {
                        ordered: false,
                        maxRetransmits: 0
                    });
                    setupDataChannelHandlers();
                }
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è DataChannel
                peerConnection.ondatachannel = (event) => {
                    dataChannel = event.channel;
                    setupDataChannelHandlers();
                };
                
                // ICE –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
                peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        roomRef.update({ iceCandidate: event.candidate });
                    }
                };
                
                peerConnection.oniceconnectionstatechange = () => {
                    const state = peerConnection.iceConnectionState;
                    log(`ICE: ${state}`);
                    
                    if (state === 'connected' || state === 'completed') {
                        connectionType = 'DataChannel';
                        log('‚úÖ DataChannel —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!');
                        document.getElementById('activeRoomId').textContent = currentRoomId;
                        document.getElementById('activeModal').style.display = 'flex';
                        updateStatus('–†–ê–ó–ì–û–í–û–† –ê–ö–¢–ò–í–ï–ù', 'connected', '–ß–µ—Ä–µ–∑ DataChannel');
                        
                        // –ù–∞—á–∏–Ω–∞–µ–º –ø–µ—Ä–µ–¥–∞—á—É –∞—É–¥–∏–æ —á–µ—Ä–µ–∑ DataChannel
                        startAudioTransmission();
                    }
                };
                
                // –°–æ–∑–¥–∞–µ–º offer –µ—Å–ª–∏ –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä
                if (isInitiator) {
                    const offer = await peerConnection.createOffer();
                    await peerConnection.setLocalDescription(offer);
                    await roomRef.update({ offer: offer });
                    log('Offer –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω');
                }
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`);
                hangUp();
            }
        }

        function setupDataChannelHandlers() {
            dataChannel.onopen = () => {
                log('üì° DataChannel –æ—Ç–∫—Ä—ã—Ç');
                document.getElementById('callStats').textContent = 'DataChannel –≥–æ—Ç–æ–≤ –∫ –ø–µ—Ä–µ–¥–∞—á–µ';
            };
            
            dataChannel.onmessage = (event) => {
                // –ü–æ–ª—É—á–∞–µ–º –∞—É–¥–∏–æ –¥–∞–Ω–Ω—ã–µ
                handleIncomingAudioData(event.data);
            };
            
            dataChannel.onerror = (error) => {
                log(`DataChannel –æ—à–∏–±–∫–∞: ${error}`);
            };
        }

        async function startAudioTransmission() {
            try {
                if (!localStream || !dataChannel || dataChannel.readyState !== 'open') {
                    log('‚ö†Ô∏è DataChannel –Ω–µ –≥–æ—Ç–æ–≤');
                    return;
                }
                
                // –°–æ–∑–¥–∞–µ–º AudioContext –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–≤—É–∫–∞
                audioContext = new (window.AudioContext || window.webkitAudioContext)({
                    sampleRate: 8000
                });
                
                const source = audioContext.createMediaStreamSource(localStream);
                
                // –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä –¥–ª—è –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è –∞—É–¥–∏–æ
                const processor = audioContext.createScriptProcessor(4096, 1, 1);
                
                processor.onaudioprocess = (event) => {
                    if (dataChannel.readyState === 'open') {
                        const inputData = event.inputBuffer.getChannelData(0);
                        
                        // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º Float32 –≤ Int16 (—Å–∂–∞—Ç–∏–µ)
                        const int16Data = new Int16Array(inputData.length);
                        for (let i = 0; i < inputData.length; i++) {
                            int16Data[i] = Math.max(-32768, Math.min(32767, inputData[i] * 32768));
                        }
                        
                        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ DataChannel
                        try {
                            dataChannel.send(int16Data.buffer);
                        } catch (error) {
                            // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏
                        }
                    }
                };
                
                source.connect(processor);
                processor.connect(audioContext.destination);
                
                log('üé§ –ù–∞—á–∏–Ω–∞—é –ø–µ—Ä–µ–¥–∞—á—É –∞—É–¥–∏–æ —á–µ—Ä–µ–∑ DataChannel');
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –ø–µ—Ä–µ–¥–∞—á–∏ –∞—É–¥–∏–æ: ${error.message}`);
            }
        }

        function handleIncomingAudioData(audioBuffer) {
            try {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)({
                        sampleRate: 8000
                    });
                }
                
                // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º Int16 –æ–±—Ä–∞—Ç–Ω–æ –≤ Float32
                const int16Data = new Int16Array(audioBuffer);
                const float32Data = new Float32Array(int16Data.length);
                
                for (let i = 0; i < int16Data.length; i++) {
                    float32Data[i] = int16Data[i] / 32768;
                }
                
                // –°–æ–∑–¥–∞–µ–º –∞—É–¥–∏–æ –±—É—Ñ–µ—Ä
                const audioBufferObj = audioContext.createBuffer(1, float32Data.length, 8000);
                audioBufferObj.getChannelData(0).set(float32Data);
                
                // –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º
                const source = audioContext.createBufferSource();
                source.buffer = audioBufferObj;
                source.connect(audioContext.destination);
                source.start();
                
            } catch (error) {
                // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
            }
        }

        // ========== WebRTC Handlers ==========
        async function handleOffer(offer) {
            try {
                await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                await roomRef.update({ answer: answer });
                log('–û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω');
            } catch (error) {
                log(`–û—à–∏–±–∫–∞ offer: ${error.message}`);
            }
        }

        async function handleAnswer(answer) {
            try {
                await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
                log('–û—Ç–≤–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
            } catch (error) {
                log(`–û—à–∏–±–∫–∞ answer: ${error.message}`);
            }
        }

        async function handleIceCandidate(candidate) {
            try {
                if (peerConnection.remoteDescription) {
                    await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
                }
            } catch (error) {
                // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º
            }
        }

        // ========== –¢–ï–°–¢ –°–û–ï–î–ò–ù–ï–ù–ò–Ø ==========
        function startDataChannelTest() {
            if (!dataChannel || dataChannel.readyState !== 'open') {
                alert('DataChannel –Ω–µ –≥–æ—Ç–æ–≤');
                return;
            }
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∏–≥–Ω–∞–ª
            dataChannel.send('TEST_SIGNAL');
            log('üì° –û—Ç–ø—Ä–∞–≤–ª–µ–Ω —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∏–≥–Ω–∞–ª');
            
            setTimeout(() => {
                document.getElementById('callStats').textContent = '–¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω';
            }, 1000);
        }

        function handleRemoteHangup() {
            alert('–°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –∑–∞–≤–µ—Ä—à–∏–ª –∑–≤–æ–Ω–æ–∫');
            hangUp();
        }

        // ========== –ó–ê–í–ï–†–®–ï–ù–ò–ï ==========
        function hangUp() {
            log('–ó–∞–≤–µ—Ä—à–∞—é –∑–≤–æ–Ω–æ–∫...');
            
            if (roomRef) {
                roomRef.update({ hangup: true }).catch(() => {});
            }
            
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            
            if (dataChannel) {
                dataChannel.close();
                dataChannel = null;
            }
            
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            
            if (audioContext) {
                audioContext.close();
                audioContext = null;
            }
            
            document.getElementById('incomingModal').style.display = 'none';
            document.getElementById('waitingModal').style.display = 'none';
            document.getElementById('activeModal').style.display = 'none';
            
            callStatus = 'idle';
            connectionType = 'none';
            
            if (currentRoomId) {
                updateStatus(`–ö–û–ú–ù–ê–¢–ê: ${currentRoomId}`, 'connected');
            } else {
                updateStatus('–ì–û–¢–û–í', '');
            }
            
            log('–ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω');
        }

        // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
        function init() {
            log('‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ');
            updateStatus('–ì–û–¢–û–í');
        }

        window.addEventListener('beforeunload', () => {
            if (callStatus === 'in_call') hangUp();
            if (roomRef) roomRef.off();
        });

        window.onload = init;
    </script>
</head>
</html>
