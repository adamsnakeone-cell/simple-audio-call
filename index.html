<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ—Å—Ç–æ–π –ê—É–¥–∏–æ –ó–≤–æ–Ω–æ–∫</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }
        
        body {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .container {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .input-group {
            margin: 15px 0;
        }
        
        input {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        input:focus {
            border-color: #4285f4;
            outline: none;
        }
        
        .buttons {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        button {
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            flex: 1;
            min-width: 150px;
        }
        
        button:hover {
            opacity: 0.9;
        }
        
        #createBtn {
            background: #4285f4;
            color: white;
        }
        
        #joinBtn {
            background: #34a853;
            color: white;
        }
        
        #startCallBtn {
            background: #ea4335;
            color: white;
        }
        
        #hangupBtn {
            background: #555;
            color: white;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .status {
            background: #f8f9fa;
            border-left: 4px solid #4285f4;
            padding: 15px;
            margin: 20px 0;
            border-radius: 0 5px 5px 0;
        }
        
        .log {
            background: #333;
            color: #0f0;
            padding: 15px;
            margin-top: 20px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        .log-title {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .call-status {
            text-align: center;
            padding: 15px;
            margin: 15px 0;
            font-weight: bold;
            background: #e8f0fe;
            border-radius: 5px;
        }
        
        .connected { color: #34a853; }
        .connecting { color: #fbbc05; }
        .disconnected { color: #ea4335; }
        
        @media (max-width: 600px) {
            body {
                margin: 10px;
                padding: 10px;
            }
            
            button {
                min-width: 100%;
            }
            
            .buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéß –ü—Ä–æ—Å—Ç–æ–π –ê—É–¥–∏–æ –ó–≤–æ–Ω–æ–∫</h1>
        
        <div class="input-group">
            <input type="text" id="roomId" placeholder="–í–≤–µ–¥–∏—Ç–µ ID –∫–æ–º–Ω–∞—Ç—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä: 12345)">
            <div class="buttons">
                <button id="createBtn" onclick="createRoom()">–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
                <button id="joinBtn" onclick="joinRoom()">–í–æ–π—Ç–∏ –≤ –∫–æ–º–Ω–∞—Ç—É</button>
            </div>
        </div>
        
        <div class="call-status">
            –°—Ç–∞—Ç—É—Å: <span id="statusText">–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ</span>
        </div>
        
        <div class="buttons">
            <button id="startCallBtn" onclick="startAudioCall()" disabled>üé§ –ù–∞—á–∞—Ç—å –∑–≤–æ–Ω–æ–∫</button>
            <button id="hangupBtn" onclick="hangUp()" disabled>üìû –ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–≤–æ–Ω–æ–∫</button>
        </div>
        
        <div class="status">
            <h3>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:</h3>
            <ol>
                <li>–°–æ–∑–¥–∞–π—Ç–µ –∫–æ–º–Ω–∞—Ç—É –Ω–∞ –ø–µ—Ä–≤–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ</li>
                <li>–ó–∞–ø–æ–º–Ω–∏—Ç–µ ID –∫–æ–º–Ω–∞—Ç—ã</li>
                <li>–ù–∞ –≤—Ç–æ—Ä–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ –≤–≤–µ–¥–∏—Ç–µ —Ç–æ—Ç –∂–µ ID –∏ –Ω–∞–∂–º–∏—Ç–µ "–í–æ–π—Ç–∏ –≤ –∫–æ–º–Ω–∞—Ç—É"</li>
                <li>–ù–∞ –æ–¥–Ω–æ–º –∏–∑ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –Ω–∞–∂–º–∏—Ç–µ "–ù–∞—á–∞—Ç—å –∑–≤–æ–Ω–æ–∫"</li>
            </ol>
        </div>
        
        <div class="log-container">
            <div class="log-title">
                <h3>–õ–æ–≥ —Å–æ–±—ã—Ç–∏–π:</h3>
                <button onclick="clearLog()" style="padding: 5px 10px; font-size: 12px;">–û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥</button>
            </div>
            <div class="log" id="log"></div>
        </div>
    </div>

    <script>
        // ========== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø FIREBASE ==========
        const firebaseConfig = {
            apiKey: "AIzaSyDdlYdrHiGWd73F_pmwMKHrX92gK-G7kB8",
            authDomain: "simple-audio-call.firebaseapp.com",
            databaseURL: "https://simple-audio-call-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "simple-audio-call",
            storageBucket: "simple-audio-call.firebasestorage.app",
            messagingSenderId: "599555413464",
            appId: "1:599555413464:web:a50217a5ab1fef66c60ead"
        };

        // ========== –ü–ï–†–ï–ú–ï–ù–ù–´–ï ==========
        let localStream = null;
        let peerConnection = null;
        let database = null;
        let roomRef = null;
        let isCaller = false;
        let roomId = null;
        let localUid = Math.floor(Math.random() * 10000); // –ü—Ä–æ—Å—Ç–æ–π ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

        // ========== –õ–û–ì–ò–†–û–í–ê–ù–ò–ï ==========
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const typeSymbol = {
                'info': '‚ÑπÔ∏è',
                'success': '‚úÖ',
                'error': '‚ùå',
                'warning': '‚ö†Ô∏è',
                'webrtc': 'üéß'
            }[type] || 'üìù';
            
            const logEntry = `${timestamp} ${typeSymbol} ${message}\n`;
            logDiv.innerHTML += logEntry;
            logDiv.scrollTop = logDiv.scrollHeight;
            
            // –¢–∞–∫–∂–µ –≤ –∫–æ–Ω—Å–æ–ª—å –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
            console.log(`${type.toUpperCase()}: ${message}`);
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
            log('–õ–æ–≥ –æ—á–∏—â–µ–Ω');
        }

        function updateStatus(status, isError = false) {
            const statusText = document.getElementById('statusText');
            statusText.textContent = status;
            statusText.className = isError ? 'error' : 'connected';
            log(`–°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω–µ–Ω: ${status}`, isError ? 'error' : 'info');
        }

        // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø FIREBASE ==========
        function initFirebase() {
            try {
                firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                log('Firebase –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω', 'success');
                updateStatus('–ì–æ—Ç–æ–≤ –∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é');
                return true;
            } catch (error) {
                log(`–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firebase: ${error.message}`, 'error');
                updateStatus('–û—à–∏–±–∫–∞ Firebase', true);
                return false;
            }
        }

        // ========== –°–û–ó–î–ê–ù–ò–ï/–ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –ö –ö–û–ú–ù–ê–¢–ï ==========
        function createRoom() {
            roomId = document.getElementById('roomId').value.trim();
            if (!roomId) {
                roomId = Math.floor(Math.random() * 100000).toString();
                document.getElementById('roomId').value = roomId;
            }
            
            log(`–°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã: ${roomId}`, 'info');
            connectToRoom(true);
        }

        function joinRoom() {
            roomId = document.getElementById('roomId').value.trim();
            if (!roomId) {
                alert('–í–≤–µ–¥–∏—Ç–µ ID –∫–æ–º–Ω–∞—Ç—ã');
                return;
            }
            
            log(`–í—Ö–æ–¥ –≤ –∫–æ–º–Ω–∞—Ç—É: ${roomId}`, 'info');
            connectToRoom(false);
        }

        function connectToRoom(isCreator) {
            if (!database && !initFirebase()) {
                return;
            }

            isCaller = isCreator;
            roomRef = database.ref(`rooms/${roomId}`);
            
            // –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä–æ–π –∫–æ–º–Ω–∞—Ç—ã –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏
            if (isCaller) {
                roomRef.remove();
            }
            
            // –°–ª—É—à–∞–µ–º —Å–∏–≥–Ω–∞–ª—ã –æ—Ç –¥—Ä—É–≥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            roomRef.on('value', snapshot => {
                if (!snapshot.exists()) return;
                
                const data = snapshot.val();
                log(`–ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –∏–∑ –∫–æ–º–Ω–∞—Ç—ã: ${JSON.stringify(data)}`, 'webrtc');
                
                // –ï—Å–ª–∏ –º—ã –≤—ã–∑—ã–≤–∞—é—â–∏–π –∏ –ø–æ–ª—É—á–∏–ª–∏ –æ—Ç–≤–µ—Ç
                if (isCaller && data.answer) {
                    handleAnswer(data.answer);
                }
                // –ï—Å–ª–∏ –º—ã –æ—Ç–≤–µ—á–∞—é—â–∏–π –∏ –ø–æ–ª—É—á–∏–ª–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ
                else if (!isCaller && data.offer) {
                    handleOffer(data.offer);
                }
                // –ï—Å–ª–∏ –ø–æ–ª—É—á–∏–ª–∏ ICE –∫–∞–Ω–¥–∏–¥–∞—Ç
                else if (data.iceCandidate) {
                    handleNewICECandidate(data.iceCandidate);
                }
                // –ï—Å–ª–∏ –ø–æ–ª—É—á–∏–ª–∏ –∫–æ–º–∞–Ω–¥—É –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
                else if (data.hangup) {
                    log('–î—Ä—É–≥–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–≤–µ—Ä—à–∏–ª –∑–≤–æ–Ω–æ–∫', 'warning');
                    hangUp();
                }
            });
            
            updateStatus(`–í –∫–æ–º–Ω–∞—Ç–µ: ${roomId}`);
            document.getElementById('startCallBtn').disabled = false;
            log(`–ü–æ–¥–∫–ª—é—á–µ–Ω –∫ –∫–æ–º–Ω–∞—Ç–µ ${roomId} –∫–∞–∫ ${isCaller ? '—Å–æ–∑–¥–∞—Ç–µ–ª—å' : '—É—á–∞—Å—Ç–Ω–∏–∫'}`, 'success');
        }

        // ========== WEBRTC –§–£–ù–ö–¶–ò–ò ==========
        async function startAudioCall() {
            try {
                updateStatus('–ü–æ–ª—É—á–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É...');
                
                // –ü–æ–ª—É—á–∞–µ–º –∞—É–¥–∏–æ–ø–æ—Ç–æ–∫
                localStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    },
                    video: false
                });
                
                log('–ú–∏–∫—Ä–æ—Ñ–æ–Ω –¥–æ—Å—Ç—É–ø–µ–Ω', 'success');
                
                // –°–æ–∑–¥–∞–µ–º RTCPeerConnection
                const configuration = {
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' }
                    ]
                };
                
                peerConnection = new RTCPeerConnection(configuration);
                log('PeerConnection —Å–æ–∑–¥–∞–Ω', 'webrtc');
                
                // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
                peerConnection.onicecandidate = event => {
                    if (event.candidate) {
                        log(`–û—Ç–ø—Ä–∞–≤–∫–∞ ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–∞`, 'webrtc');
                        roomRef.update({
                            iceCandidate: {
                                candidate: event.candidate.candidate,
                                sdpMLineIndex: event.candidate.sdpMLineIndex,
                                sdpMid: event.candidate.sdpMid
                            },
                            from: localUid
                        });
                    }
                };
                
                // –ö–æ–≥–¥–∞ –ø–æ–ª—É—á–∞–µ–º —É–¥–∞–ª–µ–Ω–Ω—ã–π –ø–æ—Ç–æ–∫
                peerConnection.ontrack = event => {
                    log('–ü–æ–ª—É—á–µ–Ω —É–¥–∞–ª–µ–Ω–Ω—ã–π –∞—É–¥–∏–æ–ø–æ—Ç–æ–∫', 'success');
                    const remoteAudio = document.getElementById('remoteAudio');
                    if (!remoteAudio) {
                        const audio = document.createElement('audio');
                        audio.id = 'remoteAudio';
                        audio.autoplay = true;
                        document.body.appendChild(audio);
                    }
                    document.getElementById('remoteAudio').srcObject = event.streams[0];
                };
                
                peerConnection.onconnectionstatechange = () => {
                    log(`–°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ${peerConnection.connectionState}`, 'webrtc');
                    updateStatus(`–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ: ${peerConnection.connectionState}`);
                    
                    if (peerConnection.connectionState === 'connected') {
                        log('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ! –ú–æ–∂–Ω–æ –≥–æ–≤–æ—Ä–∏—Ç—å.', 'success');
                        document.getElementById('hangupBtn').disabled = false;
                        document.getElementById('startCallBtn').disabled = true;
                    }
                };
                
                peerConnection.oniceconnectionstatechange = () => {
                    log(`ICE —Å–æ—Å—Ç–æ—è–Ω–∏–µ: ${peerConnection.iceConnectionState}`, 'webrtc');
                };
                
                // –°–æ–∑–¥–∞–µ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ (offer) –µ—Å–ª–∏ –º—ã –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä
                if (isCaller) {
                    await createOffer();
                }
                
            } catch (error) {
                log(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –∑–≤–æ–Ω–∫–∞: ${error.message}`, 'error');
                updateStatus('–û—à–∏–±–∫–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞', true);
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è.');
            }
        }

        async function createOffer() {
            try {
                updateStatus('–°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è...');
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                
                log('–û—Ç–ø—Ä–∞–≤–∫–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –≤ –∫–æ–º–Ω–∞—Ç—É', 'webrtc');
                await roomRef.update({
                    offer: offer,
                    from: localUid
                });
                
                updateStatus('–û–∂–∏–¥–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞...');
            } catch (error) {
                log(`–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è: ${error.message}`, 'error');
            }
        }

        async function handleOffer(offer) {
            try {
                log('–ü–æ–ª—É—á–µ–Ω–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ, —Å–æ–∑–¥–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞...', 'webrtc');
                
                if (!peerConnection) {
                    await startAudioCall(); // –ï—Å–ª–∏ –µ—â–µ –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª–∏ –∑–≤–æ–Ω–æ–∫
                }
                
                await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                
                log('–û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–≤–µ—Ç–∞ –≤ –∫–æ–º–Ω–∞—Ç—É', 'webrtc');
                await roomRef.update({
                    answer: answer,
                    from: localUid
                });
                
                updateStatus('–ó–≤–æ–Ω–æ–∫ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
            } catch (error) {
                log(`–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è: ${error.message}`, 'error');
            }
        }

        async function handleAnswer(answer) {
            try {
                log('–ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç, –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è...', 'webrtc');
                await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
                updateStatus('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
            } catch (error) {
                log(`–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—Ç–≤–µ—Ç–∞: ${error.message}`, 'error');
            }
        }

        async function handleNewICECandidate(candidateData) {
            try {
                if (peerConnection && peerConnection.remoteDescription) {
                    await peerConnection.addIceCandidate(new RTCIceCandidate(candidateData));
                    log('–î–æ–±–∞–≤–ª–µ–Ω ICE –∫–∞–Ω–¥–∏–¥–∞—Ç', 'webrtc');
                }
            } catch (error) {
                log(`–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–∞: ${error.message}`, 'error');
            }
        }

        // ========== –ó–ê–í–ï–†–®–ï–ù–ò–ï –ó–í–û–ù–ö–ê ==========
        function hangUp() {
            log('–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∑–≤–æ–Ω–∫–∞...', 'warning');
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–∏–≥–Ω–∞–ª –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏
            if (roomRef) {
                roomRef.update({ hangup: true, time: Date.now() });
            }
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            
            // –£–¥–∞–ª—è–µ–º –∞—É–¥–∏–æ —ç–ª–µ–º–µ–Ω—Ç
            const remoteAudio = document.getElementById('remoteAudio');
            if (remoteAudio) {
                remoteAudio.srcObject = null;
            }
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º UI
            document.getElementById('startCallBtn').disabled = false;
            document.getElementById('hangupBtn').disabled = true;
            
            updateStatus('–ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω');
            log('–ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω', 'info');
        }

        // ========== –û–ß–ò–°–¢–ö–ê –ü–†–ò –ó–ê–ö–†–´–¢–ò–ò –°–¢–†–ê–ù–ò–¶–´ ==========
        window.addEventListener('beforeunload', () => {
            if (roomRef) {
                roomRef.update({ hangup: true });
                roomRef.off(); // –û—Ç–ø–∏—Å—ã–≤–∞–µ–º—Å—è –æ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
            }
            
            if (peerConnection) {
                peerConnection.close();
            }
            
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
        });

        // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï ==========
        window.onload = function() {
            log('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ', 'success');
            updateStatus('–í–≤–µ–¥–∏—Ç–µ ID –∫–æ–º–Ω–∞—Ç—ã');
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª—É—á–∞–π–Ω—ã–π ID –∫–æ–º–Ω–∞—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            const randomId = Math.floor(Math.random() * 10000).toString();
            document.getElementById('roomId').value = randomId;
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
            initFirebase();
            
            log('–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ! –°–æ–∑–¥–∞–π—Ç–µ –∫–æ–º–Ω–∞—Ç—É –∏–ª–∏ –≤–æ–π–¥–∏—Ç–µ –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é.', 'success');
        };
    </script>
</body>
</html>