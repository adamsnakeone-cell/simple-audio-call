<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéß –ó–í–û–ù–ò–õ–ö–ê (–§–ò–ù–ê–õ–¨–ù–´–ô –†–ê–ë–û–ß–ò–ô –í–ê–†–ò–ê–ù–¢)</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
        body { background: #1a1a2e; color: white; min-height: 100vh; padding: 20px; }
        .container { background: #16213e; border-radius: 15px; padding: 25px; max-width: 500px; margin: 0 auto; border: 2px solid #0f3460; }
        h1 { text-align: center; color: #e94560; margin-bottom: 20px; font-size: 28px; }
        .input-group { margin: 15px 0; }
        input { width: 100%; padding: 15px; background: #0f3460; border: 2px solid #1a1a2e; border-radius: 10px; color: white; font-size: 16px; }
        input:focus { outline: none; border-color: #e94560; }
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 20px 0; }
        button { padding: 15px; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        #createBtn { background: #00b894; }
        #joinBtn { background: #0984e3; }
        #callBtn { background: #fd79a8; grid-column: span 2; }
        #hangupBtn { background: #d63031; grid-column: span 2; }
        button:disabled { background: #636e72 !important; cursor: not-allowed; opacity: 0.5; }
        .status-box { background: #2d3436; padding: 15px; border-radius: 10px; margin: 20px 0; text-align: center; min-height: 80px; display: flex; flex-direction: column; justify-content: center; }
        .status-box.connected { background: #00b89420; border: 2px solid #00b894; }
        .status-box.calling { background: #fd79a820; border: 2px solid #fd79a8; }
        .status-box.active { background: #0984e320; border: 2px solid #0984e3; }
        .log-box { background: #000; color: #00ff00; padding: 15px; border-radius: 10px; margin-top: 20px; font-family: monospace; font-size: 12px; height: 250px; overflow-y: auto; }
        .log-entry { margin-bottom: 5px; padding-bottom: 5px; border-bottom: 1px solid #333; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 1000; }
        .modal-content { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #16213e; padding: 30px; border-radius: 15px; border: 2px solid #e94560; width: 90%; max-width: 400px; text-align: center; }
        .modal-icon { font-size: 60px; margin-bottom: 20px; }
        .modal-buttons { display: flex; gap: 15px; margin-top: 25px; }
        .modal-buttons button { flex: 1; }
        .accept-btn { background: #00b894; }
        .reject-btn { background: #d63031; }
        .network-info { font-size: 12px; color: #81ecec; margin-top: 10px; }
        .debug-panel { margin-top: 15px; padding: 10px; background: #2d3436; border-radius: 8px; font-size: 11px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéß –ó–í–û–ù–ò–õ–ö–ê (–ú–ï–ñ–°–ï–¢–ï–í–ê–Ø)</h1>
        
        <div class="input-group">
            <input type="text" id="roomId" placeholder="ID –∫–æ–º–Ω–∞—Ç—ã" value="5555">
        </div>
        
        <div class="btn-grid">
            <button id="createBtn" onclick="createRoom()">–°–û–ó–î–ê–¢–¨</button>
            <button id="joinBtn" onclick="joinRoom()">–í–û–ô–¢–ò</button>
        </div>
        
        <div class="status-box" id="statusBox">
            <div id="statusText">–ì–û–¢–û–í –ö –†–ê–ë–û–¢–ï</div>
            <div id="statusInfo" class="network-info"></div>
        </div>
        
        <div class="btn-grid">
            <button id="callBtn" onclick="startCall()" disabled>üìû –ü–û–ó–í–û–ù–ò–¢–¨</button>
            <button id="hangupBtn" onclick="hangUp()" disabled>‚ùå –ó–ê–í–ï–†–®–ò–¢–¨</button>
        </div>
        
        <div class="debug-panel">
            <button onclick="testConnection()" style="width: 100%; background: #6c5ce7; padding: 10px;">
                üîß –¢–ï–°–¢ –°–û–ï–î–ò–ù–ï–ù–ò–Ø
            </button>
        </div>
        
        <div class="log-box" id="logBox"></div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª–∫–∏ -->
    <div class="modal" id="incomingModal">
        <div class="modal-content">
            <div class="modal-icon">üìû</div>
            <h2 style="color: #fd79a8;">–í–•–û–î–Ø–©–ò–ô –í–´–ó–û–í</h2>
            <p>–ö–æ–º–Ω–∞—Ç–∞: <strong id="callRoomId"></strong></p>
            <div class="modal-buttons">
                <button class="accept-btn" onclick="acceptCall()">‚úÖ –ü–†–ò–ù–Ø–¢–¨</button>
                <button class="reject-btn" onclick="rejectCall()">‚ùå –û–¢–ö–õ–û–ù–ò–¢–¨</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="waitingModal">
        <div class="modal-content">
            <div class="modal-icon">‚è≥</div>
            <h2 style="color: #fdcb6e;">–û–ñ–ò–î–ê–ù–ò–ï...</h2>
            <p>–ö–æ–º–Ω–∞—Ç–∞: <strong id="waitRoomId"></strong></p>
            <div id="connectionProgress"></div>
            <button class="reject-btn" onclick="cancelCall()" style="margin-top: 20px;">–û–¢–ú–ï–ù–ò–¢–¨</button>
        </div>
    </div>
    
    <div class="modal" id="activeModal">
        <div class="modal-content">
            <div class="modal-icon">üéß</div>
            <h2 style="color: #00b894;">–†–ê–ó–ì–û–í–û–† –ê–ö–¢–ò–í–ï–ù</h2>
            <p>–ö–æ–º–Ω–∞—Ç–∞: <strong id="activeRoomId"></strong></p>
            <div id="callStats" style="margin: 20px 0; color: #81ecec;"></div>
            <div style="margin: 20px 0;">
                <button onclick="forceAudioPlayback()" style="background: #fdcb6e; color: #2d3436; width: 100%; padding: 12px;">
                    üîä –í–ö–õ–Æ–ß–ò–¢–¨ –ó–í–£–ö –í–†–£–ß–ù–£–Æ
                </button>
            </div>
            <button class="reject-btn" onclick="hangUp()" style="padding: 15px 30px; font-size: 18px;">
                üìû –ó–ê–í–ï–†–®–ò–¢–¨ –ó–í–û–ù–û–ö
            </button>
        </div>
    </div>

    <script>
        // ========== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ==========
        const firebaseConfig = {
            apiKey: "AIzaSyDdlYdrHiGWd73F_pmwMKHrX92gK-G7kB8",
            databaseURL: "https://simple-audio-call-default-rtdb.europe-west1.firebasedatabase.app"
        };

        // –ë–ï–°–ü–õ–ê–¢–ù–´–ï TURN —Å–µ—Ä–≤–µ—Ä—ã –¥–ª—è –º–µ–∂—Å–µ—Ç–µ–≤–æ–≥–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
        const ICE_SERVERS = [
            // STUN —Å–µ—Ä–≤–µ—Ä—ã
            { urls: 'stun:stun.l.google.com:19302' },
            { urls: 'stun:stun1.l.google.com:19302' },
            { urls: 'stun:stun2.l.google.com:19302' },
            { urls: 'stun:stun3.l.google.com:19302' },
            { urls: 'stun:stun4.l.google.com:19302' },
            
            // –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ TURN —Å–µ—Ä–≤–µ—Ä—ã
            {
                urls: 'turn:openrelay.metered.ca:80',
                username: 'openrelayproject',
                credential: 'openrelayproject'
            },
            {
                urls: 'turn:openrelay.metered.ca:443',
                username: 'openrelayproject',
                credential: 'openrelayproject'
            },
            {
                urls: 'turn:openrelay.metered.ca:443?transport=tcp',
                username: 'openrelayproject',
                credential: 'openrelayproject'
            }
        ];

        // ========== –ü–ï–†–ï–ú–ï–ù–ù–´–ï ==========
        let localStream = null;
        let remoteStream = null;
        let peerConnection = null;
        let database = null;
        let roomRef = null;
        let currentRoomId = null;
        let isCaller = false;
        let callStatus = 'idle';
        let remoteAudio = null;
        let isNegotiating = false;
        let pendingRemoteDescription = null;
        let connectionAttempts = 0;

        // ========== –õ–û–ì–ò–†–û–í–ê–ù–ò–ï ==========
        function log(message, type = 'info') {
            const logBox = document.getElementById('logBox');
            const time = new Date().toLocaleTimeString();
            const colors = {
                'success': '#00ff00',
                'error': '#ff4444',
                'warning': '#ffaa00',
                'info': '#00aaff'
            };
            
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `<span style="color: #888">[${time}]</span> <span style="color: ${colors[type] || '#ffffff'}">${message}</span>`;
            logBox.appendChild(entry);
            logBox.scrollTop = logBox.scrollHeight;
            console.log(`[${type}] ${message}`);
        }

        function updateStatus(text, statusClass = '', info = '') {
            document.getElementById('statusText').textContent = text;
            document.getElementById('statusBox').className = 'status-box ' + statusClass;
            if (info) document.getElementById('statusInfo').textContent = info;
            
            // –ö–Ω–æ–ø–∫–∏
            document.getElementById('callBtn').disabled = !(currentRoomId && callStatus === 'idle');
            document.getElementById('hangupBtn').disabled = callStatus !== 'in_call';
        }

        // ========== –¢–ï–°–¢ –°–û–ï–î–ò–ù–ï–ù–ò–Ø ==========
        async function testConnection() {
            try {
                log('üîß –¢–µ—Å—Ç–∏—Ä—É—é —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ...', 'info');
                
                // –¢–µ—Å—Ç Firebase
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                database = firebase.database();
                
                // –¢–µ—Å—Ç –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                stream.getTracks().forEach(track => track.stop());
                
                // –¢–µ—Å—Ç WebRTC
                const pc = new RTCPeerConnection({ iceServers: ICE_SERVERS });
                const dc = pc.createDataChannel('test');
                
                dc.onopen = () => {
                    log('‚úÖ DataChannel —Ä–∞–±–æ—Ç–∞–µ—Ç', 'success');
                    dc.close();
                };
                
                pc.createOffer().then(offer => pc.setLocalDescription(offer));
                
                setTimeout(() => {
                    pc.close();
                    log('‚úÖ WebRTC —Ä–∞–±–æ—Ç–∞–µ—Ç', 'success');
                    alert('‚úÖ –í—Å–µ —Å–∏—Å—Ç–µ–º—ã —Ä–∞–±–æ—Ç–∞—é—Ç! –ú–æ–∂–Ω–æ –∑–≤–æ–Ω–∏—Ç—å.');
                }, 2000);
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∞: ${error.message}`, 'error');
                alert(`‚ùå –ü—Ä–æ–±–ª–µ–º–∞: ${error.message}`);
            }
        }

        // ========== –ö–û–ú–ù–ê–¢–´ ==========
        function createRoom() {
            currentRoomId = document.getElementById('roomId').value.trim() || '5555';
            document.getElementById('roomId').value = currentRoomId;
            connectToRoom(true);
        }

        function joinRoom() {
            currentRoomId = document.getElementById('roomId').value.trim();
            if (!currentRoomId) {
                alert('–í–≤–µ–¥–∏—Ç–µ ID –∫–æ–º–Ω–∞—Ç—ã');
                return;
            }
            connectToRoom(false);
        }

        function connectToRoom(isCreator) {
            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                database = firebase.database();
                
                isCaller = isCreator;
                connectionAttempts = 0;
                
                if (roomRef) roomRef.off();
                roomRef = database.ref(`rooms/${currentRoomId}`);
                
                if (isCreator) {
                    roomRef.remove().catch(() => {});
                }
                
                // –°–ª—É—à–∞–µ–º —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–µ –ø–æ–ª—è
                roomRef.on('child_added', handleRoomUpdate);
                roomRef.on('child_changed', handleRoomUpdate);
                
                updateStatus(`–ö–û–ú–ù–ê–¢–ê: ${currentRoomId}`, 'connected');
                log(`${isCreator ? '–°–æ–∑–¥–∞–Ω–∞' : '–í—Ö–æ–¥ –≤'} –∫–æ–º–Ω–∞—Ç—É ${currentRoomId}`, 'success');
                
            } catch (error) {
                log(`–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${error.message}`, 'error');
            }
        }

        // ========== –û–ë–†–ê–ë–û–¢–ö–ê –°–û–ë–´–¢–ò–ô ==========
        function handleRoomUpdate(snapshot) {
            const key = snapshot.key;
            const value = snapshot.val();
            
            // –í—Ö–æ–¥—è—â–∏–π –≤—ã–∑–æ–≤
            if (key === 'callRequest' && !isCaller && callStatus === 'idle' && value) {
                showIncomingCall();
            }
            
            // –û—Ç–≤–µ—Ç –Ω–∞ –≤—ã–∑–æ–≤
            if (key === 'callResponse' && callStatus === 'calling' && value) {
                handleCallResponse(value);
            }
            
            // WebRTC - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –≤ –∞–∫—Ç–∏–≤–Ω–æ–º –∑–≤–æ–Ω–∫–µ
            if (callStatus === 'in_call' && peerConnection) {
                if (key === 'offer' && !isCaller && value) {
                    handleOffer(value);
                }
                
                if (key === 'answer' && isCaller && value) {
                    handleAnswer(value);
                }
                
                if (key === 'iceCandidate' && value) {
                    handleIceCandidate(value);
                }
            }
            
            if (key === 'hangup' && value && callStatus === 'in_call') {
                handleRemoteHangup();
            }
        }

        function showIncomingCall() {
            if (document.getElementById('incomingModal').style.display === 'flex') return;
            
            document.getElementById('callRoomId').textContent = currentRoomId;
            document.getElementById('incomingModal').style.display = 'flex';
            callStatus = 'ringing';
            updateStatus('–í–•–û–î–Ø–©–ò–ô –í–´–ó–û–í!', 'calling');
            log('üìû –í—Ö–æ–¥—è—â–∏–π –≤—ã–∑–æ–≤', 'info');
        }

        // ========== –£–ü–†–ê–í–õ–ï–ù–ò–ï –ó–í–û–ù–ö–ê–ú–ò ==========
        function startCall() {
            callStatus = 'calling';
            document.getElementById('waitRoomId').textContent = currentRoomId;
            document.getElementById('waitingModal').style.display = 'flex';
            
            // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ
            roomRef.set({
                callRequest: { time: Date.now(), attempt: ++connectionAttempts },
                hangup: null
            }).catch(() => {});
            
            log('–í—ã–∑—ã–≤–∞—é...', 'info');
        }

        function acceptCall() {
            document.getElementById('incomingModal').style.display = 'none';
            callStatus = 'in_call';
            
            roomRef.update({
                callResponse: { accepted: true, time: Date.now() },
                hangup: null
            });
            
            initializeCall(false);
            log('‚úÖ –í—ã–∑–æ–≤ –ø—Ä–∏–Ω—è—Ç', 'success');
        }

        function rejectCall() {
            document.getElementById('incomingModal').style.display = 'none';
            callStatus = 'idle';
            
            roomRef.update({
                callResponse: { accepted: false, time: Date.now() }
            });
            
            updateStatus(`–ö–û–ú–ù–ê–¢–ê: ${currentRoomId}`, 'connected');
            log('–í—ã–∑–æ–≤ –æ—Ç–∫–ª–æ–Ω–µ–Ω', 'warning');
        }

        function handleCallResponse(response) {
            if (response.accepted) {
                callStatus = 'in_call';
                document.getElementById('waitingModal').style.display = 'none';
                initializeCall(true);
                log('‚úÖ –í—ã–∑–æ–≤ –ø—Ä–∏–Ω—è—Ç –¥—Ä—É–≥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º', 'success');
            } else {
                callStatus = 'idle';
                document.getElementById('waitingModal').style.display = 'none';
                alert('–í—ã–∑–æ–≤ –æ—Ç–∫–ª–æ–Ω–µ–Ω');
                updateStatus(`–ö–û–ú–ù–ê–¢–ê: ${currentRoomId}`, 'connected');
                log('–í—ã–∑–æ–≤ –æ—Ç–∫–ª–æ–Ω–µ–Ω –¥—Ä—É–≥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º', 'warning');
            }
        }

        function cancelCall() {
            document.getElementById('waitingModal').style.display = 'none';
            callStatus = 'idle';
            roomRef.update({ callRequest: null });
            updateStatus(`–ö–û–ú–ù–ê–¢–ê: ${currentRoomId}`, 'connected');
            log('–í—ã–∑–æ–≤ –æ—Ç–º–µ–Ω–µ–Ω', 'warning');
        }

        // ========== WEBRTC (–ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô) ==========
        async function initializeCall(isInitiator) {
            try {
                updateStatus('–ü–û–î–ì–û–¢–û–í–ö–ê –ó–í–û–ù–ö–ê...', 'calling');
                
                // –ü–æ–ª—É—á–∞–µ–º –º–∏–∫—Ä–æ—Ñ–æ–Ω —Å –±–∞–∑–æ–≤—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
                localStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        channelCount: 1,
                        sampleRate: 16000, // –ù–∏–∑–∫–∞—è —á–∞—Å—Ç–æ—Ç–∞ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
                        echoCancellation: false,
                        noiseSuppression: false,
                        autoGainControl: false
                    }
                });
                
                log('üé§ –ú–∏–∫—Ä–æ—Ñ–æ–Ω –ø–æ–¥–∫–ª—é—á–µ–Ω', 'success');
                
                // –°–æ–∑–¥–∞–µ–º PeerConnection
                peerConnection = new RTCPeerConnection({
                    iceServers: ICE_SERVERS,
                    iceTransportPolicy: 'relay', // –ü—Ä–æ–±—É–µ–º —Ç–æ–ª—å–∫–æ relay –¥–ª—è –º–µ–∂—Å–µ—Ç–µ–≤–æ–≥–æ
                    iceCandidatePoolSize: 5
                });
                
                pendingRemoteDescription = null;
                isNegotiating = false;
                
                // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π —Ç—Ä–µ–∫
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
                
                // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
                setupPeerConnectionHandlers(isInitiator);
                
                // –ï—Å–ª–∏ –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä - —Å–æ–∑–¥–∞–µ–º offer
                if (isInitiator) {
                    await createAndSendOffer();
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∑–≤–æ–Ω–æ–∫
                document.getElementById('activeRoomId').textContent = currentRoomId;
                document.getElementById('activeModal').style.display = 'flex';
                updateStatus('–†–ê–ó–ì–û–í–û–† –ê–ö–¢–ò–í–ï–ù', 'active', '–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ...');
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ${error.message}`, 'error');
                hangUp();
            }
        }

        function setupPeerConnectionHandlers(isInitiator) {
            // ICE –∫–∞–Ω–¥–∏–¥–∞—Ç—ã
            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    const type = event.candidate.type;
                    log(`‚ùÑÔ∏è ICE –∫–∞–Ω–¥–∏–¥–∞—Ç: ${type}`, 'info');
                    
                    if (type === 'relay' || type === 'srflx') {
                        roomRef.update({ 
                            iceCandidate: event.candidate,
                            timestamp: Date.now()
                        });
                    }
                }
            };
            
            // –£–¥–∞–ª–µ–Ω–Ω—ã–π –ø–æ—Ç–æ–∫
            peerConnection.ontrack = (event) => {
                log('üîä –ü–û–õ–£–ß–ï–ù –£–î–ê–õ–ï–ù–ù–´–ô –ü–û–¢–û–ö!', 'success');
                
                if (!remoteStream) {
                    remoteStream = new MediaStream();
                }
                
                remoteStream.addTrack(event.track);
                
                // –°–æ–∑–¥–∞–µ–º –∞—É–¥–∏–æ —ç–ª–µ–º–µ–Ω—Ç
                if (!remoteAudio) {
                    remoteAudio = new Audio();
                    remoteAudio.id = 'remoteAudio';
                    remoteAudio.hidden = true;
                    document.body.appendChild(remoteAudio);
                }
                
                // –ù–∞–∑–Ω–∞—á–∞–µ–º –ø–æ—Ç–æ–∫
                remoteAudio.srcObject = remoteStream;
                remoteAudio.autoplay = true;
                remoteAudio.muted = false;
                remoteAudio.volume = 1.0;
                
                // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–ø—É—Å–∫–∞–µ–º
                setTimeout(() => {
                    forceAudioPlayback();
                    checkAudioStatus();
                }, 500);
            };
            
            // –°–æ—Å—Ç–æ—è–Ω–∏–µ ICE
            peerConnection.oniceconnectionstatechange = () => {
                const state = peerConnection.iceConnectionState;
                log(`üßä ICE —Å–æ—Å—Ç–æ—è–Ω–∏–µ: ${state}`, 'info');
                
                if (state === 'connected' || state === 'completed') {
                    log('‚úÖ ICE —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!', 'success');
                    document.getElementById('callStats').textContent = '–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ —á–µ—Ä–µ–∑ TURN';
                    updateStatus('–°–û–ï–î–ò–ù–ï–ù–ò–ï –£–°–¢–ê–ù–û–í–õ–ï–ù–û!', 'active', '–ó–≤—É–∫ –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å');
                }
                
                if (state === 'failed') {
                    log('‚ùå ICE –Ω–µ —É–¥–∞–ª–æ—Å—å', 'error');
                    if (connectionAttempts < 3) {
                        setTimeout(() => reconnectCall(), 2000);
                    }
                }
            };
            
            // –°–∏–≥–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            peerConnection.onsignalingstatechange = () => {
                log(`üì∂ –°–∏–≥–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ: ${peerConnection.signalingState}`, 'info');
            };
            
            // –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
            peerConnection.onconnectionstatechange = () => {
                const state = peerConnection.connectionState;
                log(`üîó –°–æ—Å—Ç–æ—è–Ω–∏–µ: ${state}`, 'info');
                
                if (state === 'connected') {
                    log('üéâ –°–û–ï–î–ò–ù–ï–ù–ò–ï –£–°–¢–ê–ù–û–í–õ–ï–ù–û!', 'success');
                }
            };
        }

        async function createAndSendOffer() {
            if (isNegotiating) return;
            
            try {
                isNegotiating = true;
                log('–°–æ–∑–¥–∞—é –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ...', 'info');
                
                const offer = await peerConnection.createOffer({
                    offerToReceiveAudio: true,
                    voiceActivityDetection: false
                });
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ü–ï–†–í–´–ú
                await peerConnection.setLocalDescription(offer);
                log('–õ–æ–∫–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ', 'success');
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º offer
                await roomRef.update({ 
                    offer: offer,
                    offerTimestamp: Date.now()
                });
                log('–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ', 'success');
                
                isNegotiating = false;
                
            } catch (error) {
                isNegotiating = false;
                log(`‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è: ${error.message}`, 'error');
            }
        }

        async function handleOffer(offer) {
            if (isNegotiating || peerConnection.signalingState !== 'stable') {
                log(`‚ö†Ô∏è –ù–µ –≥–æ—Ç–æ–≤ –∫ offer. –°–æ—Å—Ç–æ—è–Ω–∏–µ: ${peerConnection.signalingState}`, 'warning');
                pendingRemoteDescription = offer;
                setTimeout(() => retryPendingDescription(), 1000);
                return;
            }
            
            try {
                isNegotiating = true;
                log('–ü–æ–ª—É—á–∏–ª –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ, —Å–æ–∑–¥–∞—é –æ—Ç–≤–µ—Ç...', 'info');
                
                // 1. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —É–¥–∞–ª–µ–Ω–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
                await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
                log('–£–¥–∞–ª–µ–Ω–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ', 'success');
                
                // 2. –°–æ–∑–¥–∞–µ–º –æ—Ç–≤–µ—Ç
                const answer = await peerConnection.createAnswer({
                    voiceActivityDetection: false
                });
                
                // 3. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
                await peerConnection.setLocalDescription(answer);
                log('–õ–æ–∫–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ', 'success');
                
                // 4. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç
                await roomRef.update({ 
                    answer: answer,
                    answerTimestamp: Date.now()
                });
                log('–û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω', 'success');
                
                isNegotiating = false;
                
            } catch (error) {
                isNegotiating = false;
                log(`‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è: ${error.message}`, 'error');
                
                if (error.message.includes('wrong state') || error.message.includes('stable')) {
                    log('‚ö†Ô∏è –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞—é PeerConnection...', 'warning');
                    setTimeout(() => {
                        if (callStatus === 'in_call') {
                            restartPeerConnection();
                        }
                    }, 1000);
                }
            }
        }

        async function handleAnswer(answer) {
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                if (peerConnection.signalingState !== 'have-local-offer') {
                    log(`‚ö†Ô∏è –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è answer: ${peerConnection.signalingState}`, 'warning');
                    return;
                }
                
                log('–ü–æ–ª—É—á–∏–ª –æ—Ç–≤–µ—Ç, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é...', 'info');
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —É–¥–∞–ª–µ–Ω–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
                await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
                log('–û—Ç–≤–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω', 'success');
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—Ç–≤–µ—Ç–∞: ${error.message}`, 'error');
                
                if (error.message.includes('wrong state')) {
                    log('‚ö†Ô∏è –ñ–¥—É —Å—Ç–∞–±–∏–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è...', 'warning');
                    setTimeout(() => {
                        if (callStatus === 'in_call' && peerConnection.signalingState === 'have-local-offer') {
                            handleAnswer(answer);
                        }
                    }, 500);
                }
            }
        }

        async function handleIceCandidate(candidate) {
            try {
                if (peerConnection && peerConnection.remoteDescription) {
                    await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
                }
            } catch (error) {
                // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ ICE
            }
        }

        function retryPendingDescription() {
            if (pendingRemoteDescription && peerConnection.signalingState === 'stable') {
                handleOffer(pendingRemoteDescription);
                pendingRemoteDescription = null;
            }
        }

        function restartPeerConnection() {
            log('üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—é —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ...', 'warning');
            
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            
            if (callStatus === 'in_call') {
                initializeCall(isCaller);
            }
        }

        function reconnectCall() {
            connectionAttempts++;
            log(`üîÑ –ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è #${connectionAttempts}`, 'warning');
            
            if (callStatus === 'in_call' && connectionAttempts <= 3) {
                hangUp();
                setTimeout(() => {
                    if (isCaller) {
                        startCall();
                    }
                }, 1000);
            }
        }

        // ========== –ê–£–î–ò–û –§–£–ù–ö–¶–ò–ò ==========
        function forceAudioPlayback() {
            log('üîä –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –≤–∫–ª—é—á–∞—é –∑–≤—É–∫...', 'info');
            
            if (!remoteAudio && remoteStream) {
                remoteAudio = new Audio();
                remoteAudio.srcObject = remoteStream;
                remoteAudio.hidden = true;
                document.body.appendChild(remoteAudio);
            }
            
            if (remoteAudio) {
                remoteAudio.muted = false;
                remoteAudio.volume = 1.0;
                
                const playPromise = remoteAudio.play();
                if (playPromise !== undefined) {
                    playPromise.catch(error => {
                        log(`‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏: ${error.message}`, 'error');
                        alert('‚ö†Ô∏è –ù–∞–∂–º–∏—Ç–µ —Ä–∞–∑—Ä–µ—à–∏—Ç—å –∞–≤—Ç–æ–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ!');
                    }).then(() => {
                        log('‚úÖ –ó–≤—É–∫ –∑–∞–ø—É—â–µ–Ω –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ', 'success');
                    });
                }
            }
            
            checkAudioStatus();
        }

        function checkAudioStatus() {
            setTimeout(() => {
                if (!remoteAudio) return;
                
                const isPlaying = !remoteAudio.paused && remoteAudio.duration > 0;
                const info = isPlaying ? 
                    '‚úÖ –ó–í–£–ö –†–ê–ë–û–¢–ê–ï–¢! –ì–æ–≤–æ—Ä–∏—Ç–µ.' : 
                    '‚ö†Ô∏è –ó–≤—É–∫ –Ω–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –≤–∫–ª—é—á–µ–Ω–∏—è.';
                
                document.getElementById('callStats').textContent = info;
                log(`üìä –°—Ç–∞—Ç—É—Å –∞—É–¥–∏–æ: playing=${isPlaying}`, isPlaying ? 'success' : 'warning');
            }, 1000);
        }

        function handleRemoteHangup() {
            log('–°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –∑–∞–≤–µ—Ä—à–∏–ª –∑–≤–æ–Ω–æ–∫', 'warning');
            alert('–°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –∑–∞–≤–µ—Ä—à–∏–ª –∑–≤–æ–Ω–æ–∫');
            hangUp();
        }

        // ========== –ó–ê–í–ï–†–®–ï–ù–ò–ï ==========
        function hangUp() {
            log('–ó–∞–≤–µ—Ä—à–∞—é –∑–≤–æ–Ω–æ–∫...', 'warning');
            
            // –°–∏–≥–Ω–∞–ª –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏
            if (roomRef) {
                roomRef.set({ 
                    hangup: true,
                    hangupTime: Date.now()
                }).catch(() => {});
                
                setTimeout(() => roomRef.off(), 1000);
            }
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ—Ç–æ–∫–∏
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            
            if (remoteStream) {
                remoteStream.getTracks().forEach(track => track.stop());
                remoteStream = null;
            }
            
            // –û—á–∏—â–∞–µ–º –∞—É–¥–∏–æ
            if (remoteAudio) {
                remoteAudio.pause();
                remoteAudio.srcObject = null;
                remoteAudio.remove();
                remoteAudio = null;
            }
            
            // –û—á–∏—â–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
            pendingRemoteDescription = null;
            isNegotiating = false;
            
            // –°–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫–∏
            document.getElementById('incomingModal').style.display = 'none';
            document.getElementById('waitingModal').style.display = 'none';
            document.getElementById('activeModal').style.display = 'none';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
            callStatus = 'idle';
            if (currentRoomId) {
                updateStatus(`–ö–û–ú–ù–ê–¢–ê: ${currentRoomId}`, 'connected');
            } else {
                updateStatus('–ì–û–¢–û–í –ö –†–ê–ë–û–¢–ï', '');
            }
            
            log('–ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω', 'info');
        }

        // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
        function init() {
            log('‚úÖ –ó–≤–æ–Ω–∏–ª–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞', 'success');
            updateStatus('–ì–û–¢–û–í –ö –†–ê–ë–û–¢–ï');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É
            if (!navigator.mediaDevices || !window.RTCPeerConnection) {
                alert('‚ùå –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç WebRTC!');
                return;
            }
            
            log('‚úÖ WebRTC –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è', 'success');
        }

        // –û—á–∏—Å—Ç–∫–∞
        window.addEventListener('beforeunload', () => {
            if (callStatus === 'in_call') hangUp();
            if (roomRef) roomRef.off();
        });

        window.onload = init;
    </script>
</body>
</html>
