<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéß –í–µ–± –ó–≤–æ–Ω–∏–ª–∫–∞</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            width: 100%;
            max-width: 400px;
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 20px;
            font-size: 24px;
        }
        
        input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 10px;
        }
        
        input:focus {
            border-color: #667eea;
            outline: none;
        }
        
        .buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 15px 0;
        }
        
        button {
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: 0.3s;
        }
        
        button:hover:not(:disabled) {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        
        #createBtn { background: #4CAF50; color: white; }
        #joinBtn { background: #2196F3; color: white; }
        #startCallBtn { background: #FF9800; color: white; grid-column: span 2; }
        #hangupBtn { background: #f44336; color: white; grid-column: span 2; }
        #testMicBtn { background: #9C27B0; color: white; font-size: 14px; padding: 8px; }
        
        button:disabled {
            background: #ccc !important;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .status {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
            font-weight: bold;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .status.connected { background: #e8f5e9; color: #2e7d32; }
        .status.calling { background: #fff3e0; color: #ef6c00; }
        .status.in-call { background: #e3f2fd; color: #1565c0; }
        
        .mic-test {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }
        
        .mic-indicator {
            height: 20px;
            flex: 1;
            background: #eee;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .mic-level {
            height: 100%;
            background: #4CAF50;
            width: 0%;
            transition: width 0.1s;
        }
        
        .log {
            background: #1a1a1a;
            color: #0f0;
            padding: 10px;
            border-radius: 5px;
            margin-top: 15px;
            font-family: monospace;
            font-size: 12px;
            max-height: 150px;
            overflow-y: auto;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            max-width: 350px;
            width: 90%;
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .modal-buttons button {
            flex: 1;
        }
        
        .accept { background: #4CAF50; color: white; }
        .reject { background: #f44336; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéß –ü—Ä–æ—Å—Ç–∞—è –ó–≤–æ–Ω–∏–ª–∫–∞</h1>
        
        <input type="text" id="roomId" placeholder="ID –∫–æ–º–Ω–∞—Ç—ã" value="1234">
        
        <div class="buttons">
            <button id="createBtn" onclick="createRoom()">–°–æ–∑–¥–∞—Ç—å</button>
            <button id="joinBtn" onclick="joinRoom()">–í–æ–π—Ç–∏</button>
        </div>
        
        <div class="status" id="status">–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ</div>
        
        <div class="buttons">
            <button id="startCallBtn" onclick="startCall()" disabled>–ü–æ–∑–≤–æ–Ω–∏—Ç—å</button>
            <button id="hangupBtn" onclick="hangUp()" disabled>–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
        </div>
        
        <div class="mic-test">
            <button id="testMicBtn" onclick="testMicrophone()">üé§ –¢–µ—Å—Ç</button>
            <div class="mic-indicator">
                <div class="mic-level" id="micLevel"></div>
            </div>
        </div>
        
        <div class="log" id="log"></div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª–∫–∏ -->
    <div class="modal" id="incomingModal">
        <div class="modal-content">
            <div style="font-size: 40px;">üìû</div>
            <h3>–í—Ö–æ–¥—è—â–∏–π –≤—ã–∑–æ–≤!</h3>
            <p>ID –∫–æ–º–Ω–∞—Ç—ã: <strong id="callRoomId"></strong></p>
            <div class="modal-buttons">
                <button class="accept" onclick="acceptCall()">–ü—Ä–∏–Ω—è—Ç—å</button>
                <button class="reject" onclick="rejectCall()">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="waitingModal">
        <div class="modal-content">
            <div style="font-size: 40px;">‚è≥</div>
            <h3>–û–∂–∏–¥–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞...</h3>
            <p>ID –∫–æ–º–Ω–∞—Ç—ã: <strong id="waitRoomId"></strong></p>
            <button class="reject" onclick="cancelCall()">–û—Ç–º–µ–Ω–∏—Ç—å</button>
        </div>
    </div>
    
    <div class="modal" id="activeModal">
        <div class="modal-content">
            <div style="font-size: 40px;">üéß</div>
            <h3>–ò–¥–µ—Ç —Ä–∞–∑–≥–æ–≤–æ—Ä</h3>
            <p>ID –∫–æ–º–Ω–∞—Ç—ã: <strong id="activeRoomId"></strong></p>
            <div style="margin: 20px 0;">
                <div>–ì—Ä–æ–º–∫–æ—Å—Ç—å:</div>
                <div class="mic-indicator" style="height: 10px;">
                    <div class="mic-level" id="callVolume"></div>
                </div>
            </div>
            <button class="reject" onclick="hangUp()">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
        </div>
    </div>

    <script>
        // ========== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ==========
        const firebaseConfig = {
            apiKey: "AIzaSyDdlYdrHiGWd73F_pmwMKHrX92gK-G7kB8",
            databaseURL: "https://simple-audio-call-default-rtdb.europe-west1.firebasedatabase.app"
        };

        // ========== –ü–ï–†–ï–ú–ï–ù–ù–´–ï ==========
        let localStream = null;
        let remoteStream = null;
        let peerConnection = null;
        let database = null;
        let roomRef = null;
        let currentRoomId = null;
        let isCaller = false;
        let callStatus = 'idle';
        let audioContext = null;
        let analyser = null;
        let micInterval = null;

        // ========== –õ–û–ì–ò–†–û–í–ê–ù–ò–ï ==========
        function log(msg, type = 'info') {
            const logEl = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            const icons = { 'success': '‚úÖ', 'error': '‚ùå', 'warning': '‚ö†Ô∏è', 'info': 'üìû' };
            const entry = `${time} ${icons[type] || 'üìù'} ${msg}`;
            logEl.innerHTML += entry + '<br>';
            logEl.scrollTop = logEl.scrollHeight;
            console.log(`[${type}] ${msg}`);
        }

        function updateStatus(text, className = '') {
            const status = document.getElementById('status');
            status.textContent = text;
            status.className = 'status ' + className;
        }

        // ========== –¢–ï–°–¢ –ú–ò–ö–†–û–§–û–ù–ê ==========
        async function testMicrophone() {
            try {
                log('–¢–µ—Å—Ç–∏—Ä—É—é –º–∏–∫—Ä–æ—Ñ–æ–Ω...');
                updateStatus('–ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞...', 'calling');
                
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–µ—Å—Ç
                if (localStream) {
                    localStream.getTracks().forEach(track => track.stop());
                }
                if (micInterval) clearInterval(micInterval);
                
                // –ü–†–û–°–¢–´–ï –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: false,    // –í–´–ö–õ–Æ–ß–ê–ï–ú - –º–æ–∂–µ—Ç –º–µ—à–∞—Ç—å
                        noiseSuppression: false,    // –í–´–ö–õ–Æ–ß–ê–ï–ú
                        autoGainControl: false,     // –í–´–ö–õ–Æ–ß–ê–ï–ú
                        channelCount: 1,
                        sampleRate: 44100,
                        sampleSize: 16,
                        volume: 1.0
                    }
                });
                
                log('‚úÖ –ú–∏–∫—Ä–æ—Ñ–æ–Ω –¥–æ—Å—Ç—É–ø–µ–Ω');
                
                // –¢–µ—Å—Ç–∏—Ä—É–µ–º –∑–≤—É–∫
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                const source = audioContext.createMediaStreamSource(stream);
                source.connect(analyser);
                analyser.fftSize = 256;
                
                // –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è
                micInterval = setInterval(() => {
                    const data = new Uint8Array(analyser.frequencyBinCount);
                    analyser.getByteFrequencyData(data);
                    
                    let sum = 0;
                    for (let i = 0; i < data.length; i++) sum += data[i];
                    let avg = sum / data.length;
                    let percent = Math.min(100, (avg / 128) * 100);
                    
                    document.getElementById('micLevel').style.width = percent + '%';
                    
                    // –¶–≤–µ—Ç –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞
                    const level = document.getElementById('micLevel');
                    if (percent > 30) {
                        level.style.background = '#4CAF50';
                        level.style.width = '100%';
                    } else if (percent > 10) {
                        level.style.background = '#FF9800';
                        level.style.width = '50%';
                    } else {
                        level.style.background = '#f44336';
                        level.style.width = '10%';
                    }
                }, 100);
                
                // –ì–æ–≤–æ—Ä–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
                alert('–ì–û–í–û–†–ò–¢–ï –°–ï–ô–ß–ê–°! –ü—Ä–æ–≤–µ—Ä—è—é –º–∏–∫—Ä–æ—Ñ–æ–Ω...');
                
                // –ñ–¥–µ–º 3 —Å–µ–∫—É–Ω–¥—ã –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º
                setTimeout(() => {
                    const data = new Uint8Array(analyser.frequencyBinCount);
                    analyser.getByteFrequencyData(data);
                    let hasSound = data.some(v => v > 10);
                    
                    if (hasSound) {
                        log('‚úÖ –ú–∏–∫—Ä–æ—Ñ–æ–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—Ç–ª–∏—á–Ω–æ!', 'success');
                        updateStatus('–ú–∏–∫—Ä–æ—Ñ–æ–Ω –≥–æ—Ç–æ–≤', 'connected');
                    } else {
                        log('‚ö†Ô∏è –ú–∏–∫—Ä–æ—Ñ–æ–Ω –µ—Å—Ç—å, –Ω–æ –∑–≤—É–∫–∞ –Ω–µ —Å–ª—ã—à–Ω–æ', 'warning');
                        updateStatus('–ì–æ–≤–æ—Ä–∏—Ç–µ –≥—Ä–æ–º—á–µ', 'calling');
                    }
                    
                    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ—Å—Ç —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
                    setTimeout(() => {
                        if (micInterval) clearInterval(micInterval);
                        stream.getTracks().forEach(track => track.stop());
                        if (audioContext) audioContext.close();
                        document.getElementById('micLevel').style.width = '0%';
                        updateStatus('–ì–æ—Ç–æ–≤ –∫ –∑–≤–æ–Ω–∫—É', 'connected');
                    }, 5000);
                    
                }, 3000);
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞: ${error.message}`, 'error');
                updateStatus('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É', '');
                alert('–î–ê–ô–¢–ï –†–ê–ó–†–ï–®–ï–ù–ò–ï –ù–ê –ú–ò–ö–†–û–§–û–ù!');
            }
        }

        // ========== –ö–û–ú–ù–ê–¢–´ ==========
        function createRoom() {
            currentRoomId = document.getElementById('roomId').value.trim();
            if (!currentRoomId) {
                currentRoomId = Math.floor(1000 + Math.random() * 9000).toString();
                document.getElementById('roomId').value = currentRoomId;
            }
            connectToRoom(true);
        }

        function joinRoom() {
            currentRoomId = document.getElementById('roomId').value.trim();
            if (!currentRoomId) {
                alert('–í–≤–µ–¥–∏—Ç–µ ID –∫–æ–º–Ω–∞—Ç—ã');
                return;
            }
            connectToRoom(false);
        }

        function connectToRoom(isCreator) {
            try {
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Firebase
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                database = firebase.database();
                
                isCaller = isCreator;
                
                // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ
                if (roomRef) roomRef.off();
                roomRef = database.ref(`rooms/${currentRoomId}`);
                
                // –û—á–∏—â–∞–µ–º –µ—Å–ª–∏ —Å–æ–∑–¥–∞–µ–º
                if (isCreator) {
                    roomRef.remove();
                }
                
                // –°–ª—É—à–∞–µ–º —Å–æ–±—ã—Ç–∏—è
                roomRef.on('value', handleRoomUpdate);
                
                updateStatus(`–í –∫–æ–º–Ω–∞—Ç–µ: ${currentRoomId}`, 'connected');
                document.getElementById('startCallBtn').disabled = false;
                log(`${isCreator ? '–°–æ–∑–¥–∞–ª' : '–í–æ—à–µ–ª –≤'} –∫–æ–º–Ω–∞—Ç—É ${currentRoomId}`, 'success');
                
            } catch (error) {
                log(`–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${error.message}`, 'error');
            }
        }

        function handleRoomUpdate(snapshot) {
            const data = snapshot.val();
            if (!data) return;
            
            // –í—Ö–æ–¥—è—â–∏–π –≤—ã–∑–æ–≤
            if (data.callRequest && !isCaller && callStatus === 'idle') {
                document.getElementById('callRoomId').textContent = currentRoomId;
                document.getElementById('incomingModal').style.display = 'flex';
                callStatus = 'ringing';
                log('–í—Ö–æ–¥—è—â–∏–π –≤—ã–∑–æ–≤!', 'info');
            }
            
            // –û—Ç–≤–µ—Ç –Ω–∞ –≤—ã–∑–æ–≤
            if (data.callResponse && callStatus === 'calling') {
                if (data.callResponse.accepted) {
                    document.getElementById('waitingModal').style.display = 'none';
                    callStatus = 'in_call';
                    startWebRTC(true);
                    log('‚úÖ –í—ã–∑–æ–≤ –ø—Ä–∏–Ω—è—Ç!', 'success');
                } else {
                    document.getElementById('waitingModal').style.display = 'none';
                    callStatus = 'idle';
                    alert('–í—ã–∑–æ–≤ –æ—Ç–∫–ª–æ–Ω–µ–Ω');
                    log('–í—ã–∑–æ–≤ –æ—Ç–∫–ª–æ–Ω–µ–Ω', 'warning');
                }
            }
            
            // WebRTC —Å–∏–≥–Ω–∞–ª—ã
            if (data.offer && !isCaller && peerConnection && callStatus === 'in_call') {
                handleOffer(data.offer);
            }
            
            if (data.answer && isCaller && peerConnection && callStatus === 'in_call') {
                handleAnswer(data.answer);
            }
            
            if (data.iceCandidate && peerConnection) {
                handleIceCandidate(data.iceCandidate);
            }
            
            if (data.hangup) {
                hangUp();
                alert('–°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –∑–∞–≤–µ—Ä—à–∏–ª –∑–≤–æ–Ω–æ–∫');
            }
        }

        // ========== –ó–í–û–ù–ö–ò ==========
        function startCall() {
            if (!currentRoomId || callStatus !== 'idle') return;
            
            callStatus = 'calling';
            document.getElementById('waitRoomId').textContent = currentRoomId;
            document.getElementById('waitingModal').style.display = 'flex';
            
            roomRef.update({
                callRequest: {
                    time: Date.now(),
                    from: 'user'
                }
            });
            
            log('–í—ã–∑—ã–≤–∞—é...', 'info');
        }

        function acceptCall() {
            document.getElementById('incomingModal').style.display = 'none';
            callStatus = 'in_call';
            
            roomRef.update({
                callResponse: {
                    accepted: true,
                    time: Date.now()
                }
            });
            
            startWebRTC(false);
            log('–ü—Ä–∏–Ω—è–ª –≤—ã–∑–æ–≤', 'success');
        }

        function rejectCall() {
            document.getElementById('incomingModal').style.display = 'none';
            callStatus = 'idle';
            
            roomRef.update({
                callResponse: {
                    accepted: false,
                    time: Date.now()
                }
            });
            
            log('–û—Ç–∫–ª–æ–Ω–∏–ª –≤—ã–∑–æ–≤', 'warning');
        }

        function cancelCall() {
            document.getElementById('waitingModal').style.display = 'none';
            callStatus = 'idle';
            roomRef.update({ callRequest: null });
            log('–û—Ç–º–µ–Ω–∏–ª –≤—ã–∑–æ–≤', 'warning');
        }

        // ========== WEBRTC (–£–ü–†–û–©–ï–ù–ù–´–ô) ==========
        async function startWebRTC(isInitiator) {
            try {
                updateStatus('–ü–æ–¥–∫–ª—é—á–∞—é—Å—å...', 'calling');
                
                // –ü–†–û–°–¢–û–ô –∑–∞–ø—Ä–æ—Å –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
                localStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: false,
                        noiseSuppression: false,
                        autoGainControl: false,
                        channelCount: 1
                    }
                });
                
                log('‚úÖ –ú–∏–∫—Ä–æ—Ñ–æ–Ω –≥–æ—Ç–æ–≤ –¥–ª—è –∑–≤–æ–Ω–∫–∞');
                
                // –°–æ–∑–¥–∞–µ–º PeerConnection —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
                peerConnection = new RTCPeerConnection({
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' }
                    ]
                });
                
                // –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞—à –º–∏–∫—Ä–æ—Ñ–æ–Ω
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
                
                // –ö–æ–≥–¥–∞ –ø–æ–ª—É—á–∞–µ–º —É–¥–∞–ª–µ–Ω–Ω—ã–π –∑–≤—É–∫
                peerConnection.ontrack = (event) => {
                    log('‚úÖ –ü–æ–ª—É—á–∏–ª —É–¥–∞–ª–µ–Ω–Ω—ã–π –∑–≤—É–∫!', 'success');
                    
                    if (!remoteStream) {
                        remoteStream = new MediaStream();
                    }
                    remoteStream.addTrack(event.track);
                    
                    // –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –∑–≤—É–∫
                    const audio = new Audio();
                    audio.srcObject = remoteStream;
                    audio.autoplay = true;
                    audio.volume = 1.0;
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∑–≤—É–∫ –∏–≥—Ä–∞–µ—Ç
                    setTimeout(() => {
                        if (audio.duration > 0 && !audio.paused) {
                            log('üîä –ó–≤—É–∫ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è!', 'success');
                            updateStatus('–ì–æ–≤–æ—Ä–∏—Ç–µ!', 'in-call');
                        }
                    }, 1000);
                };
                
                // ICE –∫–∞–Ω–¥–∏–¥–∞—Ç—ã
                peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        roomRef.update({ iceCandidate: event.candidate });
                    }
                };
                
                // –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
                peerConnection.onconnectionstatechange = () => {
                    const state = peerConnection.connectionState;
                    log(`–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ: ${state}`, 'webrtc');
                    
                    if (state === 'connected') {
                        log('‚úÖ –°–û–ï–î–ò–ù–ï–ù–ò–ï –£–°–¢–ê–ù–û–í–õ–ï–ù–û!', 'success');
                        document.getElementById('activeRoomId').textContent = currentRoomId;
                        document.getElementById('activeModal').style.display = 'flex';
                        updateStatus('–°–æ–µ–¥–∏–Ω–µ–Ω–æ! –ì–æ–≤–æ—Ä–∏—Ç–µ.', 'in-call');
                        startVolumeMeter();
                    }
                    
                    if (state === 'disconnected' || state === 'failed') {
                        log('‚ùå –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ', 'error');
                        hangUp();
                    }
                };
                
                // –°–æ–∑–¥–∞–µ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –µ—Å–ª–∏ –º—ã –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä
                if (isInitiator) {
                    const offer = await peerConnection.createOffer();
                    await peerConnection.setLocalDescription(offer);
                    roomRef.update({ offer: offer });
                    log('–û—Ç–ø—Ä–∞–≤–∏–ª –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ', 'webrtc');
                }
                
            } catch (error) {
                log(`‚ùå WebRTC –æ—à–∏–±–∫–∞: ${error.message}`, 'error');
                hangUp();
            }
        }

        async function handleOffer(offer) {
            try {
                await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                roomRef.update({ answer: answer });
                log('–û—Ç–ø—Ä–∞–≤–∏–ª –æ—Ç–≤–µ—Ç', 'webrtc');
            } catch (error) {
                log(`–û—à–∏–±–∫–∞ offer: ${error}`, 'error');
            }
        }

        async function handleAnswer(answer) {
            try {
                await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
                log('–ü–æ–ª—É—á–∏–ª –æ—Ç–≤–µ—Ç', 'webrtc');
            } catch (error) {
                log(`–û—à–∏–±–∫–∞ answer: ${error}`, 'error');
            }
        }

        async function handleIceCandidate(candidate) {
            try {
                await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
            } catch (error) {
                // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ ICE
            }
        }

        // ========== –ò–ù–î–ò–ö–ê–¢–û–† –ì–†–û–ú–ö–û–°–¢–ò ==========
        function startVolumeMeter() {
            if (!localStream) return;
            
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                const source = audioContext.createMediaStreamSource(localStream);
                source.connect(analyser);
                analyser.fftSize = 64;
                
                const checkVolume = () => {
                    if (callStatus !== 'in_call') return;
                    
                    const data = new Uint8Array(analyser.frequencyBinCount);
                    analyser.getByteFrequencyData(data);
                    
                    let sum = 0;
                    for (let i = 0; i < data.length; i++) sum += data[i];
                    let avg = sum / data.length;
                    let percent = Math.min(100, (avg / 64) * 200); // –£—Å–∏–ª–∏–≤–∞–µ–º
                    
                    document.getElementById('callVolume').style.width = percent + '%';
                    
                    // –¶–≤–µ—Ç –ø—Ä–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä–µ
                    const volumeEl = document.getElementById('callVolume');
                    if (percent > 20) {
                        volumeEl.style.background = '#4CAF50';
                    } else {
                        volumeEl.style.background = '#9E9E9E';
                    }
                    
                    requestAnimationFrame(checkVolume);
                };
                
                checkVolume();
                
            } catch (error) {
                console.log('–ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:', error);
            }
        }

        // ========== –ó–ê–í–ï–†–®–ï–ù–ò–ï ==========
        function hangUp() {
            log('–ó–∞–≤–µ—Ä—à–∞—é –∑–≤–æ–Ω–æ–∫...', 'warning');
            
            callStatus = 'idle';
            
            // –°–∏–≥–Ω–∞–ª –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏
            if (roomRef) {
                roomRef.update({ hangup: true });
                setTimeout(() => roomRef.update({ hangup: null }), 1000);
            }
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ—Ç–æ–∫–∏
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            
            if (remoteStream) {
                remoteStream.getTracks().forEach(track => track.stop());
                remoteStream = null;
            }
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –∞—É–¥–∏–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç
            if (audioContext) {
                audioContext.close();
                audioContext = null;
            }
            
            // –°–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫–∏
            document.getElementById('incomingModal').style.display = 'none';
            document.getElementById('waitingModal').style.display = 'none';
            document.getElementById('activeModal').style.display = 'none';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
            if (currentRoomId) {
                updateStatus(`–í –∫–æ–º–Ω–∞—Ç–µ: ${currentRoomId}`, 'connected');
            } else {
                updateStatus('–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ', '');
            }
            
            document.getElementById('startCallBtn').disabled = !currentRoomId;
            document.getElementById('hangupBtn').disabled = true;
            
            log('–ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω', 'info');
        }

        // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
        function init() {
            log('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ', 'success');
            updateStatus('–í–≤–µ–¥–∏—Ç–µ ID –∫–æ–º–Ω–∞—Ç—ã');
        }

        // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
        window.addEventListener('beforeunload', () => {
            if (roomRef) {
                roomRef.update({ hangup: true });
                roomRef.off();
            }
            hangUp();
        });

        window.onload = init;
    </script>
</body>
</html>
