<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéß –ó–≤–æ–Ω–∏–ª–∫–∞ (–º–µ–∂—Å–µ—Ç–µ–≤–∞—è)</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
        
        body {
            background: linear-gradient(135deg, #1a2980, #26d0ce);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 450px;
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 20px;
            font-size: 26px;
        }
        
        input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            margin-bottom: 15px;
            transition: 0.3s;
        }
        
        input:focus {
            border-color: #1a2980;
            outline: none;
            box-shadow: 0 0 0 3px rgba(26,41,128,0.1);
        }
        
        .btn-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 15px 0;
        }
        
        button {
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        #createBtn { background: #00C853; color: white; }
        #joinBtn { background: #2979FF; color: white; }
        #callBtn { background: #FF6D00; color: white; grid-column: span 2; }
        #hangupBtn { background: #D50000; color: white; grid-column: span 2; }
        #testBtn { background: #AA00FF; color: white; padding: 10px; font-size: 14px; }
        
        button:disabled {
            background: #bdbdbd !important;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }
        
        .status-box {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: center;
            font-weight: bold;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 5px;
        }
        
        .status-box.ready { background: #E8F5E9; color: #2E7D32; }
        .status-box.calling { background: #FFF3E0; color: #EF6C00; }
        .status-box.connected { background: #E3F2FD; color: #1565C0; }
        .status-box.error { background: #FFEBEE; color: #C62828; }
        
        .network-info {
            font-size: 12px;
            color: #666;
            font-weight: normal;
        }
        
        .mic-area {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .mic-visual {
            flex: 1;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }
        
        .mic-level {
            height: 100%;
            background: #4CAF50;
            width: 0%;
            transition: width 0.1s;
        }
        
        .mic-bars {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            padding: 0 5px;
        }
        
        .mic-bar {
            width: 4px;
            background: rgba(255,255,255,0.5);
            border-radius: 2px;
            transition: height 0.1s;
        }
        
        .log-box {
            background: #1a1a1a;
            color: #0f0;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            line-height: 1.4;
        }
        
        .log-time {
            color: #aaa;
            margin-right: 10px;
        }
        
        .log-success { color: #4CAF50; }
        .log-error { color: #f44336; }
        .log-warning { color: #FF9800; }
        .log-info { color: #2196F3; }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            max-width: 400px;
            width: 100%;
            animation: modalIn 0.3s;
        }
        
        @keyframes modalIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        .modal-icon {
            font-size: 60px;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 24px;
            margin-bottom: 10px;
            color: #333;
        }
        
        .modal-buttons {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }
        
        .modal-buttons button {
            flex: 1;
            padding: 15px;
        }
        
        .accept-btn { background: #00C853; }
        .reject-btn { background: #D50000; }
        
        .ice-status {
            font-size: 11px;
            color: #666;
            margin-top: 5px;
        }
        
        @media (max-width: 500px) {
            .container { padding: 20px; }
            .btn-group { grid-template-columns: 1fr; }
            #callBtn, #hangupBtn { grid-column: span 1; }
            button { padding: 12px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìû –ú–µ–∂—Å–µ—Ç–µ–≤–∞—è –ó–≤–æ–Ω–∏–ª–∫–∞</h1>
        
        <input type="text" id="roomId" placeholder="ID –∫–æ–º–Ω–∞—Ç—ã" value="5678">
        
        <div class="btn-group">
            <button id="createBtn" onclick="createRoom()">‚ûï –°–æ–∑–¥–∞—Ç—å</button>
            <button id="joinBtn" onclick="joinRoom()">üö™ –í–æ–π—Ç–∏</button>
        </div>
        
        <div class="status-box" id="statusBox">
            <div id="statusText">–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ</div>
            <div id="networkStatus" class="network-info">–õ–æ–∫–∞–ª—å–Ω–∞—è —Å–µ—Ç—å</div>
            <div id="iceStatus" class="ice-status"></div>
        </div>
        
        <div class="btn-group">
            <button id="callBtn" onclick="startCall()" disabled>üìû –ü–æ–∑–≤–æ–Ω–∏—Ç—å</button>
            <button id="hangupBtn" onclick="hangUp()" disabled>‚ùå –ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
        </div>
        
        <div class="mic-area">
            <button id="testBtn" onclick="testMicrophone()">üé§ –¢–µ—Å—Ç</button>
            <div class="mic-visual">
                <div class="mic-level" id="micLevel"></div>
                <div class="mic-bars" id="micBars"></div>
            </div>
        </div>
        
        <div class="log-box" id="logBox"></div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ -->
    <div class="modal" id="incomingModal">
        <div class="modal-content">
            <div class="modal-icon">üìû</div>
            <div class="modal-title">–í—Ö–æ–¥—è—â–∏–π –≤—ã–∑–æ–≤!</div>
            <p>–ö–æ–º–Ω–∞—Ç–∞: <strong id="callRoomId"></strong></p>
            <p style="color: #666; font-size: 14px; margin-top: 10px;">–°–µ—Ç—å: <span id="callerNetwork"></span></p>
            <div class="modal-buttons">
                <button class="accept-btn" onclick="acceptCall()">‚úÖ –ü—Ä–∏–Ω—è—Ç—å</button>
                <button class="reject-btn" onclick="rejectCall()">‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="waitingModal">
        <div class="modal-content">
            <div class="modal-icon">‚è≥</div>
            <div class="modal-title">–û–∂–∏–¥–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞...</div>
            <p>–ö–æ–º–Ω–∞—Ç–∞: <strong id="waitRoomId"></strong></p>
            <p id="connectionType" style="color: #666; font-size: 14px; margin-top: 10px;">–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ...</p>
            <button class="reject-btn" onclick="cancelCall()" style="margin-top: 20px;">‚ùå –û—Ç–º–µ–Ω–∏—Ç—å</button>
        </div>
    </div>
    
    <div class="modal" id="activeModal">
        <div class="modal-content">
            <div class="modal-icon">üéß</div>
            <div class="modal-title">–†–∞–∑–≥–æ–≤–æ—Ä –∞–∫—Ç–∏–≤–µ–Ω</div>
            <p>–ö–æ–º–Ω–∞—Ç–∞: <strong id="activeRoomId"></strong></p>
            <div style="margin: 25px 0;">
                <div style="margin-bottom: 10px; color: #666;">–í–∞—à–∞ –≥—Ä–æ–º–∫–æ—Å—Ç—å:</div>
                <div class="mic-visual" style="height: 15px;">
                    <div class="mic-level" id="callVolume"></div>
                </div>
            </div>
            <div id="callStats" style="font-size: 12px; color: #666; margin: 10px 0;">
                <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±—É–¥–µ—Ç –∑–¥–µ—Å—å -->
            </div>
            <button class="reject-btn" onclick="hangUp()" style="padding: 15px 30px; font-size: 16px;">
                üìû –ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–≤–æ–Ω–æ–∫
            </button>
        </div>
    </div>

    <script>
        // ========== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ==========
        const firebaseConfig = {
            apiKey: "AIzaSyDdlYdrHiGWd73F_pmwMKHrX92gK-G7kB8",
            databaseURL: "https://simple-audio-call-default-rtdb.europe-west1.firebasedatabase.app"
        };

        // –ë–ï–°–ü–õ–ê–¢–ù–´–ï TURN —Å–µ—Ä–≤–µ—Ä—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã –º–µ–∂–¥—É —Å–µ—Ç—è–º–∏
        const TURN_SERVERS = [
            // Free STUN servers
            { urls: 'stun:stun.l.google.com:19302' },
            { urls: 'stun:stun1.l.google.com:19302' },
            { urls: 'stun:stun2.l.google.com:19302' },
            { urls: 'stun:stun3.l.google.com:19302' },
            { urls: 'stun:stun4.l.google.com:19302' },
            { urls: 'stun:stun.ekiga.net' },
            { urls: 'stun:stun.ideasip.com' },
            { urls: 'stun:stun.schlund.de' },
            
            // Free TURN servers (–º–æ–≥—É—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å, –Ω–æ –ø–æ–ø—Ä–æ–±—É–µ–º)
            {
                urls: 'turn:numb.viagenie.ca',
                username: 'webrtc@live.com',
                credential: 'muazkh'
            },
            {
                urls: 'turn:openrelay.metered.ca:80',
                username: 'openrelayproject',
                credential: 'openrelayproject'
            },
            {
                urls: 'turn:openrelay.metered.ca:443',
                username: 'openrelayproject',
                credential: 'openrelayproject'
            },
            {
                urls: 'turn:openrelay.metered.ca:443?transport=tcp',
                username: 'openrelayproject',
                credential: 'openrelayproject'
            }
        ];

        // ========== –ü–ï–†–ï–ú–ï–ù–ù–´–ï ==========
        let localStream = null;
        let peerConnection = null;
        let database = null;
        let roomRef = null;
        let currentRoomId = null;
        let isCaller = false;
        let callStatus = 'idle';
        let audioContext = null;
        let analyser = null;
        let iceConnectionState = 'new';
        let networkType = 'unknown';
        let connectionType = 'unknown';

        // ========== –õ–û–ì–ò–†–û–í–ê–ù–ò–ï ==========
        function log(message, type = 'info') {
            const logBox = document.getElementById('logBox');
            const time = new Date().toLocaleTimeString();
            const colors = {
                'success': 'log-success',
                'error': 'log-error',
                'warning': 'log-warning',
                'info': 'log-info'
            };
            
            const entry = document.createElement('div');
            entry.innerHTML = `<span class="log-time">${time}</span> <span class="${colors[type] || ''}">${message}</span>`;
            logBox.appendChild(entry);
            logBox.scrollTop = logBox.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function updateStatus(text, statusClass = '', networkInfo = '') {
            document.getElementById('statusText').textContent = text;
            document.getElementById('statusBox').className = 'status-box ' + statusClass;
            
            if (networkInfo) {
                document.getElementById('networkStatus').textContent = networkInfo;
            }
        }

        function updateIceStatus(state) {
            iceConnectionState = state;
            document.getElementById('iceStatus').textContent = `ICE: ${state}`;
            log(`ICE —Å–æ—Å—Ç–æ—è–Ω–∏–µ: ${state}`, 'info');
        }

        // ========== –û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –¢–ò–ü–ê –°–ï–¢–ò ==========
        async function detectNetwork() {
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–µ—Ç–µ–≤–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                if (navigator.connection) {
                    const conn = navigator.connection;
                    networkType = conn.type || 'unknown';
                    connectionType = conn.effectiveType || 'unknown';
                    
                    log(`–°–µ—Ç—å: ${networkType}, –¢–∏–ø: ${connectionType}`, 'info');
                    document.getElementById('networkStatus').textContent = 
                        `${networkType === 'wifi' ? 'WiFi' : networkType} (${connectionType})`;
                    
                    // –ï—Å–ª–∏ –º–æ–±–∏–ª—å–Ω–∞—è —Å–µ—Ç—å –∏–ª–∏ –º–µ–¥–ª–µ–Ω–Ω–∞—è - –∏—Å–ø–æ–ª—å–∑—É–µ–º TURN
                    if (connectionType === 'slow-2g' || connectionType === '2g') {
                        log('–ú–µ–¥–ª–µ–Ω–Ω–∞—è —Å–µ—Ç—å, –æ–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ', 'warning');
                    }
                }
            } catch (e) {
                log('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å–µ—Ç—å', 'warning');
            }
        }

        // ========== –¢–ï–°–¢ –ú–ò–ö–†–û–§–û–ù–ê ==========
        async function testMicrophone() {
            try {
                log('–ó–∞–ø—É—Å–∫–∞—é —Ç–µ—Å—Ç –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞...');
                
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –ø–æ—Ç–æ–∫
                if (localStream) {
                    localStream.getTracks().forEach(track => track.stop());
                }
                
                // –ü–æ–ª—É—á–∞–µ–º –º–∏–∫—Ä–æ—Ñ–æ–Ω —Å –±–∞–∑–æ–≤—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        channelCount: 1,
                        sampleRate: 48000,
                        echoCancellation: { ideal: true },
                        noiseSuppression: { ideal: true },
                        autoGainControl: { ideal: true }
                    }
                });
                
                log('‚úÖ –ú–∏–∫—Ä–æ—Ñ–æ–Ω –¥–æ—Å—Ç—É–ø–µ–Ω');
                
                // –°–æ–∑–¥–∞–µ–º –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                const source = audioContext.createMediaStreamSource(stream);
                source.connect(analyser);
                analyser.fftSize = 256;
                
                // –°–æ–∑–¥–∞–µ–º bars –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
                const micBars = document.getElementById('micBars');
                micBars.innerHTML = '';
                for (let i = 0; i < 10; i++) {
                    const bar = document.createElement('div');
                    bar.className = 'mic-bar';
                    micBars.appendChild(bar);
                }
                
                // –ê–Ω–∏–º–∞—Ü–∏—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
                const animate = () => {
                    const data = new Uint8Array(analyser.frequencyBinCount);
                    analyser.getByteFrequencyData(data);
                    
                    // –£—Ä–æ–≤–µ–Ω—å –≥—Ä–æ–º–∫–æ—Å—Ç–∏
                    let sum = 0;
                    for (let i = 0; i < data.length; i++) sum += data[i];
                    let avg = sum / data.length;
                    let percent = Math.min(100, (avg / 128) * 100);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–æ—Å—É
                    document.getElementById('micLevel').style.width = percent + '%';
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º bars
                    const bars = micBars.children;
                    for (let i = 0; i < bars.length; i++) {
                        const barHeight = Math.min(100, (data[i * 10] || 0) / 2);
                        bars[i].style.height = barHeight + '%';
                        bars[i].style.background = barHeight > 30 ? '#4CAF50' : 
                                                  barHeight > 15 ? '#FF9800' : '#f44336';
                    }
                    
                    // –¶–≤–µ—Ç –æ—Å–Ω–æ–≤–Ω–æ–π –ø–æ–ª–æ—Å—ã
                    const levelEl = document.getElementById('micLevel');
                    if (percent > 30) {
                        levelEl.style.background = '#4CAF50';
                    } else if (percent > 10) {
                        levelEl.style.background = '#FF9800';
                    } else {
                        levelEl.style.background = '#f44336';
                    }
                    
                    requestAnimationFrame(animate);
                };
                
                animate();
                
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥
                setTimeout(() => {
                    stream.getTracks().forEach(track => track.stop());
                    if (audioContext) audioContext.close();
                    micBars.innerHTML = '';
                    document.getElementById('micLevel').style.width = '0%';
                    log('–¢–µ—Å—Ç –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω', 'success');
                }, 10000);
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞: ${error.message}`, 'error');
                alert('–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞!');
            }
        }

        // ========== –ö–û–ú–ù–ê–¢–´ ==========
        function createRoom() {
            currentRoomId = document.getElementById('roomId').value.trim();
            if (!currentRoomId) {
                currentRoomId = Math.floor(1000 + Math.random() * 9000).toString();
                document.getElementById('roomId').value = currentRoomId;
            }
            connectToRoom(true);
        }

        function joinRoom() {
            currentRoomId = document.getElementById('roomId').value.trim();
            if (!currentRoomId) {
                alert('–í–≤–µ–¥–∏—Ç–µ ID –∫–æ–º–Ω–∞—Ç—ã');
                return;
            }
            connectToRoom(false);
        }

        function connectToRoom(isCreator) {
            try {
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Firebase
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                database = firebase.database();
                
                isCaller = isCreator;
                
                // –û—Ç–∫–ª—é—á–∞–µ–º —Å—Ç–∞—Ä—ã–π listener
                if (roomRef) {
                    roomRef.off();
                }
                
                // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ
                roomRef = database.ref(`rooms/${currentRoomId}`);
                
                // –û—á–∏—â–∞–µ–º –µ—Å–ª–∏ —Å–æ–∑–¥–∞–µ–º
                if (isCreator) {
                    roomRef.remove().catch(() => {});
                }
                
                // –°–ª—É—à–∞–µ–º —Å–æ–±—ã—Ç–∏—è –∫–æ–º–Ω–∞—Ç—ã
                roomRef.on('value', handleRoomUpdate);
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —Å–µ—Ç–∏
                detectNetwork();
                
                updateStatus(`–í –∫–æ–º–Ω–∞—Ç–µ: ${currentRoomId}`, 'ready', '–ì–æ—Ç–æ–≤ –∫ –∑–≤–æ–Ω–∫—É');
                document.getElementById('callBtn').disabled = false;
                log(`${isCreator ? '–°–æ–∑–¥–∞–Ω–∞' : '–í—Ö–æ–¥ –≤'} –∫–æ–º–Ω–∞—Ç—É ${currentRoomId}`, 'success');
                
            } catch (error) {
                log(`–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${error.message}`, 'error');
            }
        }

        function handleRoomUpdate(snapshot) {
            const data = snapshot.val();
            if (!data) return;
            
            // –í—Ö–æ–¥—è—â–∏–π –≤—ã–∑–æ–≤
            if (data.callRequest && !isCaller && callStatus === 'idle') {
                document.getElementById('callRoomId').textContent = currentRoomId;
                document.getElementById('callerNetwork').textContent = networkType;
                document.getElementById('incomingModal').style.display = 'flex';
                callStatus = 'ringing';
                log('üìû –í—Ö–æ–¥—è—â–∏–π –≤—ã–∑–æ–≤!', 'info');
            }
            
            // –û—Ç–≤–µ—Ç –Ω–∞ –≤—ã–∑–æ–≤
            if (data.callResponse && callStatus === 'calling') {
                if (data.callResponse.accepted) {
                    callStatus = 'in_call';
                    document.getElementById('waitingModal').style.display = 'none';
                    startWebRTC(true);
                    log('‚úÖ –í—ã–∑–æ–≤ –ø—Ä–∏–Ω—è—Ç!', 'success');
                } else {
                    callStatus = 'idle';
                    document.getElementById('waitingModal').style.display = 'none';
                    alert('–í—ã–∑–æ–≤ –æ—Ç–∫–ª–æ–Ω–µ–Ω');
                    log('–í—ã–∑–æ–≤ –æ—Ç–∫–ª–æ–Ω–µ–Ω', 'warning');
                }
            }
            
            // WebRTC —Å–∏–≥–Ω–∞–ª—ã
            if (data.offer && !isCaller && peerConnection && callStatus === 'in_call') {
                handleOffer(data.offer);
            }
            
            if (data.answer && isCaller && peerConnection && callStatus === 'in_call') {
                handleAnswer(data.answer);
            }
            
            if (data.iceCandidate && peerConnection) {
                handleIceCandidate(data.iceCandidate);
            }
            
            if (data.hangup) {
                hangUp();
                alert('–°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –∑–∞–≤–µ—Ä—à–∏–ª –∑–≤–æ–Ω–æ–∫');
            }
        }

        // ========== –ó–í–û–ù–ö–ò ==========
        function startCall() {
            if (!currentRoomId || callStatus !== 'idle') return;
            
            callStatus = 'calling';
            document.getElementById('waitRoomId').textContent = currentRoomId;
            document.getElementById('waitingModal').style.display = 'flex';
            
            roomRef.update({
                callRequest: {
                    time: Date.now(),
                    network: networkType
                }
            });
            
            log('–û—Ç–ø—Ä–∞–≤–ª—è—é –∑–∞–ø—Ä–æ—Å –Ω–∞ –≤—ã–∑–æ–≤...', 'info');
        }

        function acceptCall() {
            document.getElementById('incomingModal').style.display = 'none';
            callStatus = 'in_call';
            
            roomRef.update({
                callResponse: {
                    accepted: true,
                    time: Date.now(),
                    network: networkType
                }
            });
            
            startWebRTC(false);
            log('–í—ã–∑–æ–≤ –ø—Ä–∏–Ω—è—Ç', 'success');
        }

        function rejectCall() {
            document.getElementById('incomingModal').style.display = 'none';
            callStatus = 'idle';
            
            roomRef.update({
                callResponse: {
                    accepted: false,
                    time: Date.now()
                }
            });
            
            log('–í—ã–∑–æ–≤ –æ—Ç–∫–ª–æ–Ω–µ–Ω', 'warning');
        }

        function cancelCall() {
            document.getElementById('waitingModal').style.display = 'none';
            callStatus = 'idle';
            roomRef.update({ callRequest: null });
            log('–í—ã–∑–æ–≤ –æ—Ç–º–µ–Ω–µ–Ω', 'warning');
        }

        // ========== WEBRTC –° –ü–û–î–î–ï–†–ñ–ö–û–ô TURN ==========
        async function startWebRTC(isInitiator) {
            try {
                updateStatus('–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ...', 'calling', '–ú–µ–∂—Å–µ—Ç–µ–≤–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ');
                
                // –ü–æ–ª—É—á–∞–µ–º –º–∏–∫—Ä–æ—Ñ–æ–Ω
                localStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        channelCount: 1,
                        sampleRate: 48000,
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }
                });
                
                log('‚úÖ –ú–∏–∫—Ä–æ—Ñ–æ–Ω –≥–æ—Ç–æ–≤ –¥–ª—è –∑–≤–æ–Ω–∫–∞');
                
                // –°–æ–∑–¥–∞–µ–º PeerConnection —Å TURN —Å–µ—Ä–≤–µ—Ä–∞–º–∏
                const pcConfig = {
                    iceServers: TURN_SERVERS,
                    iceTransportPolicy: 'all', // –ü—Ä–æ–±—É–µ–º –∏ TURN –∏ STUN
                    iceCandidatePoolSize: 10,
                    rtcpMuxPolicy: 'require',
                    bundlePolicy: 'max-bundle'
                };
                
                peerConnection = new RTCPeerConnection(pcConfig);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
                
                // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
                setupPeerConnectionHandlers(isInitiator);
                
                // –°–æ–∑–¥–∞–µ–º offer –µ—Å–ª–∏ –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä
                if (isInitiator) {
                    const offer = await peerConnection.createOffer({
                        offerToReceiveAudio: true,
                        voiceActivityDetection: true
                    });
                    
                    await peerConnection.setLocalDescription(offer);
                    roomRef.update({ offer: offer });
                    log('üì§ –û—Ç–ø—Ä–∞–≤–∏–ª WebRTC –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ', 'info');
                }
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é
                startCallVolumeMeter();
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∑–≤–æ–Ω–∫–∞
                document.getElementById('activeRoomId').textContent = currentRoomId;
                document.getElementById('activeModal').style.display = 'flex';
                updateStatus('–†–∞–∑–≥–æ–≤–æ—Ä –∞–∫—Ç–∏–≤–µ–Ω', 'connected', '–ú–µ–∂—Å–µ—Ç–µ–≤–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ');
                
            } catch (error) {
                log(`‚ùå WebRTC –æ—à–∏–±–∫–∞: ${error.message}`, 'error');
                hangUp();
            }
        }

        function setupPeerConnectionHandlers(isInitiator) {
            // ICE –∫–∞–Ω–¥–∏–¥–∞—Ç—ã
            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    const candidate = event.candidate;
                    const type = candidate.type;
                    const protocol = candidate.protocol;
                    const address = candidate.address || 'hidden';
                    
                    log(`ICE –∫–∞–Ω–¥–∏–¥–∞—Ç: ${type}/${protocol} ${address}`, 'info');
                    roomRef.update({ iceCandidate: event.candidate });
                }
            };
            
            // ICE —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            peerConnection.oniceconnectionstatechange = () => {
                const state = peerConnection.iceConnectionState;
                updateIceStatus(state);
                document.getElementById('connectionType').textContent = `ICE: ${state}`;
                
                if (state === 'connected' || state === 'completed') {
                    log(`‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ —á–µ—Ä–µ–∑ ${getConnectionType()}`, 'success');
                    updateStatus('–°–æ–µ–¥–∏–Ω–µ–Ω–æ!', 'connected', `–¢–∏–ø: ${getConnectionType()}`);
                }
                
                if (state === 'failed') {
                    log('‚ùå ICE —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å', 'error');
                    // –ü—Ä–æ–±—É–µ–º –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è —Å –¥—Ä—É–≥–∏–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
                    setTimeout(() => {
                        if (callStatus === 'in_call' && peerConnection.iceConnectionState === 'failed') {
                            log('–ü—Ä–æ–±—É—é –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏...', 'warning');
                            restartWithDifferentConfig();
                        }
                    }, 2000);
                }
            };
            
            // –£–¥–∞–ª–µ–Ω–Ω—ã–π –ø–æ—Ç–æ–∫
            peerConnection.ontrack = (event) => {
                log('‚úÖ –ü–æ–ª—É—á–∏–ª —É–¥–∞–ª–µ–Ω–Ω—ã–π –∞—É–¥–∏–æ–ø–æ—Ç–æ–∫', 'success');
                
                const remoteStream = new MediaStream();
                remoteStream.addTrack(event.track);
                
                // –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –∑–≤—É–∫
                const audio = new Audio();
                audio.srcObject = remoteStream;
                audio.autoplay = true;
                audio.volume = 1.0;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
                setTimeout(() => {
                    if (audio.duration > 0 && !audio.paused) {
                        log('üîä –£–¥–∞–ª–µ–Ω–Ω—ã–π –∑–≤—É–∫ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è!', 'success');
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                        updateCallStats();
                    }
                }, 1000);
            };
            
            // –û–±—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
            peerConnection.onconnectionstatechange = () => {
                const state = peerConnection.connectionState;
                log(`–°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ${state}`, 'webrtc');
                
                if (state === 'connected') {
                    log('üéâ –°–û–ï–î–ò–ù–ï–ù–ò–ï –£–°–¢–ê–ù–û–í–õ–ï–ù–û! –ú–æ–∂–µ—Ç–µ –≥–æ–≤–æ—Ä–∏—Ç—å.', 'success');
                }
                
                if (state === 'disconnected' || state === 'failed') {
                    log('‚ö†Ô∏è –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ', 'warning');
                    setTimeout(() => {
                        if (peerConnection && peerConnection.connectionState !== 'connected') {
                            hangUp();
                        }
                    }, 3000);
                }
            };
        }

        function getConnectionType() {
            if (!peerConnection) return 'unknown';
            
            const stats = peerConnection.getStats();
            stats.then(statReport => {
                statReport.forEach(report => {
                    if (report.type === 'candidate-pair' && report.nominated) {
                        const localCandidate = statReport.get(report.localCandidateId);
                        const remoteCandidate = statReport.get(report.remoteCandidateId);
                        
                        if (localCandidate && remoteCandidate) {
                            const type = localCandidate.candidateType;
                            log(`–¢–∏–ø —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ${type}`, 'info');
                            return type;
                        }
                    }
                });
            });
            
            return iceConnectionState === 'connected' ? 'P2P' : 'TURN/Relay';
        }

        async function handleOffer(offer) {
            try {
                await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                roomRef.update({ answer: answer });
                log('üì§ –û—Ç–ø—Ä–∞–≤–∏–ª WebRTC –æ—Ç–≤–µ—Ç', 'info');
            } catch (error) {
                log(`–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ offer: ${error}`, 'error');
            }
        }

        async function handleAnswer(answer) {
            try {
                await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
                log('‚úÖ –ü–æ–ª—É—á–∏–ª –∏ –æ–±—Ä–∞–±–æ—Ç–∞–ª WebRTC –æ—Ç–≤–µ—Ç', 'success');
            } catch (error) {
                log(`–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ answer: ${error}`, 'error');
            }
        }

        async function handleIceCandidate(candidate) {
            try {
                if (peerConnection.remoteDescription) {
                    await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
                }
            } catch (error) {
                // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –æ—à–∏–±–∫–∏ ICE
            }
        }

        function restartWithDifferentConfig() {
            log('–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—é —Å —É–ø—Ä–æ—â–µ–Ω–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π...', 'warning');
            
            // –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –±–µ–∑ TURN
            const simpleConfig = {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' }
                ],
                iceTransportPolicy: 'all'
            };
            
            // –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
            if (peerConnection) {
                peerConnection.close();
            }
            
            peerConnection = new RTCPeerConnection(simpleConfig);
            // ... –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
        }

        // ========== –í–ò–ó–£–ê–õ–ò–ó–ê–¶–ò–Ø –í–û –í–†–ï–ú–Ø –ó–í–û–ù–ö–ê ==========
        function startCallVolumeMeter() {
            if (!localStream) return;
            
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                const source = audioContext.createMediaStreamSource(localStream);
                source.connect(analyser);
                analyser.fftSize = 64;
                analyser.smoothingTimeConstant = 0.8;
                
                const updateVolume = () => {
                    if (callStatus !== 'in_call') return;
                    
                    const data = new Uint8Array(analyser.frequencyBinCount);
                    analyser.getByteFrequencyData(data);
                    
                    let sum = 0;
                    for (let i = 0; i < data.length; i++) sum += data[i];
                    let avg = sum / data.length;
                    let percent = Math.min(100, (avg / 32) * 100);
                    
                    document.getElementById('callVolume').style.width = percent + '%';
                    
                    // –¶–≤–µ—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≥—Ä–æ–º–∫–æ—Å—Ç–∏
                    const volumeEl = document.getElementById('callVolume');
                    if (percent > 25) {
                        volumeEl.style.background = '#4CAF50';
                        volumeEl.style.boxShadow = '0 0 10px #4CAF50';
                    } else if (percent > 10) {
                        volumeEl.style.background = '#FF9800';
                        volumeEl.style.boxShadow = '0 0 5px #FF9800';
                    } else {
                        volumeEl.style.background = '#9E9E9E';
                        volumeEl.style.boxShadow = 'none';
                    }
                    
                    requestAnimationFrame(updateVolume);
                };
                
                updateVolume();
                
            } catch (error) {
                console.log('–ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –≥—Ä–æ–º–∫–æ—Å—Ç–∏ –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω:', error);
            }
        }

        function updateCallStats() {
            const statsDiv = document.getElementById('callStats');
            if (!statsDiv) return;
            
            const stats = `
                –°–µ—Ç—å: ${networkType}<br>
                –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ: ${getConnectionType()}<br>
                –°—Ç–∞—Ç—É—Å: ${iceConnectionState}
            `;
            
            statsDiv.innerHTML = stats;
        }

        // ========== –ó–ê–í–ï–†–®–ï–ù–ò–ï ==========
        function hangUp() {
            log('–ó–∞–≤–µ—Ä—à–∞—é –∑–≤–æ–Ω–æ–∫...', 'warning');
            
            callStatus = 'idle';
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–∏–≥–Ω–∞–ª –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏
            if (roomRef) {
                roomRef.update({ hangup: true });
                setTimeout(() => roomRef.update({ hangup: null }), 1000);
            }
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ—Ç–æ–∫–∏
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –∞—É–¥–∏–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç
            if (audioContext) {
                audioContext.close();
                audioContext = null;
            }
            
            // –°–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫–∏
            document.getElementById('incomingModal').style.display = 'none';
            document.getElementById('waitingModal').style.display = 'none';
            document.getElementById('activeModal').style.display = 'none';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º UI
            if (currentRoomId) {
                updateStatus(`–í –∫–æ–º–Ω–∞—Ç–µ: ${currentRoomId}`, 'ready', '–ì–æ—Ç–æ–≤ –∫ –∑–≤–æ–Ω–∫—É');
            } else {
                updateStatus('–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ', '');
            }
            
            document.getElementById('callBtn').disabled = !currentRoomId;
            document.getElementById('hangupBtn').disabled = true;
            
            log('–ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω', 'info');
        }

        // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
        function init() {
            log('–ú–µ–∂—Å–µ—Ç–µ–≤–∞—è –∑–≤–æ–Ω–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞', 'success');
            updateStatus('–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ', '');
            detectNetwork();
        }

        // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
        window.addEventListener('beforeunload', () => {
            if (roomRef) {
                roomRef.update({ hangup: true });
                roomRef.off();
            }
            hangUp();
        });

        window.onload = init;
    </script>
</body>
</html>
